<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n l√Ω ti·ªÅn thu ƒëi·ªÉm gas theo ca</title>
<!-- Th√™m c√°c th·∫ª icon cho web v√† m√†n h√¨nh ch√≠nh iPhone -->
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="apple-touch-icon-precomposed" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Qu·∫£n l√Ω ƒëi·ªÉm gas">
<style>
  :root {
    --primary: #2c80ff;
    --primary-dark: #1a6de0;
    --secondary: #34c759;
    --danger: #ff3b30;
    --warning: #ff9500;
    --light: #f8f9fa;
    --dark: #333;
    --gray: #6c757d;
    --border: #dee2e6;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
    --radius: 10px;
    --night-shift: #4a5568;
    --day-shift: #f7fafc;
    --sidebar-width: 280px;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
    transition: margin-left 0.3s ease;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  /* Sidebar styles */
  .sidebar {
    position: fixed;
    top: 0;
    left: -280px;
    width: var(--sidebar-width);
    height: 100%;
    background: white;
    box-shadow: 2px 0 15px rgba(0,0,0,0.1);
    z-index: 1001;
    transition: left 0.3s ease;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  
  .sidebar.open {
    left: 0;
  }
  
  .sidebar-header {
    padding: 20px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .sidebar-header h2 {
    font-size: 1.3rem;
  }
  
  .close-sidebar {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: auto;
  }
  
  .sidebar-content {
    padding: 20px;
    flex: 1;
  }
  
  .sidebar-item {
    display: flex;
    align-items: center;
    justify-content: left;
    gap: 12px;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: var(--radius);
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    width: 100%;
    text-align: left;
    font-size: 1rem;
  }

  .sidebar-item:hover {
    background: #e9ecef;
    transform: translateY(-2px);
  }
  
  .sidebar-item.active {
    background: var(--primary);
    color: white;
  }
  
  .sidebar-footer {
    padding: 20px;
    border-top: 1px solid var(--border);
    font-size: 0.85rem;
    color: var(--gray);
    text-align: center;
  }
  
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
  }
  
  .overlay.active {
    display: block;
  }
  
  .menu-toggle {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    margin-right: 10px;
  }
  
  /* Header styles */
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 25px 30px;
    text-align: center;
    position: relative;
  }
  
  header h1 {
    font-size: 1.8rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  header p {
    opacity: 0.9;
    font-size: 1rem;
  }
  
  .shift-info {
    background: var(--night-shift);
    color: white;
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .shift-info .current-shift {
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  .shift-info .shift-time {
    font-size: 0.9rem;
    opacity: 0.9;
  }
  
  .card {
    padding: 25px 30px;
    border-bottom: 1px solid var(--border);
  }
  
  .card:last-child {
    border-bottom: none;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
  }
  
  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 128, 255, 0.1);
  }
  
  .button-group {
    display: flex;
    gap: 15px;
    margin-top: 25px;
  }
  
  button {
    flex: 1;
    padding: 16px;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn-primary {
    background-color: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(44, 128, 255, 0.3);
  }
  
  .btn-secondary {
    background-color: #f1f3f5;
    color: var(--dark);
  }
  
  .btn-secondary:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }
  
  .btn-success {
    background-color: var(--secondary);
    color: white;
  }
  
  .btn-success:hover {
    background-color: #30b352;
    transform: translateY(-2px);
  }
  
  .btn-warning {
    background-color: var(--warning);
    color: white;
  }
  
  .btn-warning:hover {
    background-color: #e08900;
    transform: translateY(-2px);
  }
  
  .btn-danger {
    background-color: var(--danger);
    color: white;
  }
  
  .btn-danger:hover {
    background-color: #e0352b;
    transform: translateY(-2px);
  }
  
  .btn-sm {
    padding: 8px 12px;
    font-size: 0.85rem;
  }
  
  .table-container {
    overflow-x: auto;
    margin-top: 10px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 5px;
  }
  
  th {
    background-color: #f8f9fa;
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    border-bottom: 2px solid var(--border);
  }
  
  td {
    padding: 14px 12px;
    border-bottom: 1px solid var(--border);
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  tr:hover {
    background-color: #f8fafc;
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
  }
  
  .empty-state p {
    margin-top: 10px;
  }
  
  .stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    flex: 1;
    min-width: 150px;
    background: #f8f9fa;
    border-radius: var(--radius);
    padding: 15px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }
  
  .stat-label {
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 5px;
  }
  
  .filter-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-group select {
    flex: 1;
    min-width: 200px;
  }
  
  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .modal-content {
    background: white;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    animation: modalFadeIn 0.3s ease-out;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  .modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: between;
    align-items: center;
    flex-shrink: 0;
  }
  
  .modal-header h2 {
    font-size: 1.4rem;
  }
  
  .modal-body {
    padding: 25px;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    max-height: calc(85vh - 120px);
  }
  
  .modal-footer {
    padding: 20px 25px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-shrink: 0;
    margin-top: auto;
  }
  
  .modal-footer button {
    width: 100%;
    padding: 14px;
    font-size: 1rem;
    min-height: 44px;
  }
    
  .modal-footer .btn-danger {
    font-size: 1.2rem;
    min-height: 52px;
    padding: 16px 0;
    border-radius: 12px;
    position: relative;
    z-index: 2;
    pointer-events: auto;
  }
  
  .close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
    padding: 0;
    width: auto;
  }
  
  .close-modal:hover {
    color: var(--dark);
    transform: none;
  }
  
  /* Responsive styles */
  @media (max-width: 768px) {
    body {
      padding: 15px;
    }
    
    header {
      padding: 20px;
    }
    
    header h1 {
      font-size: 1.5rem;
    }
    
    .shift-info {
      padding: 15px 20px;
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
    }
    
    .card {
      padding: 20px;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .stats-container {
      flex-direction: column;
    }
    
    .filter-group {
      flex-direction: column;
    }
    
    .filter-group select {
      min-width: 100%;
    }
    
    th, td {
      padding: 12px 8px;
      font-size: 0.9rem;
    }
    
    table {
      min-width: 600px;
    }
    
    .modal {
      padding: 10px;
    }
    
    .modal-content {
      width: 95%;
      margin: 10px;
      max-height: 90vh;
    }
    
    .modal-header, .modal-body, .modal-footer {
      padding: 15px;
    }
    
    .modal-body {
      max-height: calc(90vh - 110px);
    }
    
    .modal-footer {
      flex-direction: column;
      gap: 12px;
      padding: 15px 10px;
    }
    
    .modal-footer button {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      min-height: 48px;
      border-radius: 10px;
    }
    
    .modal-footer .btn-danger {
      font-size: 1.3rem;
      min-height: 56px;
      padding: 18px 0;
      border-radius: 14px;
      width: 100%;
      z-index: 1;
    }
    
    .close-modal {
      font-size: 1.8rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .table-container {
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    
    table {
      min-width: 700px;
    }
    
    .action-buttons {
      flex-direction: column;
      gap: 5px;
    }
    
    .action-buttons button {
      padding: 10px;
      font-size: 0.9rem;
      min-height: 36px;
    }
    
    .badge {
      padding: 6px 10px;
      font-size: 0.85rem;
    }
  }
  
  @media (max-width: 480px) {
    body {
      padding: 10px;
    }
    
    header {
      padding: 18px 15px;
    }
    
    header h1 {
      font-size: 1.3rem;
    }
    
    .card {
      padding: 18px 15px;
    }
    
    input, select {
      padding: 12px 14px;
      font-size: 16px;
    }
    
    button {
      padding: 14px;
      min-height: 44px;
    }
    
    .btn-sm {
      min-height: 36px;
    }
    
    .modal-content {
      width: 98%;
      margin: 5px;
      max-height: 95vh;
    }
    
    .modal-header h2 {
      font-size: 1.2rem;
    }
    
    .modal-body {
      padding: 15px 10px;
      max-height: calc(95vh - 100px);
    }
    
    .modal-footer {
      flex-direction: column;
      gap: 12px;
      padding: 16px 6px;
    }
    
    .modal-footer button {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      min-height: 48px;
      border-radius: 10px;
    }
    
    .modal-footer .btn-danger {
      font-size: 1.3rem;
      min-height: 56px;
      padding: 18px 0;
      border-radius: 14px;
      width: 100%;
      z-index: 1;
    }
    
    .modal-body p {
      font-size: 1rem;
      line-height: 1.5;
    }
  }
  
  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  .fade-in {
    animation: fadeIn 0.4s ease-out;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
  }
  
  .badge-primary {
    background-color: var(--primary);
    color: white;
  }
  
  .badge-secondary {
    background-color: var(--secondary);
    color: white;
  }
  
  .badge-warning {
    background-color: var(--warning);
    color: white;
  }
  
  .badge-danger {
    background-color: var(--danger);
    color: white;
  }
  
  .action-buttons {
    display: flex;
    gap: 5px;
  }
  
  .form-row {
    display: flex;
    gap: 15px;
  }
  
  .form-row .form-group {
    flex: 1;
  }
  
  .status-toggle {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .status-toggle:hover {
    transform: scale(1.05);
  }
  
  .status-toggle-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) translateY(100px);
    background: var(--primary);
    color: white;
    padding: 16px 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    z-index: 1002;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transition: all 0.3s ease;
    min-width: 280px;
    text-align: center;
    justify-content: center;
  }

  .toast.show {
    transform: translate(-50%, -50%) translateY(0);
    opacity: 1;
  }
  
  .toast.success {
    background: var(--secondary);
  }
  
  .toast.error {
    background: var(--danger);
  }

  .diachi-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .diachi-row input {
    flex: 8 1 0%;
    min-width: 0;
  }
  .diachi-row button {
    flex: 2 1 0%;
    min-width: 0;
    max-width: 100px;
    white-space: nowrap;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }
  
  /* Th√™m style m·ªõi cho modal xem nhanh */
  .quick-view-list {
    max-height: none;
    overflow-y: visible;
    margin-top: 15px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  
  .quick-view-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
    transition: background-color 0.2s ease;
  }
  
  .quick-view-item:last-child {
    border-bottom: none;
  }
  
  .quick-view-item:hover {
    background-color: #f8f9fa;
  }
  
  .quick-view-item-info {
    display: flex;
    flex-direction: column;
  }
  
  .quick-view-item-name {
    font-weight: 600;
    color: var(--dark);
  }
  
  .quick-view-item-address {
    font-size: 0.85rem;
    color: var(--gray);
    margin-top: 3px;
  }
  
  .quick-view-item-amount {
    font-weight: 700;
    color: var(--primary);
    font-size: 1.1rem;
  }
  
  .quick-view-total {
    padding: 15px;
    background-color: #f8f9fa;
    border-top: 1px solid var(--border);
    font-weight: 700;
    text-align: center;
    color: var(--dark);
  }
  
  /* Style cho √¥ s·ªë ti·ªÅn khi ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn */
  #so_tien {
    transition: all 0.3s ease;
  }
  
  #so_tien:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.1);
    background-color: #f8fff9;
  }
  
  /* Style cho n√∫t l∆∞u v·ªã tr√≠ khi ƒë√£ c√≥ GPS */
  .btn-location-disabled {
    background-color: #6c757d !important;
    cursor: not-allowed !important;
  }
  
  .btn-location-disabled:hover {
    transform: none !important;
    background-color: #6c757d !important;
  }
  
  /* Style cho modal b√°o c√°o */
  #report-summary {
    border-left: 4px solid var(--primary);
    margin-top: 20px;
  }
  
  #report-details {
    line-height: 1.6;
  }
  
  .recipient-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .recipient-row input {
    flex: 1;
  }
  
  .recipient-row button {
    min-width: 80px;
  }
  
  /* Style cho ph·∫ßn chi ti√™u */
  .expense-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .expense-input-group input {
    flex: 1;
  }
  
  .expense-input-group button {
    min-width: 80px;
  }
  
  .expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    margin-bottom: 8px;
    background-color: #f8f9fa;
    border-radius: var(--radius);
  }
  
  .expense-item:last-child {
    margin-bottom: 0;
  }
  
  .expense-item-info {
    display: flex;
    flex-direction: column;
  }
  
  .expense-item-name {
    font-weight: 600;
    color: var(--dark);
  }
  
  .expense-item-amount {
    font-weight: 700;
    color: var(--danger);
  }
  
  .expense-item-delete {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 5px;
  }
  
  .expense-total {
    margin-top: 15px;
    padding: 12px 15px;
    background-color: #f1f3f5;
    border-radius: var(--radius);
    font-weight: 700;
    text-align: center;
    color: var(--danger);
  }
  
  @media (max-width: 768px) {
    .diachi-row input {
      flex: 8 1 0%;
    }
    .diachi-row button {
      flex: 2 1 0%;
      max-width: 90px;
      font-size: 0.95rem;
      padding-left: 0.3em;
      padding-right: 0.3em;
    }
    
    .quick-view-item {
      padding: 10px 12px;
    }
    
    .recipient-row {
      flex-direction: column;
    }
    
    .recipient-row button {
      width: 100%;
    }
    
    .expense-input-group {
      flex-direction: column;
    }
    
    .expense-input-group button {
      width: 100%;
    }
  }
  
  @media (max-width: 480px) {
    .diachi-row input {
      flex: 8 1 0%;
    }
    .diachi-row button {
      flex: 2 1 0%;
      max-width: 70px;
      font-size: 0.9rem;
      padding-left: 0.2em;
      padding-right: 0.2em;
    }
    
    .quick-view-item {
      padding: 10px 12px;
    }
    
    .quick-view-item-name {
      font-size: 0.95rem;
    }
    
    .quick-view-item-amount {
      font-size: 1rem;
    }
  }
</style>
</head>
<body>
  <!-- Overlay cho sidebar -->
  <div class="overlay" id="sidebar-overlay"></div>
  
  <!-- Toast notification -->
  <div class="toast" id="toast">
    <span id="toast-message">ƒê√£ sao ch√©p v√†o clipboard!</span>
  </div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>MenuBar</h2>
      <button class="close-sidebar" id="close-sidebar">&times;</button>
    </div>
    <div class="sidebar-content">
      <button class="sidebar-item" onclick="exportToText()">
        üìÑ Xu·∫•t d·ªØ li·ªáu vƒÉn b·∫£n
      </button>
      <button class="sidebar-item" onclick="openQuickViewModal()">
        üëÅÔ∏è Xem nhanh ƒëi·ªÉm (ca)
      </button>
      <button class="sidebar-item" onclick="openOutOfHoursModal()">
        ‚è∞ Th√™m ƒëi·ªÉm ngo√†i ca
      </button>
      <button class="sidebar-item" onclick="openBatchStatusModal()">
        üîÑ Chuy·ªÉn tr·∫°ng th√°i
      </button>
      <!-- TH√äM N√öT M·ªöI: B√ÅO C√ÅO CU·ªêI CA -->
      <button class="sidebar-item" onclick="openReportModal()">
        üìä B√°o c√°o cu·ªëi ca
      </button>
      <button class="sidebar-item" onclick="closeSidebar(); window.location.href='vitri.html'">
        üìç Qu·∫£n l√Ω v·ªã tr√≠
      </button>
      <button class="sidebar-item" onclick="closeSidebar(); window.location.href='tinhluong.html'">
        üí∞ T√≠nh c√¥ng & l∆∞∆°ng
      </button>
      <button class="sidebar-item" onclick="openModal('help-modal')">
        ‚ùì Tr·ª£ gi√∫p
      </button>
      <button class="sidebar-item" onclick="resetForm()">
        ‚ùå ƒê√≥ng
      </button>
    </div>
    <div class="sidebar-footer">
      <p>Qu·∫£n l√Ω ƒëi·ªÉm gas &copy; 2025</p>
    </div>
  </div>

  <div class="container">
    <header>
      <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
      <h1>üìã Qu·∫£n l√Ω ti·ªÅn ƒëi·ªÉm gas</h1>
      <p>Theo d√µi v√† qu·∫£n l√Ω thu chi t·∫°i c√°c ƒëi·ªÉm gas theo ca l√†m vi·ªác</p>
    </header>
    
    <div class="shift-info">
      <div class="current-shift" id="current-shift">ƒêang t·∫£i th√¥ng tin ca...</div>
      <div class="shift-time" id="shift-time"></div>
    </div>
    
    <div class="card">
      <div class="stats-container" id="stats-container">
        <!-- Th·ªëng k√™ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
      
      <div class="filter-group">
        <select id="filter-shift" onchange="filterByShift()">
          <option value="all">T·∫•t c·∫£ c√°c ca</option>
          <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </select>
        <select id="filter-diem" onchange="filterByDiem()">
          <option value="all">T·∫•t c·∫£ ƒëi·ªÉm gas</option>
          <!-- C√°c t√πy ch·ªçn ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </select>
        <select id="filter-trangthai" onchange="filterByTrangThai()">
          <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
          <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
        </select>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="chon_diem">Ch·ªçn ƒëi·ªÉm:</label>
          <input id="chon_diem" list="diem-list" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn ƒëi·ªÉm..." oninput="chonDiem()">
          <datalist id="diem-list"></datalist>
        </div>
        
        <div class="form-group">
          <label for="trang_thai">Tr·∫°ng th√°i:</label>
          <select id="trang_thai">
            <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
            <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="ten_diem">T√™n ƒëi·ªÉm:</label>
        <input id="ten_diem" placeholder="Nh·∫≠p t√™n ƒëi·ªÉm (n·∫øu th√™m m·ªõi)">
      </div>
      
      <div class="form-group">
        <label for="so_tien">S·ªë ti·ªÅn:</label>
        <input id="so_tien" type="number" placeholder="Nh·∫≠p s·ªë ti·ªÅn">
      </div>
      
      <div class="form-group">
        <label for="dia_chi">ƒê·ªãa ch·ªâ:</label>
        <div class="diachi-row">
          <input id="dia_chi" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
          <button class="btn-success btn-sm" type="button" id="btn-save-location" title="L∆∞u v·ªã tr√≠ GPS">L∆∞u</button>
        </div>
      </div>
      
      <div class="form-group">
        <label for="ghi_chu">Ghi ch√∫:</label>
        <input id="ghi_chu" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)">
      </div>
      
      <div class="button-group">
        <button class="btn-primary" onclick="guiDuLieu()" id="btn-submit">
          üíæ L∆∞u th√¥ng tin
        </button>
        <button class="btn-secondary" onclick="taiDuLieu()">
          üîÑ T·∫£i l·∫°i
        </button>
        <button class="btn-warning" onclick="resetForm()" id="btn-cancel" style="display: none;">
          ‚ùå H·ªßy
        </button>
      </div>
    </div>
    
    <div class="card">
      <h2 style="margin-bottom: 15px;">üìä Danh s√°ch ƒëi·ªÉm gas theo ca</h2>
      <div class="table-container">
        <table id="bang">
          <thead>
            <tr>
              <th>T√™n ƒëi·ªÉm</th>
              <th>S·ªë ti·ªÅn</th>
              <th>ƒê·ªãa ch·ªâ</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ca</th>
              <th>Th·ªùi gian</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </tbody>
        </table>
        <div id="empty-state" class="empty-state" style="display: none;">
          <h3>üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
          <p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>
        </div>
      </div>
    </div>
  </div>

  <!-- N√∫t cu·ªôn v·ªÅ ƒë·∫ßu trang -->
  <button id="scrollTopBtn" style="position:fixed;right:30px;bottom:30px;z-index:999;background:#2c80ff;color:white;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:2rem;display:none;align-items:center;justify-content:center;cursor:pointer;transition:opacity 0.3s;">
    ‚Üë
  </button>

  <!-- Modal x√°c nh·∫≠n x√≥a -->
  <div class="modal" id="delete-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>X√°c nh·∫≠n x√≥a</h2>
        <button class="close-modal" onclick="closeModal('delete-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒëi·ªÉm gas n√†y?</p>
        <p id="delete-item-info" style="font-weight: bold; margin-top: 10px;"></p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('delete-modal')">H·ªßy</button>
        <button class="btn-danger" onclick="confirmDelete()">X√≥a</button>
      </div>
    </div>
  </div>

  <!-- Modal tr·ª£ gi√∫p -->
  <div class="modal" id="help-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Tr·ª£ gi√∫p</h2>
        <button class="close-modal" onclick="closeModal('help-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <h3>C√°ch s·ª≠ d·ª•ng:</h3>
        <ul style="margin-left: 20px; margin-top: 10px;">
          <li>Ch·ªçn ƒëi·ªÉm gas t·ª´ danh s√°ch ho·∫∑c th√™m m·ªõi</li>
          <li>Nh·∫≠p s·ªë ti·ªÅn thu ƒë∆∞·ª£c (c√≥ th·ªÉ nh·∫≠p s·ªë v√† th√™m '000' t·ª± ƒë·ªông)</li>
          <li>Ch·ªçn tr·∫°ng th√°i ƒë√£ n·ªôp ho·∫∑c ch∆∞a n·ªôp</li>
          <li>Nh·∫•n "L∆∞u th√¥ng tin" ƒë·ªÉ l∆∞u d·ªØ li·ªáu</li>
          <li>Xu·∫•t d·ªØ li·ªáu vƒÉn b·∫£n t·ª´ menu ƒë·ªÉ chia s·∫ª ho·∫∑c in ·∫•n</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" onclick="closeModal('help-modal')">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- Modal xem nhanh ƒëi·ªÉm trong ca -->
  <div class="modal" id="quick-view-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üëÅÔ∏è Xem nhanh KQ</h2>
        <button class="close-modal" onclick="closeModal('quick-view-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="quick-view-shift">Ch·ªçn ca:</label>
          <select id="quick-view-shift" onchange="updateQuickViewList()">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div id="quick-view-empty" class="empty-state" style="display: none;">
          <p>üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu cho ca n√†y</p>
        </div>
        
        <div class="quick-view-list" id="quick-view-list" style="display: none;">
          <!-- Danh s√°ch ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
        
        <div class="quick-view-total" id="quick-view-total" style="display: none;">
          <!-- T·ªïng ti·ªÅn s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" onclick="closeModal('quick-view-modal')">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- Modal th√™m ƒëi·ªÉm ngo√†i ca -->
  <div class="modal" id="out-of-hours-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚è∞ Th√™m ƒëi·ªÉm ngo√†i ca</h2>
        <button class="close-modal" onclick="closeModal('out-of-hours-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Hi·ªán t·∫°i b·∫°n ƒëang ngo√†i gi·ªù l√†m vi·ªác (6:30 - 18:30). Vui l√≤ng ch·ªçn ca ƒë·ªÉ th√™m ƒëi·ªÉm:</p>
        
        <div class="form-group">
          <label for="out-of-hours-shift">Ch·ªçn ca:</label>
          <select id="out-of-hours-shift">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="custom-shift-date">Ho·∫∑c ch·ªçn ng√†y kh√°c:</label>
          <input type="date" id="custom-shift-date">
        </div>
        
        <div class="form-group">
          <button class="btn-primary" onclick="useCustomShift()" style="width: 100%;">
            S·ª≠ d·ª•ng ng√†y ƒë√£ ch·ªçn
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('out-of-hours-modal')">H·ªßy</button>
        <button class="btn-primary" onclick="confirmOutOfHoursShift()">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Modal chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t -->
  <div class="modal" id="batch-status-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîÑ Chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t</h2>
        <button class="close-modal" onclick="closeModal('batch-status-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Ch·ªçn ca v√† tr·∫°ng th√°i m·ªõi ƒë·ªÉ chuy·ªÉn ƒë·ªïi ƒë·ªìng lo·∫°t t·∫•t c·∫£ ƒëi·ªÉm gas trong ca ƒë√≥:</p>
        
        <div class="form-group">
          <label for="batch-status-shift">Ch·ªçn ca:</label>
          <select id="batch-status-shift">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="batch-status-new-status">Tr·∫°ng th√°i m·ªõi:</label>
          <select id="batch-status-new-status">
            <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
            <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
          </select>
        </div>
        
        <div id="batch-status-info" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: var(--radius); display: none;">
          <p id="batch-status-summary"></p>
          <p id="batch-status-details" style="font-size: 0.9rem; margin-top: 8px; color: var(--gray);"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('batch-status-modal')">H·ªßy</button>
        <button class="btn-primary" id="batch-status-confirm" onclick="confirmBatchStatusUpdate()" disabled>X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- TH√äM MODAL M·ªöI: B√ÅO C√ÅO CU·ªêI CA -->
  <div class="modal" id="report-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìä B√°o c√°o cu·ªëi ca</h2>
        <button class="close-modal" onclick="closeModal('report-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="report-shift">Ch·ªçn ca c·∫ßn b√°o c√°o:</label>
          <select id="report-shift">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="report-recipient">Ng∆∞·ªùi nh·∫≠n b√°o c√°o:</label>
          <div class="recipient-row">
            <input id="report-recipient" list="recipient-list" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n">
            <button class="btn-success btn-sm" onclick="saveRecipient()">L∆∞u</button>
          </div>
          <datalist id="recipient-list">
            <!-- Danh s√°ch ng∆∞·ªùi nh·∫≠n s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </datalist>
        </div>
        
        <!-- TH√äM PH·∫¶N NH·∫¨P CHI TI√äU -->
        <div class="form-group">
          <label for="expense-name">Chi ti√™u trong ca:</label>
          <div class="expense-input-group">
            <input id="expense-name" list="expense-templates-list" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p t√™n chi ti√™u">
            <input id="expense-amount" type="number" placeholder="S·ªë ti·ªÅn">
            <button class="btn-warning btn-sm" onclick="addExpense()">Th√™m</button>
          </div>
          <datalist id="expense-templates-list">
            <!-- Danh s√°ch chi ti√™u m·∫´u s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </datalist>
        </div>
        
        <div id="expenses-list">
          <!-- Danh s√°ch chi ti√™u s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
        
        <div id="report-summary" style="display: none;">
          <h4>üìà T·ªïng k·∫øt ca:</h4>
          <p id="report-details" style="margin: 10px 0;"></p>
          <p style="font-weight: bold; color: var(--primary);" id="report-total"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('report-modal')">H·ªßy</button>
        <button class="btn-primary" id="btn-generate-report" onclick="generateReport()" disabled>T·∫°o b√°o c√°o</button>
      </div>
    </div>
  </div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbyRnnoEd2BnD7u1pXHER17Cv95BN9Z77yUeO6oR7CFRtbUqd-SiVJqBv5ENYyARwX77fw/exec';
let cacheDiem = {};
let allData = [];
let currentShift = '';
let editingId = null;
let itemToDelete = null;
let currentFilteredData = [];
let selectedOutOfHoursShift = null;

// Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u danh s√°ch ng∆∞·ªùi nh·∫≠n
let recipientList = [];

// Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u danh s√°ch chi ti√™u m·∫´u (t∆∞∆°ng t·ª± ng∆∞·ªùi nh·∫≠n)
let expenseTemplateList = [];

// Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u danh s√°ch chi ti√™u c·ªßa ca hi·ªán t·∫°i
let currentExpenses = [];

// H√ÄM M·ªöI: M·ªü modal b√°o c√°o cu·ªëi ca
function openReportModal() {
  closeSidebar();
  
  // Load danh s√°ch ng∆∞·ªùi nh·∫≠n t·ª´ localStorage
  loadRecipients();
  
  // Load danh s√°ch chi ti√™u m·∫´u t·ª´ localStorage
  loadExpenseTemplates();
  
  // Reset danh s√°ch chi ti√™u c·ªßa ca hi·ªán t·∫°i
  currentExpenses = [];
  updateExpensesList();
  
  // ƒêi·ªÅn danh s√°ch ca
  const shifts = new Set();
  allData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  const shiftSelect = document.getElementById('report-shift');
  shiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    }
    
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftSelect.appendChild(option);
  });
  
  // Reset th√¥ng tin
  document.getElementById('report-summary').style.display = 'none';
  document.getElementById('btn-generate-report').disabled = true;
  
  openModal('report-modal');
}

// H√ÄM M·ªöI: T·∫£i danh s√°ch ng∆∞·ªùi nh·∫≠n t·ª´ localStorage
function loadRecipients() {
  const savedRecipients = localStorage.getItem('gas_point_recipients');
  if (savedRecipients) {
    recipientList = JSON.parse(savedRecipients);
  } else {
    // Danh s√°ch m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
    recipientList = ['anh √∫t', 'ph∆∞·ªõc'];
  }
  
  // C·∫≠p nh·∫≠t datalist
  const recipientDatalist = document.getElementById('recipient-list');
  recipientDatalist.innerHTML = '';
  recipientList.forEach(recipient => {
    const option = document.createElement('option');
    option.value = recipient;
    recipientDatalist.appendChild(option);
  });
}

// H√ÄM M·ªöI: T·∫£i danh s√°ch chi ti√™u m·∫´u t·ª´ localStorage
function loadExpenseTemplates() {
  const savedExpenses = localStorage.getItem('gas_point_expense_templates');
  if (savedExpenses) {
    expenseTemplateList = JSON.parse(savedExpenses);
  } else {
    // Danh s√°ch m·∫´u m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
    expenseTemplateList = [
      { name: 'xƒÉng', amount: 0 }   
    ];
    localStorage.setItem('gas_point_expense_templates', JSON.stringify(expenseTemplateList));
  }
  
  // C·∫≠p nh·∫≠t datalist cho chi ti√™u
  updateExpenseTemplatesDatalist();
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t datalist cho chi ti√™u m·∫´u
function updateExpenseTemplatesDatalist() {
  const expenseDatalist = document.getElementById('expense-templates-list');
  expenseDatalist.innerHTML = '';
  
  expenseTemplateList.forEach(expense => {
    const option = document.createElement('option');
    option.value = expense.name;
    expenseDatalist.appendChild(option);
  });
}

// H√ÄM M·ªöI: L∆∞u ng∆∞·ªùi nh·∫≠n m·ªõi
function saveRecipient() {
  const recipientInput = document.getElementById('report-recipient');
  const recipient = recipientInput.value.trim();
  
  if (!recipient) {
    showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!', 'error');
    return;
  }
  
  // Ki·ªÉm tra n·∫øu ch∆∞a c√≥ trong danh s√°ch th√¨ th√™m v√†o
  if (!recipientList.includes(recipient)) {
    recipientList.push(recipient);
    localStorage.setItem('gas_point_recipients', JSON.stringify(recipientList));
    
    // C·∫≠p nh·∫≠t l·∫°i datalist
    loadRecipients();
    
    showToast('‚úÖ ƒê√£ l∆∞u ng∆∞·ªùi nh·∫≠n m·ªõi!');
  } else {
    showToast('‚ÑπÔ∏è Ng∆∞·ªùi nh·∫≠n ƒë√£ c√≥ trong danh s√°ch!');
  }
  
  // C·∫≠p nh·∫≠t th√¥ng tin b√°o c√°o
  updateReportSummary();
}

// H√ÄM M·ªöI: Th√™m chi ti√™u v√†o danh s√°ch - ƒê√É C·∫¨P NH·∫¨T LOGIC
function addExpense() {
  const expenseName = document.getElementById('expense-name').value.trim();
  const expenseAmount = document.getElementById('expense-amount').value.trim();
  
  if (!expenseName || !expenseAmount) {
    showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√¥ t·∫£ v√† s·ªë ti·ªÅn chi ti√™u!', 'error');
    return;
  }
  
  const amount = parseInt(expenseAmount);
  if (isNaN(amount) || amount <= 0) {
    showToast('‚ö†Ô∏è S·ªë ti·ªÅn chi ti√™u kh√¥ng h·ª£p l·ªá!', 'error');
    return;
  }
  
  // Th√™m chi ti√™u v√†o danh s√°ch hi·ªán t·∫°i
  currentExpenses.push({
    name: expenseName,
    amount: amount
  });
  
  // Ki·ªÉm tra n·∫øu t√™n chi ti√™u ch∆∞a c√≥ trong danh s√°ch m·∫´u th√¨ h·ªèi ng∆∞·ªùi d√πng
  const existingTemplate = expenseTemplateList.find(template => template.name.toLowerCase() === expenseName.toLowerCase());
  if (!existingTemplate) {
    // H·ªèi ng∆∞·ªùi d√πng c√≥ mu·ªën l∆∞u l√†m m·∫´u kh√¥ng
    if (confirm(`B·∫°n c√≥ mu·ªën l∆∞u "${expenseName}" v√†o danh s√°ch chi ti√™u m·∫´u kh√¥ng?`)) {
      expenseTemplateList.push({
        name: expenseName,
        amount: amount // L∆∞u c·∫£ s·ªë ti·ªÅn m·∫´u
      });
      localStorage.setItem('gas_point_expense_templates', JSON.stringify(expenseTemplateList));
      updateExpenseTemplatesDatalist();
      showToast('‚úÖ ƒê√£ l∆∞u v√†o danh s√°ch chi ti√™u m·∫´u!');
    }
  }
  
  // C·∫≠p nh·∫≠t danh s√°ch hi·ªÉn th·ªã
  updateExpensesList();
  
  // Reset input
  document.getElementById('expense-name').value = '';
  document.getElementById('expense-amount').value = '';
  
  // C·∫≠p nh·∫≠t th√¥ng tin b√°o c√°o
  updateReportSummary();
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t danh s√°ch chi ti√™u hi·ªÉn th·ªã
function updateExpensesList() {
  const expensesList = document.getElementById('expenses-list');
  
  if (currentExpenses.length === 0) {
    expensesList.innerHTML = '';
    return;
  }
  
  let html = '<h4>üìù Chi ti√™u trong ca:</h4>';
  
  currentExpenses.forEach((expense, index) => {
    html += `
      <div class="expense-item">
        <div class="expense-item-info">
          <div class="expense-item-name">${expense.name}</div>
        </div>
        <div class="expense-item-amount">-${formatCurrency(expense.amount)}</div>
        <button class="expense-item-delete" onclick="removeExpense(${index})">√ó</button>
      </div>
    `;
  });
  
  // T√≠nh t·ªïng chi ti√™u
  const totalExpense = currentExpenses.reduce((sum, expense) => sum + expense.amount, 0);
  html += `<div class="expense-total">T·ªïng chi ti√™u: -${formatCurrency(totalExpense)}</div>`;
  
  expensesList.innerHTML = html;
}

// H√ÄM M·ªöI: X√≥a chi ti√™u kh·ªèi danh s√°ch
function removeExpense(index) {
  currentExpenses.splice(index, 1);
  updateExpensesList();
  updateReportSummary();
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t th√¥ng tin b√°o c√°o khi ch·ªçn ca
function updateReportSummary() {
  const selectedShift = document.getElementById('report-shift').value;
  const recipient = document.getElementById('report-recipient').value;
  const summaryDiv = document.getElementById('report-summary');
  const detailsP = document.getElementById('report-details');
  const totalP = document.getElementById('report-total');
  const generateBtn = document.getElementById('btn-generate-report');
  
  if (!selectedShift || !recipient) {
    summaryDiv.style.display = 'none';
    generateBtn.disabled = true;
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift);
  
  if (shiftData.length === 0) {
    detailsP.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu cho ca n√†y';
    totalP.textContent = '';
    summaryDiv.style.display = 'block';
    generateBtn.disabled = true;
    return;
  }
  
  // T√≠nh t·ªïng ti·ªÅn doanh thu
  const totalRevenue = shiftData.reduce((sum, item) => sum + (parseInt(item.so_tien) || 0), 0);
  
  // T√≠nh t·ªïng chi ti√™u
  const totalExpense = currentExpenses.reduce((sum, expense) => sum + expense.amount, 0);
  
  // T√≠nh s·ªë ti·ªÅn th·ª±c t·∫ø (doanh thu - chi ti√™u)
  const actualAmount = totalRevenue - totalExpense;
  
  // Th·ªëng k√™
  const daNopCount = shiftData.filter(item => item.trang_thai === 'ƒê√£ n·ªôp').length;
  const chuaNopCount = shiftData.length - daNopCount;
  
  detailsP.innerHTML = `
    S·ªë ƒëi·ªÉm gas: <strong>${shiftData.length}</strong><br>
    ƒê√£ n·ªôp: <strong>${daNopCount}</strong> | Ch∆∞a n·ªôp: <strong>${chuaNopCount}</strong><br>
    T·ªïng doanh thu: <strong>${formatCurrency(totalRevenue)}</strong><br>
    T·ªïng chi ti√™u: <strong>-${formatCurrency(totalExpense)}</strong>
  `;
  
  totalP.innerHTML = `S·ªë ti·ªÅn th·ª±c t·∫ø: <span style="color: ${actualAmount >= 0 ? 'var(--primary)' : 'var(--danger)'}">${formatCurrency(actualAmount)}</span>`;
  summaryDiv.style.display = 'block';
  generateBtn.disabled = false;
}

// H√ÄM M·ªöI: T·∫°o b√°o c√°o v√† copy v√†o clipboard
async function generateReport() {
  const selectedShift = document.getElementById('report-shift').value;
  const recipient = document.getElementById('report-recipient').value;
  
  if (!selectedShift || !recipient) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn ca v√† ng∆∞·ªùi nh·∫≠n!', 'error');
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift);
  
  if (shiftData.length === 0) {
    showToast('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu cho ca n√†y!', 'error');
    return;
  }
  
  // T√≠nh t·ªïng ti·ªÅn doanh thu
  const totalRevenue = shiftData.reduce((sum, item) => sum + (parseInt(item.so_tien) || 0), 0);
  
  // T√≠nh t·ªïng chi ti√™u
  const totalExpense = currentExpenses.reduce((sum, expense) => sum + expense.amount, 0);
  
  // T·∫°o n·ªôi dung b√°o c√°o theo logic m·ªõi
  let reportContent;
  
  if (currentExpenses.length > 0) {
    // N·∫øu c√≥ chi ti√™u: "Giao [ng∆∞·ªùi nh·∫≠n] [t·ªïng doanh thu] (Tr·ª´ [m√¥ t·∫£ chi ti√™u 1] [s·ªë ti·ªÅn 1], [m√¥ t·∫£ chi ti√™u 2] [s·ªë ti·ªÅn 2], ...)"
    const expenseString = currentExpenses.map(expense => 
      `${expense.name} ${formatNumber(expense.amount)}`
    ).join(', ');
    
    reportContent = `Giao ${recipient} ${formatNumber(totalRevenue)} (Tr·ª´ ${expenseString})`;
  } else {
    // N·∫øu kh√¥ng c√≥ chi ti√™u: "Giao [ng∆∞·ªùi nh·∫≠n] [t·ªïng doanh thu]"
    reportContent = `Giao ${recipient} ${formatNumber(totalRevenue)}`;
  }
  
  // Copy v√†o clipboard
  const copySuccess = await copyToClipboard(reportContent);
  
  if (copySuccess) {
    showToast('‚úÖ ƒê√£ sao ch√©p b√°o c√°o v√†o clipboard!');
    closeModal('report-modal');
    
    // Hi·ªÉn th·ªã n·ªôi dung ƒë√£ copy (t√πy ch·ªçn)
    console.log('N·ªôi dung b√°o c√°o:', reportContent);
  } else {
    showToast('‚ùå Kh√¥ng th·ªÉ sao ch√©p v√†o clipboard!', 'error');
  }
}

// H√ÄM M·ªöI: ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn kh√¥ng c√≥ k√Ω hi·ªáu ti·ªÅn t·ªá
function formatNumber(amount) {
  return new Intl.NumberFormat('vi-VN').format(amount);
}

// H√ÄM M·ªöI: M·ªü modal chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t
function openBatchStatusModal() {
  closeSidebar();
  
  const shifts = new Set();
  allData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  const shiftSelect = document.getElementById('batch-status-shift');
  shiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    }
    
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftSelect.appendChild(option);
  });
  
  // Reset th√¥ng tin
  document.getElementById('batch-status-info').style.display = 'none';
  document.getElementById('batch-status-confirm').disabled = true;
  
  openModal('batch-status-modal');
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t th√¥ng tin khi ch·ªçn ca trong modal chuy·ªÉn tr·∫°ng th√°i
function updateBatchStatusInfo() {
  const selectedShift = document.getElementById('batch-status-shift').value;
  const newStatus = document.getElementById('batch-status-new-status').value;
  const infoDiv = document.getElementById('batch-status-info');
  const summary = document.getElementById('batch-status-summary');
  const details = document.getElementById('batch-status-details');
  const confirmBtn = document.getElementById('batch-status-confirm');
  
  if (!selectedShift) {
    infoDiv.style.display = 'none';
    confirmBtn.disabled = true;
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift);
  
  if (shiftData.length === 0) {
    summary.innerHTML = '‚ùå Kh√¥ng c√≥ ƒëi·ªÉm gas n√†o trong ca n√†y';
    details.innerHTML = '';
    infoDiv.style.display = 'block';
    confirmBtn.disabled = true;
    return;
  }
  
  const currentStatusCount = shiftData.filter(item => item.trang_thai === newStatus).length;
  const needUpdateCount = shiftData.length - currentStatusCount;
  
  if (needUpdateCount === 0) {
    summary.innerHTML = `‚úÖ T·∫•t c·∫£ ${shiftData.length} ƒëi·ªÉm gas ƒë√£ ·ªü tr·∫°ng th√°i "${newStatus}"`;
    details.innerHTML = `Kh√¥ng c√≥ ƒëi·ªÉm gas n√†o c·∫ßn chuy·ªÉn ƒë·ªïi`;
    infoDiv.style.display = 'block';
    confirmBtn.disabled = true;
  } else {
    summary.innerHTML = `üîÑ S·∫Ω chuy·ªÉn ${needUpdateCount}/${shiftData.length} ƒëi·ªÉm gas sang "${newStatus}"`;
    details.innerHTML = `${currentStatusCount} ƒëi·ªÉm ƒë√£ ·ªü tr·∫°ng th√°i n√†y, ${needUpdateCount} ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t`;
    infoDiv.style.display = 'block';
    confirmBtn.disabled = false;
  }
}

// H√ÄM M·ªöI: X√°c nh·∫≠n chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t - ƒê√É S·ª¨A L·ªñI
async function confirmBatchStatusUpdate() {
  const selectedShift = document.getElementById('batch-status-shift').value;
  const newStatus = document.getElementById('batch-status-new-status').value;
  
  if (!selectedShift) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt ca!', 'error');
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift && item.trang_thai !== newStatus);
  
  if (shiftData.length === 0) {
    showToast('‚úÖ Kh√¥ng c√≥ ƒëi·ªÉm gas n√†o c·∫ßn chuy·ªÉn ƒë·ªïi!');
    return;
  }
  
  const confirmBtn = document.getElementById('batch-status-confirm');
  confirmBtn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
  confirmBtn.disabled = true;
  
  let successCount = 0;
  let errorCount = 0;
  
  // C·∫≠p nh·∫≠t t·ª´ng b·∫£n ghi
  for (const item of shiftData) {
    try {
      // T·∫°o b·∫£n sao c·ªßa item ƒë·ªÉ tr√°nh thay ƒë·ªïi d·ªØ li·ªáu g·ªëc
      const updatedItem = { ...item, trang_thai: newStatus };
      
      const data = {
        action: 'update',
        ...updatedItem
      };
      
      const response = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.result === 'success') {
        successCount++;
        // C·∫≠p nh·∫≠t d·ªØ li·ªáu c·ª•c b·ªô - ƒê√É S·ª¨A: C·∫≠p nh·∫≠t to√†n b·ªô th√¥ng tin item
        const index = allData.findIndex(d => d.id === item.id);
        if (index !== -1) {
          allData[index] = updatedItem;
        }
      } else {
        errorCount++;
      }
    } catch (error) {
      errorCount++;
      console.error('L·ªói khi c·∫≠p nh·∫≠t:', error);
    }
  }
  
  // Hi·ªÉn th·ªã k·∫øt qu·∫£
  if (errorCount === 0) {
    showToast(`‚úÖ ƒê√£ chuy·ªÉn th√†nh c√¥ng ${successCount} ƒëi·ªÉm gas sang "${newStatus}"`);
  } else {
    showToast(`‚ö†Ô∏è ƒê√£ chuy·ªÉn ${successCount} ƒëi·ªÉm, ${errorCount} ƒëi·ªÉm l·ªói`, 'error');
  }
  
  // ƒê√≥ng modal v√† c·∫≠p nh·∫≠t giao di·ªán - ƒê√É S·ª¨A: G·ªçi filterData() thay v√¨ taiDuLieu()
  closeModal('batch-status-modal');
  
  // C·∫≠p nh·∫≠t cacheDiem ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu nh·∫•t qu√°n
  updateCacheDiem();
  
  // C·∫≠p nh·∫≠t giao di·ªán v·ªõi d·ªØ li·ªáu c·ª•c b·ªô ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
  filterData();
  
  // Reset n√∫t x√°c nh·∫≠n
  confirmBtn.textContent = 'X√°c nh·∫≠n';
  confirmBtn.disabled = false;
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t cacheDiem t·ª´ allData
function updateCacheDiem() {
  cacheDiem = {};
  allData.forEach(item => {
    if (item.ten_diem && item.dia_chi) {
      cacheDiem[item.ten_diem] = item.dia_chi;
    }
  });
}

// H√ÄM M·ªöI: Ki·ªÉm tra xem ƒëi·ªÉm gas ƒë√£ c√≥ v·ªã tr√≠ GPS ch∆∞a
function hasExistingGPSLocation(diemName) {
  // T√¨m t·∫•t c·∫£ c√°c b·∫£n ghi c·ªßa ƒëi·ªÉm gas n√†y
  const diemEntries = allData.filter(item => item.ten_diem === diemName);
  
  // Ki·ªÉm tra xem c√≥ b·∫£n ghi n√†o ƒë√£ c√≥ GPS kh√¥ng
  for (let i = 0; i < diemEntries.length; i++) {
    if (diemEntries[i].ghi_chu && diemEntries[i].ghi_chu.includes('[GPS:')) {
      return true;
    }
  }
  return false;
}

// H√†m hi·ªÉn th·ªã th√¥ng b√°o toast
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  
  toastMessage.textContent = message;
  toast.className = `toast ${type} show`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// H√†m sao ch√©p v√†o clipboard
async function copyToClipboard(text) {
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return true;
    } else {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textArea);
      return success;
    }
  } catch (err) {
    console.error('L·ªói khi sao ch√©p v√†o clipboard: ', err);
    return false;
  }
}

// H√†m m·ªü/ƒë√≥ng sidebar
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
}

// ƒê√≥ng sidebar
function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
}

// H√†m xu·∫•t d·ªØ li·ªáu d·∫°ng vƒÉn b·∫£n
async function exportToText() {
  closeSidebar();
  
  const dataToExport = currentFilteredData.length > 0 ? currentFilteredData : allData;
  
  if (dataToExport.length === 0) {
    showToast('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
    return;
  }
  
  let content = '';
  dataToExport.forEach(item => {
    content += `${item.ten_diem} - ${item.so_tien}\n`;
  });
  
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const link = document.createElement('a');
  
  const shiftInfo = getCurrentShift();
  const fileName = shiftInfo.shiftKey ? `diem_gas_${shiftInfo.shiftKey}.txt` : `diem_gas_${new Date().toISOString().slice(0,10)}.txt`;
  
  link.download = fileName;
  link.href = URL.createObjectURL(blob);
  link.click();
  
  URL.revokeObjectURL(link.href);
  
  const copySuccess = await copyToClipboard(content);
  
  if (copySuccess) {
    showToast('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu v√† sao ch√©p v√†o clipboard!');
  } else {
    showToast('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu, nh∆∞ng kh√¥ng th·ªÉ sao ch√©p v√†o clipboard', 'error');
  }
}

// TH√äM H√ÄM M·ªöI: M·ªü modal th√™m ƒëi·ªÉm ngo√†i ca
function openOutOfHoursModal() {
  closeSidebar();
  
  const shiftInfo = getCurrentShift();
  if (shiftInfo.start) {
    showToast('‚ö†Ô∏è B·∫°n ƒëang trong ca l√†m vi·ªác, h√£y s·ª≠ d·ª•ng ch·ª©c nƒÉng th√™m ƒëi·ªÉm b√¨nh th∆∞·ªùng!', 'error');
    return;
  }
  
  const shifts = new Set();
  allData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  const shiftSelect = document.getElementById('out-of-hours-shift');
  shiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    }
    
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftSelect.appendChild(option);
  });
  
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('custom-shift-date').value = today;
  
  selectedOutOfHoursShift = null;
  
  openModal('out-of-hours-modal');
}

// TH√äM H√ÄM M·ªöI: S·ª≠ d·ª•ng ng√†y t√πy ch·ªânh
function useCustomShift() {
  const customDate = document.getElementById('custom-shift-date').value;
  if (!customDate) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn ng√†y!', 'error');
    return;
  }
  
  const dateObj = new Date(customDate);
  const year = dateObj.getFullYear();
  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
  const day = String(dateObj.getDate()).padStart(2, '0');
  selectedOutOfHoursShift = `${year}-${month}-${day}`;
  
  document.getElementById('out-of-hours-shift').value = selectedOutOfHoursShift;
  
  showToast(`‚úÖ ƒê√£ ch·ªçn ca ng√†y ${day}-${month}-${year}`);
}

// TH√äM H√ÄM M·ªöI: X√°c nh·∫≠n ca khi th√™m ngo√†i gi·ªù
function confirmOutOfHoursShift() {
  const shiftSelect = document.getElementById('out-of-hours-shift');
  const selectedShift = shiftSelect.value;
  
  if (!selectedShift) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt ca!', 'error');
    return;
  }
  
  selectedOutOfHoursShift = selectedShift;
  closeModal('out-of-hours-modal');
  
  showToast(`‚úÖ ƒê√£ ch·ªçn ca: ${formatShiftName(selectedShift)}. B·∫°n c√≥ th·ªÉ th√™m ƒëi·ªÉm gas b√¢y gi·ªù.`);
  
  document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

// TH√äM H√ÄM M·ªöI: ƒê·ªãnh d·∫°ng t√™n ca
function formatShiftName(shiftKey) {
  if (/^\d{4}-\d{2}-\d{2}/.test(shiftKey)) {
    const d = new Date(shiftKey);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `Ca ${day}-${month}-${year}`;
  }
  return shiftKey;
}

// TH√äM H√ÄM M·ªöI: M·ªü modal xem nhanh
function openQuickViewModal() {
  closeSidebar();
  
  const shifts = new Set();
  allData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  const shiftSelect = document.getElementById('quick-view-shift');
  shiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    }
    
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftSelect.appendChild(option);
  });
  
  const currentShift = getCurrentShift();
  if (currentShift.shiftKey && shifts.has(currentShift.shiftKey)) {
    shiftSelect.value = currentShift.shiftKey;
    updateQuickViewList();
  }
  
  openModal('quick-view-modal');
}

// TH√äM H√ÄM M·ªöI: C·∫≠p nh·∫≠t danh s√°ch xem nhanh
function updateQuickViewList() {
  const selectedShift = document.getElementById('quick-view-shift').value;
  const listContainer = document.getElementById('quick-view-list');
  const totalContainer = document.getElementById('quick-view-total');
  const emptyState = document.getElementById('quick-view-empty');
  
  listContainer.style.display = 'none';
  totalContainer.style.display = 'none';
  emptyState.style.display = 'none';
  
  if (!selectedShift) {
    emptyState.style.display = 'block';
    emptyState.innerHTML = '<p>üì≠ Vui l√≤ng ch·ªçn m·ªôt ca</p>';
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift);
  
  if (shiftData.length === 0) {
    emptyState.style.display = 'block';
    emptyState.innerHTML = '<p>üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu cho ca n√†y</p>';
    return;
  }
  
  listContainer.innerHTML = '';
  let totalAmount = 0;
  
  shiftData.forEach(item => {
    totalAmount += parseInt(item.so_tien) || 0;
    
    const itemElement = document.createElement('div');
    itemElement.className = 'quick-view-item';
    itemElement.innerHTML = `
      <div class="quick-view-item-info">
        <div class="quick-view-item-name">${item.ten_diem}</div>
        <div class="quick-view-item-address">${item.dia_chi}</div>
      </div>
      <div class="quick-view-item-amount">${formatCurrency(item.so_tien)}</div>
    `;
    
    listContainer.appendChild(itemElement);
  });
  
  totalContainer.innerHTML = `T·ªïng ti·ªÅn: <strong>${formatCurrency(totalAmount)}</strong>`;
  totalContainer.style.display = 'block';
  
  listContainer.style.display = 'block';
  
  const modalBody = document.querySelector('#quick-view-modal .modal-body');
  if (modalBody) {
    modalBody.scrollTop = 0;
  }
}

// X·ª≠ l√Ω nh·∫≠p nhanh s·ªë ti·ªÅn h√†ng ng√†n
document.getElementById('so_tien').addEventListener('blur', function() {
  let value = this.value.trim();
  
  if (/^\d+$/.test(value) && value.length > 0 && value.length <= 3) {
    this.value = value + '000';
  }
});

// H√†m x√°c ƒë·ªãnh ca hi·ªán t·∫°i (18h30 h√¥m nay ƒë·∫øn 6h30 s√°ng h√¥m sau)
function getCurrentShift() {
  const now = new Date();
  const currentHour = now.getHours();
  const currentMinutes = now.getMinutes();

  let shiftStart = new Date(now);
  let shiftEnd = new Date(now);

  if (currentHour < 6 || (currentHour === 6 && currentMinutes < 30)) {
    shiftStart.setDate(shiftStart.getDate() - 1);
    shiftStart.setHours(18, 30, 0, 0);
    shiftEnd.setHours(6, 30, 0, 0);
  } 
  else if (currentHour > 18 || (currentHour === 18 && currentMinutes >= 30)) {
    shiftStart.setHours(18, 30, 0, 0);
    shiftEnd.setDate(shiftEnd.getDate() + 1);
    shiftEnd.setHours(6, 30, 0, 0);
  }
  else {
    return {
      shift: 'Ngo√†i ca l√†m vi·ªác',
      start: null,
      end: null
    };
  }

  const formatDate = (date) => {
    const d = date;
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    const hour = String(d.getHours()).padStart(2, '0');
    const minute = String(d.getMinutes()).padStart(2, '0');
    return `${day}-${month}-${year} ${hour}:${minute}`;
  };

  const shiftKey = `${shiftStart.getFullYear()}-${String(shiftStart.getMonth() + 1).padStart(2, '0')}-${String(shiftStart.getDate()).padStart(2, '0')}`;
  const shiftName = `Ca ${formatDate(shiftStart).split(' ')[0]}`;

  return {
    shift: shiftName,
    shiftKey: shiftKey,
    start: formatDate(shiftStart),
    end: formatDate(shiftEnd)
  };
}

// C·∫≠p nh·∫≠t th√¥ng tin ca hi·ªán t·∫°i
function updateShiftInfo() {
  const shiftInfo = getCurrentShift();
  currentShift = shiftInfo.shiftKey;
  
  document.getElementById('current-shift').textContent = shiftInfo.shift;
  
  if (shiftInfo.start && shiftInfo.end) {
    document.getElementById('shift-time').textContent = 
      `‚è∞ ${shiftInfo.start} - ${shiftInfo.end}`;
  } else {
    document.getElementById('shift-time').textContent = 
      '‚è∞ Hi·ªán t·∫°i kh√¥ng trong ca l√†m vi·ªác';
  }
}

// ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
function formatCurrency(amount) {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND'
  }).format(amount);
}

// T√≠nh to√°n th·ªëng k√™
function calculateStats(data) {
  const stats = {
    total: 0,
    count: data.length,
    shifts: new Set(),
    diem: new Set(),
    daNop: 0,
    chuaNop: 0
  };
  
  data.forEach(item => {
    stats.total += parseInt(item.so_tien) || 0;
    if (item.ca) stats.shifts.add(item.ca);
    if (item.ten_diem) stats.diem.add(item.ten_diem);
    if (item.trang_thai === 'ƒê√£ n·ªôp') {
      stats.daNop++;
    } else {
      stats.chuaNop++;
    }
  });
  
  return stats;
}

// Hi·ªÉn th·ªã th·ªëng k√™
function displayStats(stats) {
  const container = document.getElementById('stats-container');
  
  container.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.count}</div>
      <div class="stat-label">S·ªë giao d·ªãch</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${formatCurrency(stats.total)}</div>
      <div class="stat-label">T·ªïng ti·ªÅn</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.daNop}/${stats.chuaNop}</div>
      <div class="stat-label">ƒê√£ n·ªôp/Ch∆∞a n·ªôp</div>
    </div>
  `;
}

// L·ªçc d·ªØ li·ªáu theo ca
function filterByShift() {
  filterData();
}

// L·ªçc d·ªØ li·ªáu theo ƒëi·ªÉm
function filterByDiem() {
  filterData();
}

// L·ªçc d·ªØ li·ªáu theo tr·∫°ng th√°i
function filterByTrangThai() {
  filterData();
}

// L·ªçc v√† hi·ªÉn th·ªã d·ªØ li·ªáu
function filterData() {
  const shiftFilter = document.getElementById('filter-shift').value;
  const diemFilter = document.getElementById('filter-diem').value;
  const trangThaiFilter = document.getElementById('filter-trangthai').value;
  
  let filteredData = allData;
  
  if (shiftFilter !== 'all') {
    filteredData = filteredData.filter(item => item.ca === shiftFilter);
  }
  
  if (diemFilter !== 'all') {
    filteredData = filteredData.filter(item => item.ten_diem === diemFilter);
  }
  
  if (trangThaiFilter !== 'all') {
    filteredData = filteredData.filter(item => item.trang_thai === trangThaiFilter);
  }

  currentFilteredData = filteredData;

  const shiftInfo = getCurrentShift();
  if (shiftFilter === shiftInfo.shiftKey && shiftInfo.start && filteredData.length === 0) {
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('empty-state').innerHTML = '<h3>üì≠ Ch∆∞a c√≥ ƒëi·ªÉm n√†o trong ca hi·ªán t·∫°i</h3><p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>';
  } else {
    document.getElementById('empty-state').innerHTML = '<h3>üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu</h3><p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>';
  }

  displayData(filteredData);
  displayStats(calculateStats(filteredData));
}

// Hi·ªÉn th·ªã d·ªØ li·ªáu trong b·∫£ng
function displayData(data) {
  const tbody = document.querySelector('#bang tbody');
  tbody.innerHTML = '';
  
  const emptyState = document.getElementById('empty-state');
  if (data.length === 0) {
    emptyState.style.display = 'block';
  } else {
    emptyState.style.display = 'none';
  }
  
  data.forEach(row => {
    const tr = document.createElement('tr');
    tr.className = 'fade-in';
    
    let badgeClass = 'badge-warning';
    if (row.trang_thai === 'ƒê√£ n·ªôp') {
      badgeClass = 'badge-secondary';
    }

    let caLabel = row.ca || 'Kh√¥ng x√°c ƒë·ªãnh';
    if (/^\d{4}-\d{2}-\d{2}/.test(row.ca)) {
      const d = new Date(row.ca);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      caLabel = `${day}-${month}-${year}`;
    }
    
    tr.innerHTML = `
      <td data-label="T√™n ƒëi·ªÉm">${row.ten_diem}</td>
      <td data-label="S·ªë ti·ªÅn">${formatCurrency(row.so_tien)}</td>
      <td data-label="ƒê·ªãa ch·ªâ">${row.dia_chi}</td>
      <td data-label="Tr·∫°ng th√°i">
        <div class="status-toggle-wrapper">
          <span class="badge ${badgeClass} status-toggle" onclick="toggleTrangThai('${row.id}')">${row.trang_thai || 'Ch∆∞a n·ªôp'}</span>
        </div>
      </td>
      <td data-label="Ca"><span class="badge badge-primary">${caLabel}</span></td>
      <td data-label="Th·ªùi gian">${row.timestamp ? new Date(row.timestamp).toLocaleString('vi-VN') : 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
      <td data-label="Thao t√°c">
        <div class="action-buttons">
          <button class="btn-secondary btn-sm" onclick="editItem('${row.id}')">‚úèÔ∏è S·ª≠a</button>
          <button class="btn-danger btn-sm" onclick="deleteItem('${row.id}')">üóëÔ∏è X√≥a</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// H√†m thay ƒë·ªïi tr·∫°ng th√°i nhanh
function toggleTrangThai(id) {
  const item = allData.find(item => item.id === id);
  if (!item) return;

  const newTrangThai = item.trang_thai === 'ƒê√£ n·ªôp' ? 'Ch∆∞a n·ªôp' : 'ƒê√£ n·ªôp';

  const badgeElement = document.querySelector(`[onclick="toggleTrangThai('${id}')"]`);
  if (badgeElement) {
    badgeElement.textContent = newTrangThai;
    badgeElement.className = `badge ${newTrangThai === 'ƒê√£ n·ªôp' ? 'badge-secondary' : 'badge-warning'} status-toggle`;
  }

  const updatedItem = { ...item, trang_thai: newTrangThai };

  const data = {
    action: 'update',
    ...updatedItem
  };

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'success') {
      showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!');
      const index = allData.findIndex(item => item.id === id);
      if (index !== -1) {
        allData[index] = updatedItem;
      }
      // C·∫≠p nh·∫≠t cacheDiem
      updateCacheDiem();
      filterData();
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'error');
      taiDuLieu();
    }
  })
  .catch(error => {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'error');
    console.error(error);
    taiDuLieu();
  });
}

// C·∫≠p nh·∫≠t b·ªô l·ªçc
function updateFilters(data) {
  const shifts = new Set();
  const diems = new Set();

  data.forEach(item => {
    if (item.ca) shifts.add(item.ca);
    if (item.ten_diem) diems.add(item.ten_diem);
  });

  const shiftFilter = document.getElementById('filter-shift');
  shiftFilter.innerHTML = '<option value="all">T·∫•t c·∫£ c√°c ca</option>';

  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    } else if (shift.startsWith('Ca ')) {
      shiftLabel = shift;
    }
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftFilter.appendChild(option);
  });

  const diemFilter = document.getElementById('filter-diem');
  diemFilter.innerHTML = '<option value="all">T·∫•t c·∫£ ƒëi·ªÉm gas</option>';

  Array.from(diems).sort().forEach(diem => {
    const option = document.createElement('option');
    option.value = diem;
    option.textContent = diem;
    diemFilter.appendChild(option);
  });
}

// Reset form
function resetForm() {
  closeSidebar();
  editingId = null;
  selectedOutOfHoursShift = null;
  document.getElementById('chon_diem').value = '';
  document.getElementById('ten_diem').value = '';
  document.getElementById('ten_diem').disabled = false;
  document.getElementById('so_tien').value = '';
  document.getElementById('dia_chi').value = '';
  document.getElementById('ghi_chu').value = '';
  document.getElementById('trang_thai').value = 'Ch∆∞a n·ªôp';
  document.getElementById('btn-submit').textContent = 'üíæ L∆∞u th√¥ng tin';
  document.getElementById('btn-cancel').style.display = 'none';
  
  // Reset n√∫t l∆∞u v·ªã tr√≠
  resetSaveLocationButton();
}

// H√ÄM M·ªöI: Reset tr·∫°ng th√°i n√∫t l∆∞u v·ªã tr√≠
function resetSaveLocationButton() {
  const btn = document.getElementById('btn-save-location');
  btn.textContent = 'üìç L∆∞u v·ªã tr√≠';
  btn.disabled = false;
  btn.className = 'btn-success btn-sm';
}

// H√ÄM M·ªöI: T√¨m b·∫£n ghi g·∫ßn nh·∫•t cho m·ªôt ƒëi·ªÉm gas c·ª• th·ªÉ
function findLatestEntryForDiem(diemName) {
  // L·ªçc t·∫•t c·∫£ c√°c b·∫£n ghi c·ªßa ƒëi·ªÉm gas n√†y
  const diemEntries = allData.filter(item => item.ten_diem === diemName);
  
  if (diemEntries.length === 0) {
    return null;
  }
  
  // S·∫Øp x·∫øp theo th·ªùi gian gi·∫£m d·∫ßn (m·ªõi nh·∫•t ƒë·∫ßu ti√™n)
  diemEntries.sort((a, b) => {
    const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
    const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
    return timeB - timeA;
  });
  
  // Tr·∫£ v·ªÅ b·∫£n ghi m·ªõi nh·∫•t
  return diemEntries[0];
}

// H√ÄM C·∫¨P NH·∫¨T: Ch·ªçn ƒëi·ªÉm gas (t·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ v√† s·ªë ti·ªÅn c·ªßa l·∫ßn g·∫ßn nh·∫•t)
function chonDiem() {
  const val = document.getElementById('chon_diem').value;
  const tenDiemInput = document.getElementById('ten_diem');
  const diaChiInput = document.getElementById('dia_chi');
  const soTienInput = document.getElementById('so_tien');
  
  // Reset n√∫t l∆∞u v·ªã tr√≠ khi thay ƒë·ªïi ƒëi·ªÉm gas
  resetSaveLocationButton();
  
  if (!val) {
    tenDiemInput.value = '';
    diaChiInput.value = '';
    soTienInput.value = '';
    tenDiemInput.disabled = false;
    tenDiemInput.placeholder = "Nh·∫≠p t√™n ƒëi·ªÉm (n·∫øu th√™m m·ªõi)";
  } else {
    tenDiemInput.value = val;
    diaChiInput.value = cacheDiem[val] || '';
    tenDiemInput.disabled = true;
    tenDiemInput.placeholder = "T√™n ƒëi·ªÉm ƒë√£ ch·ªçn";
    
    // T√¨m s·ªë ti·ªÅn c·ªßa l·∫ßn g·∫ßn nh·∫•t cho ƒëi·ªÉm gas n√†y
    const latestEntry = findLatestEntryForDiem(val);
    if (latestEntry) {
      soTienInput.value = latestEntry.so_tien;
      // Th√™m focus ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ d·ªÖ d√†ng s·ª≠a n·∫øu mu·ªën
      setTimeout(() => {
        soTienInput.focus();
        soTienInput.select();
      }, 100);
    }
    
    // Ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t l∆∞u v·ªã tr√≠ n·∫øu ƒëi·ªÉm ƒë√£ c√≥ GPS
    if (hasExistingGPSLocation(val)) {
      const btn = document.getElementById('btn-save-location');
      btn.textContent = 'ƒê√£ c√≥';
      btn.disabled = true;
      btn.className = 'btn-location-disabled btn-sm';
    }
  }
}

// X·ª≠ l√Ω n√∫t l∆∞u v·ªã tr√≠ GPS - ƒê√É C·∫¨P NH·∫¨T
function saveLocation() {
  const tenDiem = document.getElementById('ten_diem').value || document.getElementById('chon_diem').value;
  
  // Ki·ªÉm tra xem ƒë√£ ch·ªçn ƒëi·ªÉm gas ch∆∞a
  if (!tenDiem) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒëi·ªÉm gas tr∆∞·ªõc khi l∆∞u v·ªã tr√≠!', 'error');
    return;
  }
  
  // Ki·ªÉm tra xem ƒëi·ªÉm gas n√†y ƒë√£ c√≥ v·ªã tr√≠ GPS ch∆∞a
  if (hasExistingGPSLocation(tenDiem)) {
    showToast('‚ùå ƒêi·ªÉm gas n√†y ƒë√£ ƒë∆∞·ª£c l∆∞u v·ªã tr√≠ GPS tr∆∞·ªõc ƒë√≥!', 'error');
    return;
  }
  
  if (!navigator.geolocation) {
    showToast('‚ùå Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ GPS!', 'error');
    return;
  }
  
  const btn = document.getElementById('btn-save-location');
  btn.disabled = true;
  btn.textContent = '‚è≥ ƒêang l·∫•y v·ªã tr√≠...';
  
  navigator.geolocation.getCurrentPosition(
    function(pos) {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      let ghiChuInput = document.getElementById('ghi_chu');
      
      // X√≥a GPS c≈© n·∫øu c√≥ v√† th√™m GPS m·ªõi
      let ghiChu = ghiChuInput.value.replace(/\s*\[GPS: [\d.-]+, [\d.-]+\]/, '');
      ghiChuInput.value = ghiChu + ` [GPS: ${lat}, ${lng}]`;
      
      showToast('‚úÖ ƒê√£ l∆∞u v·ªã tr√≠ GPS th·ª±c t·∫ø!');
      btn.textContent = 'üìç ƒê√£ l∆∞u v·ªã tr√≠';
      btn.disabled = false;
      
      // ƒê·ªïi m√†u n√∫t ƒë·ªÉ th·ªÉ hi·ªán ƒë√£ l∆∞u th√†nh c√¥ng
      btn.className = 'btn-success btn-sm';
      btn.style.backgroundColor = '#34c759';
    }, 
    function(err) {
      showToast('‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: ' + err.message, 'error');
      btn.textContent = 'üìç L∆∞u v·ªã tr√≠';
      btn.disabled = false;
      btn.className = 'btn-success btn-sm';
    }, 
    { 
      enableHighAccuracy: true, 
      timeout: 15000, 
      maximumAge: 0 
    }
  );
}

// Ch·ªânh s·ª≠a item
function editItem(id) {
  const item = allData.find(item => item.id === id);
  if (!item) return;
  
  editingId = id;
  
  // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
  document.getElementById('chon_diem').value = item.ten_diem;
  document.getElementById('ten_diem').value = item.ten_diem;
  document.getElementById('ten_diem').disabled = true;
  document.getElementById('so_tien').value = item.so_tien;
  document.getElementById('dia_chi').value = item.dia_chi;
  document.getElementById('ghi_chu').value = item.ghi_chu || '';
  document.getElementById('trang_thai').value = item.trang_thai || 'Ch∆∞a n·ªôp';
  
  // Thay ƒë·ªïi n√∫t th√†nh c·∫≠p nh·∫≠t
  document.getElementById('btn-submit').textContent = 'üíæ C·∫≠p nh·∫≠t';
  document.getElementById('btn-cancel').style.display = 'block';
  
  // Ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t l∆∞u v·ªã tr√≠
  if (hasExistingGPSLocation(item.ten_diem)) {
    const btn = document.getElementById('btn-save-location');
    btn.textContent = 'üìç ƒê√£ c√≥ v·ªã tr√≠';
    btn.disabled = true;
    btn.className = 'btn-location-disabled btn-sm';
  } else {
    resetSaveLocationButton();
  }
  
  // Cu·ªôn l√™n ƒë·∫ßu form
  document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

// X√≥a item
function deleteItem(id) {
  const item = allData.find(item => item.id === id);
  if (!item) return;
  
  itemToDelete = id;
  document.getElementById('delete-item-info').textContent = 
    `${item.ten_diem} - ${formatCurrency(item.so_tien)} - ${item.dia_chi}`;
  
  openModal('delete-modal');
}

// X√°c nh·∫≠n x√≥a
function confirmDelete() {
  if (!itemToDelete) return;
  
  const data = { 
    action: 'delete',
    id: itemToDelete
  };

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'success') {
      showToast('‚úÖ ƒê√£ x√≥a th√†nh c√¥ng!');
      closeModal('delete-modal');
      taiDuLieu();
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a!', 'error');
    }
  })
  .catch(error => {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a!', 'error');
    console.error(error);
  });
}

// M·ªü modal
function openModal(modalId) {
  closeSidebar();
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

// ƒê√≥ng modal
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// C·∫≠p nh·∫≠t s·ª± ki·ªán click cho n√∫t l∆∞u v·ªã tr√≠
document.getElementById('btn-save-location').addEventListener('click', saveLocation);

async function guiDuLieu() {
  const btnSubmit = document.getElementById('btn-submit');
  if (btnSubmit.disabled) return;

  const ten_diem = document.getElementById('ten_diem').value || document.getElementById('chon_diem').value;
  const so_tien = document.getElementById('so_tien').value;
  const dia_chi = document.getElementById('dia_chi').value;
  const ghi_chu = document.getElementById('ghi_chu').value;
  const trang_thai = document.getElementById('trang_thai').value;

  if (!ten_diem || !so_tien || !dia_chi) {
    showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
    return;
  }

  if (!editingId) {
    const shiftInfo = getCurrentShift();
    
    if (!selectedOutOfHoursShift && !shiftInfo.start) {
      showToast('‚ö†Ô∏è Hi·ªán t·∫°i kh√¥ng trong ca l√†m vi·ªác! Vui l√≤ng s·ª≠ d·ª•ng ch·ª©c nƒÉng "Th√™m ƒëi·ªÉm ngo√†i ca" t·ª´ menu.', 'error');
      return;
    }
  }

  btnSubmit.textContent = '‚è≥ ƒêang l∆∞u...';
  btnSubmit.disabled = true;

  let shiftToUse = selectedOutOfHoursShift;
  if (!shiftToUse && !editingId) {
    shiftToUse = getCurrentShift().shiftKey;
  }

  const data = { 
    ten_diem, 
    so_tien, 
    dia_chi,
    ghi_chu,
    trang_thai,
    ca: editingId ? undefined : shiftToUse,
    timestamp: editingId ? undefined : new Date().toISOString(),
    id: editingId || undefined
  };

  if (editingId) {
    data.action = 'update';
  }

  try {
    const response = await fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify(data)
    });
    const result = await response.json();
    
    if (result.result === 'success') {
      showToast(editingId ? '‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!' : '‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
      resetForm();
      taiDuLieu();
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!', 'error');
    }
  } catch (error) {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!', 'error');
    console.error(error);
  } finally {
    btnSubmit.textContent = editingId ? 'üíæ C·∫≠p nh·∫≠t' : 'üíæ L∆∞u th√¥ng tin';
    btnSubmit.disabled = false;
  }
}

async function taiDuLieu() {
  closeSidebar();
  try {
    const res = await fetch(scriptURL);
    const data = await res.json();
    allData = data;
    currentFilteredData = data;
    
    // C·∫≠p nh·∫≠t cacheDiem t·ª´ d·ªØ li·ªáu m·ªõi
    updateCacheDiem();
    
    const diemList = document.getElementById('diem-list');
    diemList.innerHTML = '';
    const uniqueDiems = new Set();
    data.forEach(row => {
      const ten = row.ten_diem;
      if (!uniqueDiems.has(ten)) {
        const opt = document.createElement('option');
        opt.value = ten;
        diemList.appendChild(opt);
        uniqueDiems.add(ten);
      }
    });

    displayData(data);
    displayStats(calculateStats(data));
    updateFilters(data);
    
  } catch (error) {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu!', 'error');
    console.error(error);
  }
}

// Th√™m h√†m ƒë·ªÉ x·ª≠ l√Ω ƒë√≥ng modal khi ch·∫°m ra ngo√†i
function setupModalCloseOnOutsideClick() {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal(modal.id);
      }
    });
  });
}

// Hi·ªÉn th·ªã/·∫©n n√∫t cu·ªôn v·ªÅ ƒë·∫ßu trang khi cu·ªôn
window.addEventListener('scroll', function() {
  const btn = document.getElementById('scrollTopBtn');
  if (window.scrollY > 200) {
    btn.style.display = 'flex';
    btn.style.opacity = '1';
  } else {
    btn.style.opacity = '0';
    setTimeout(() => { btn.style.display = 'none'; }, 300);
  }
});

// X·ª≠ l√Ω s·ª± ki·ªán cu·ªôn v·ªÅ ƒë·∫ßu trang
document.getElementById('scrollTopBtn').onclick = function() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

// Kh·ªüi t·∫°o
document.addEventListener('DOMContentLoaded', function() {
  updateShiftInfo();
  taiDuLieu().then(() => {
    const shiftInfo = getCurrentShift();
    const shiftFilter = document.getElementById('filter-shift');
    if (shiftInfo.start) {
      shiftFilter.value = shiftInfo.shiftKey;
    } else {
      shiftFilter.value = 'all';
    }
    filterData();
  });
  
  document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
  document.getElementById('close-sidebar').addEventListener('click', closeSidebar);
  document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);
  
  setupModalCloseOnOutsideClick();
  
  // Th√™m s·ª± ki·ªán cho modal chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t
  document.getElementById('batch-status-shift').addEventListener('change', updateBatchStatusInfo);
  document.getElementById('batch-status-new-status').addEventListener('change', updateBatchStatusInfo);
  
  // Th√™m s·ª± ki·ªán cho modal b√°o c√°o cu·ªëi ca
  document.getElementById('report-shift').addEventListener('change', updateReportSummary);
  document.getElementById('report-recipient').addEventListener('input', updateReportSummary);
  
  // Th√™m s·ª± ki·ªán cho √¥ nh·∫≠p t√™n chi ti√™u (t·ª± ƒë·ªông ƒëi·ªÅn s·ªë ti·ªÅn t·ª´ m·∫´u)
  document.getElementById('expense-name').addEventListener('change', function() {
    const expenseName = this.value.trim();
    if (!expenseName) return;
    
    // T√¨m trong danh s√°ch m·∫´u
    const template = expenseTemplateList.find(t => t.name === expenseName);
    if (template && template.amount > 0) {
      document.getElementById('expense-amount').value = template.amount;
    }
  });
  
  // Th√™m s·ª± ki·ªán cho √¥ nh·∫≠p s·ªë ti·ªÅn chi ti√™u
  document.getElementById('expense-amount').addEventListener('blur', function() {
    let value = this.value.trim();
    if (/^\d+$/.test(value) && value.length > 0 && value.length <= 3) {
      this.value = value + '000';
    }
  });
  
  setInterval(updateShiftInfo, 60000);
});
</script>
</body>
</html>