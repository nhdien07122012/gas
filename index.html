<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n l√Ω ti·ªÅn thu ƒëi·ªÉm gas theo ca</title>
<style>
  :root {
    --primary: #2c80ff;
    --primary-dark: #1a6de0;
    --secondary: #34c759;
    --danger: #ff3b30;
    --warning: #ff9500;
    --light: #f8f9fa;
    --dark: #333;
    --gray: #6c757d;
    --border: #dee2e6;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
    --radius: 10px;
    --night-shift: #4a5568;
    --day-shift: #f7fafc;
    --sidebar-width: 280px;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
    transition: margin-left 0.3s ease;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  /* Sidebar styles */
  .sidebar {
    position: fixed;
    top: 0;
    left: -280px;
    width: var(--sidebar-width);
    height: 100%;
    background: white;
    box-shadow: 2px 0 15px rgba(0,0,0,0.1);
    z-index: 1001;
    transition: left 0.3s ease;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  
  .sidebar.open {
    left: 0;
  }
  
  .sidebar-header {
    padding: 20px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .sidebar-header h2 {
    font-size: 1.3rem;
  }
  
  .close-sidebar {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: auto;
  }
  
  .sidebar-content {
    padding: 20px;
    flex: 1;
  }
  
  .sidebar-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: var(--radius);
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    width: 100%;
    text-align: left;
    font-size: 1rem;
  }
  
  .sidebar-item:hover {
    background: #e9ecef;
    transform: translateY(-2px);
  }
  
  .sidebar-item.active {
    background: var(--primary);
    color: white;
  }
  
  .sidebar-footer {
    padding: 20px;
    border-top: 1px solid var(--border);
    font-size: 0.85rem;
    color: var(--gray);
    text-align: center;
  }
  
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
  }
  
  .overlay.active {
    display: block;
  }
  
  .menu-toggle {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    margin-right: 10px;
  }
  
  /* Header styles */
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 25px 30px;
    text-align: center;
    position: relative;
  }
  
  header h1 {
    font-size: 1.8rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  header p {
    opacity: 0.9;
    font-size: 1rem;
  }
  
  .shift-info {
    background: var(--night-shift);
    color: white;
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .shift-info .current-shift {
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  .shift-info .shift-time {
    font-size: 0.9rem;
    opacity: 0.9;
  }
  
  .card {
    padding: 25px 30px;
    border-bottom: 1px solid var(--border);
  }
  
  .card:last-child {
    border-bottom: none;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
  }
  
  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 128, 255, 0.1);
  }
  
  .button-group {
    display: flex;
    gap: 15px;
    margin-top: 25px;
  }
  
  button {
    flex: 1;
    padding: 16px;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn-primary {
    background-color: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(44, 128, 255, 0.3);
  }
  
  .btn-secondary {
    background-color: #f1f3f5;
    color: var(--dark);
  }
  
  .btn-secondary:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }
  
  .btn-success {
    background-color: var(--secondary);
    color: white;
  }
  
  .btn-success:hover {
    background-color: #30b352;
    transform: translateY(-2px);
  }
  
  .btn-warning {
    background-color: var(--warning);
    color: white;
  }
  
  .btn-warning:hover {
    background-color: #e08900;
    transform: translateY(-2px);
  }
  
  .btn-danger {
    background-color: var(--danger);
    color: white;
  }
  
  .btn-danger:hover {
    background-color: #e0352b;
    transform: translateY(-2px);
  }
  
  .btn-sm {
    padding: 8px 12px;
    font-size: 0.85rem;
  }
  
  .table-container {
    overflow-x: auto;
    margin-top: 10px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 5px;
  }
  
  th {
    background-color: #f8f9fa;
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    border-bottom: 2px solid var(--border);
  }
  
  td {
    padding: 14px 12px;
    border-bottom: 1px solid var(--border);
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  tr:hover {
    background-color: #f8fafc;
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
  }
  
  .empty-state p {
    margin-top: 10px;
  }
  
  .stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    flex: 1;
    min-width: 150px;
    background: #f8f9fa;
    border-radius: var(--radius);
    padding: 15px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }
  
  .stat-label {
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 5px;
  }
  
  .filter-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-group select {
    flex: 1;
    min-width: 200px;
  }
  
  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background: white;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    animation: modalFadeIn 0.3s ease-out;
  }
  
  .modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: between;
    align-items: center;
  }
  
  .modal-header h2 {
    font-size: 1.4rem;
  }
  
  .modal-body {
    padding: 25px;
  }
  
  .modal-footer {
    padding: 20px 25px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  .close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
    padding: 0;
    width: auto;
  }
  
  .close-modal:hover {
    color: var(--dark);
    transform: none;
  }
  
  /* Responsive styles */
  @media (max-width: 768px) {
    body {
      padding: 15px;
    }
    
    header {
      padding: 20px;
    }
    
    header h1 {
      font-size: 1.5rem;
    }
    
    .shift-info {
      padding: 15px 20px;
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
    }
    
    .card {
      padding: 20px;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .stats-container {
      flex-direction: column;
    }
    
    .filter-group {
      flex-direction: column;
    }
    
    .filter-group select {
      min-width: 100%;
    }
    
    th, td {
      padding: 12px 8px;
      font-size: 0.9rem;
    }
    
    table {
      min-width: 600px;
    }
    
    .modal-content {
      width: 95%;
    }
  }
  
  @media (max-width: 480px) {
    body {
      padding: 10px;
    }
    
    header {
      padding: 18px 15px;
    }
    
    header h1 {
      font-size: 1.3rem;
    }
    
    .card {
      padding: 18px 15px;
    }
    
    input, select {
      padding: 12px 14px;
    }
    
    button {
      padding: 14px;
    }
  }
  
  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  .fade-in {
    animation: fadeIn 0.4s ease-out;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
  }
  
  .badge-primary {
    background-color: var(--primary);
    color: white;
  }
  
  .badge-secondary {
    background-color: var(--secondary);
    color: white;
  }
  
  .badge-warning {
    background-color: var(--warning);
    color: white;
  }
  
  .badge-danger {
    background-color: var(--danger);
    color: white;
  }
  
  .action-buttons {
    display: flex;
    gap: 5px;
  }
  
  .form-row {
    display: flex;
    gap: 15px;
  }
  
  .form-row .form-group {
    flex: 1;
  }
  
  /* C√°c style m·ªõi cho ch·ª©c nƒÉng thay ƒë·ªïi tr·∫°ng th√°i nhanh */
  .status-toggle {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .status-toggle:hover {
    transform: scale(1.05);
  }
  
  .status-toggle-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--primary);
    color: white;
    padding: 12px 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    z-index: 1002;
    display: flex;
    align-items: center;
    gap: 10px;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
  }
  
  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }
  
  .toast.success {
    background: var(--secondary);
  }
  
  .toast.error {
    background: var(--danger);
  }
</style>
</head>
<body>
  <!-- Overlay cho sidebar -->
  <div class="overlay" id="sidebar-overlay"></div>
  
  <!-- Toast notification -->
  <div class="toast" id="toast">
    <span id="toast-message">ƒê√£ sao ch√©p v√†o clipboard!</span>
  </div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Menu</h2>
      <button class="close-sidebar" id="close-sidebar">&times;</button>
    </div>
    <div class="sidebar-content">
      <button class="sidebar-item" onclick="exportToText()">
        üìÑ Xu·∫•t d·ªØ li·ªáu vƒÉn b·∫£n
      </button>
      <button class="sidebar-item" onclick="openModal('help-modal')">
        ‚ùì Tr·ª£ gi√∫p
      </button>
      <button class="sidebar-item" onclick="resetForm()">
        üÜï T·∫°o m·ªõi
      </button>
      <button class="sidebar-item" onclick="taiDuLieu()">
        üîÑ T·∫£i l·∫°i d·ªØ li·ªáu
      </button>
    </div>
    <div class="sidebar-footer">
      <p>Qu·∫£n l√Ω ƒëi·ªÉm gas &copy; 2025</p>
    </div>
  </div>

  <div class="container">
    <header>
      <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
      <h1>üìã Qu·∫£n l√Ω ti·ªÅn thu ƒëi·ªÉm gas theo ca</h1>
      <p>Theo d√µi v√† qu·∫£n l√Ω thu chi t·∫°i c√°c ƒëi·ªÉm gas theo ca l√†m vi·ªác</p>
    </header>
    
    <div class="shift-info">
      <div class="current-shift" id="current-shift">ƒêang t·∫£i th√¥ng tin ca...</div>
      <div class="shift-time" id="shift-time"></div>
    </div>
    
    <div class="card">
      <div class="stats-container" id="stats-container">
        <!-- Th·ªëng k√™ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
      
      <div class="filter-group">
        <select id="filter-shift" onchange="filterByShift()">
          <option value="all">T·∫•t c·∫£ c√°c ca</option>
          <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </select>
        <select id="filter-diem" onchange="filterByDiem()">
          <option value="all">T·∫•t c·∫£ ƒëi·ªÉm gas</option>
          <!-- C√°c t√πy ch·ªçn ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </select>
        <select id="filter-trangthai" onchange="filterByTrangThai()">
          <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
          <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
        </select>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="chon_diem">Ch·ªçn ƒëi·ªÉm:</label>
          <select id="chon_diem" onchange="chonDiem()">
            <option value="">-- Ch·ªçn ƒëi·ªÉm --</option>
            <option value="new">‚ûï Th√™m ƒëi·ªÉm m·ªõi...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="trang_thai">Tr·∫°ng th√°i:</label>
          <select id="trang_thai">
            <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
            <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="ten_diem">T√™n ƒëi·ªÉm:</label>
        <input id="ten_diem" placeholder="Nh·∫≠p t√™n ƒëi·ªÉm (n·∫øu th√™m m·ªõi)">
      </div>
      
      <div class="form-group">
        <label for="so_tien">S·ªë ti·ªÅn:</label>
        <input id="so_tien" type="number" placeholder="Nh·∫≠p s·ªë ti·ªÅn">
      </div>
      
      <div class="form-group">
        <label for="dia_chi">ƒê·ªãa ch·ªâ:</label>
        <input id="dia_chi" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
      </div>
      
      <div class="form-group">
        <label for="ghi_chu">Ghi ch√∫:</label>
        <input id="ghi_chu" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)">
      </div>
      
      <div class="button-group">
        <button class="btn-primary" onclick="guiDuLieu()" id="btn-submit">
          üíæ L∆∞u th√¥ng tin
        </button>
        <button class="btn-secondary" onclick="taiDuLieu()">
          üîÑ T·∫£i l·∫°i
        </button>
        <button class="btn-warning" onclick="resetForm()" id="btn-cancel" style="display: none;">
          ‚ùå H·ªßy
        </button>
      </div>
    </div>
    
    <div class="card">
      <h2 style="margin-bottom: 15px;">üìä Danh s√°ch ƒëi·ªÉm gas theo ca</h2>
      <div class="table-container">
        <table id="bang">
          <thead>
            <tr>
              <th>T√™n ƒëi·ªÉm</th>
              <th>S·ªë ti·ªÅn</th>
              <th>ƒê·ªãa ch·ªâ</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ca</th>
              <th>Th·ªùi gian</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </tbody>
        </table>
        <div id="empty-state" class="empty-state" style="display: none;">
          <h3>üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
          <p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal x√°c nh·∫≠n x√≥a -->
  <div class="modal" id="delete-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>X√°c nh·∫≠n x√≥a</h2>
        <button class="close-modal" onclick="closeModal('delete-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒëi·ªÉm gas n√†y?</p>
        <p id="delete-item-info" style="font-weight: bold; margin-top: 10px;"></p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('delete-modal')">H·ªßy</button>
        <button class="btn-danger" onclick="confirmDelete()">X√≥a</button>
      </div>
    </div>
  </div>

  <!-- Modal tr·ª£ gi√∫p -->
  <div class="modal" id="help-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Tr·ª£ gi√∫p</h2>
        <button class="close-modal" onclick="closeModal('help-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <h3>C√°ch s·ª≠ d·ª•ng:</h3>
        <ul style="margin-left: 20px; margin-top: 10px;">
          <li>Ch·ªçn ƒëi·ªÉm gas t·ª´ danh s√°ch ho·∫∑c th√™m m·ªõi</li>
          <li>Nh·∫≠p s·ªë ti·ªÅn thu ƒë∆∞·ª£c (c√≥ th·ªÉ nh·∫≠p s·ªë v√† th√™m '000' t·ª± ƒë·ªông)</li>
          <li>Ch·ªçn tr·∫°ng th√°i ƒë√£ n·ªôp ho·∫∑c ch∆∞a n·ªôp</li>
          <li>Nh·∫•n "L∆∞u th√¥ng tin" ƒë·ªÉ l∆∞u d·ªØ li·ªáu</li>
          <li>Xu·∫•t d·ªØ li·ªáu vƒÉn b·∫£n t·ª´ menu ƒë·ªÉ chia s·∫ª ho·∫∑c in ·∫•n</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" onclick="closeModal('help-modal')">ƒê√≥ng</button>
      </div>
    </div>
  </div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbyRnnoEd2BnD7u1pXHER17Cv95BN9Z77yUeO6oR7CFRtbUqd-SiVJqBv5ENYyARwX77fw/exec';
let cacheDiem = {};
let allData = [];
let currentShift = '';
let editingId = null;
let itemToDelete = null;
let currentFilteredData = [];

// H√†m hi·ªÉn th·ªã th√¥ng b√°o toast
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  
  toastMessage.textContent = message;
  toast.className = `toast ${type} show`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// H√†m sao ch√©p v√†o clipboard
async function copyToClipboard(text) {
  try {
    // S·ª≠ d·ª•ng Clipboard API hi·ªán ƒë·∫°i
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return true;
    } else {
      // Fallback cho c√°c tr√¨nh duy·ªát c≈© ho·∫∑c kh√¥ng h·ªó tr·ª£
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textArea);
      return success;
    }
  } catch (err) {
    console.error('L·ªói khi sao ch√©p v√†o clipboard: ', err);
    return false;
  }
}

// H√†m m·ªü/ƒë√≥ng sidebar
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
}

// ƒê√≥ng sidebar
function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
}

// H√†m xu·∫•t d·ªØ li·ªáu d·∫°ng vƒÉn b·∫£n
async function exportToText() {
  closeSidebar();
  
  // L·∫•y d·ªØ li·ªáu ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã (ƒë√£ l·ªçc)
  const dataToExport = currentFilteredData.length > 0 ? currentFilteredData : allData;
  
  if (dataToExport.length === 0) {
    showToast('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
    return;
  }
  
  // T·∫°o n·ªôi dung vƒÉn b·∫£n theo m·∫´u "ƒëi·ªÉm A - 311000"
  let content = '';
  dataToExport.forEach(item => {
    // ƒê·ªãnh d·∫°ng: "ƒëi·ªÉm A - 311000"
    content += `${item.ten_diem} - ${item.so_tien}\n`;
  });
  
  // T·∫°o blob v√† t·∫£i xu·ªëng
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const link = document.createElement('a');
  
  // L·∫•y th√¥ng tin ca hi·ªán t·∫°i ƒë·ªÉ ƒë·∫∑t t√™n file
  const shiftInfo = getCurrentShift();
  const fileName = shiftInfo.shiftKey ? `diem_gas_${shiftInfo.shiftKey}.txt` : `diem_gas_${new Date().toISOString().slice(0,10)}.txt`;
  
  link.download = fileName;
  link.href = URL.createObjectURL(blob);
  link.click();
  
  // Gi·∫£i ph√≥ng URL
  URL.revokeObjectURL(link.href);
  
  // Sao ch√©p n·ªôi dung v√†o clipboard
  const copySuccess = await copyToClipboard(content);
  
  if (copySuccess) {
    showToast('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu v√† sao ch√©p v√†o clipboard!');
  } else {
    showToast('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu, nh∆∞ng kh√¥ng th·ªÉ sao ch√©p v√†o clipboard', 'error');
  }
}

// X·ª≠ l√Ω nh·∫≠p nhanh s·ªë ti·ªÅn h√†ng ng√†n
document.getElementById('so_tien').addEventListener('blur', function() {
  let value = this.value.trim();
  
  // N·∫øu gi√° tr·ªã nh·∫≠p v√†o l√† s·ªë v√† c√≥ √≠t h∆°n 4 ch·ªØ s·ªë
  if (/^\d+$/.test(value) && value.length > 0 && value.length <= 3) {
    // Th√™m "000" v√†o cu·ªëi
    this.value = value + '000';
  }
});

// H√†m x√°c ƒë·ªãnh ca hi·ªán t·∫°i (18h30 h√¥m nay ƒë·∫øn 6h30 s√°ng h√¥m sau)
function getCurrentShift() {
  const now = new Date();
  const currentHour = now.getHours();
  const currentMinutes = now.getMinutes();
  
  // T√≠nh to√°n th·ªùi gian b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c ca
  let shiftStart = new Date(now);
  let shiftEnd = new Date(now);
  
  // N·∫øu tr∆∞·ªõc 6h30, ca thu·ªôc v·ªÅ ng√†y h√¥m tr∆∞·ªõc
  if (currentHour < 6 || (currentHour === 6 && currentMinutes < 30)) {
    shiftStart.setDate(shiftStart.getDate() - 1);
    shiftStart.setHours(18, 30, 0, 0);
    shiftEnd.setHours(6, 30, 0, 0);
  } 
  // N·∫øu sau 18h30, ca thu·ªôc v·ªÅ ng√†y h√¥m nay
  else if (currentHour > 18 || (currentHour === 18 && currentMinutes >= 30)) {
    shiftStart.setHours(18, 30, 0, 0);
    shiftEnd.setDate(shiftEnd.getDate() + 1);
    shiftEnd.setHours(6, 30, 0, 0);
  }
  // N·∫øu trong kho·∫£ng 6h30 ƒë·∫øn 18h30, kh√¥ng thu·ªôc ca n√†o
  else {
    return {
      shift: 'Ngo√†i ca l√†m vi·ªác',
      start: null,
      end: null
    };
  }
  
  // ƒê·ªãnh d·∫°ng ng√†y th√°ng
  const formatDate = (date) => {
    return date.toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };
  
  const shiftKey = shiftStart.toISOString().split('T')[0];
  
  return {
    shift: `Ca ${formatDate(shiftStart).split(' ')[0]}`,
    shiftKey: shiftKey,
    start: formatDate(shiftStart),
    end: formatDate(shiftEnd)
  };
}

// C·∫≠p nh·∫≠t th√¥ng tin ca hi·ªán t·∫°i
function updateShiftInfo() {
  const shiftInfo = getCurrentShift();
  currentShift = shiftInfo.shiftKey;
  
  document.getElementById('current-shift').textContent = shiftInfo.shift;
  
  if (shiftInfo.start && shiftInfo.end) {
    document.getElementById('shift-time').textContent = 
      `‚è∞ ${shiftInfo.start} - ${shiftInfo.end}`;
  } else {
    document.getElementById('shift-time').textContent = 
      '‚è∞ Hi·ªán t·∫°i kh√¥ng trong ca l√†m vi·ªác';
  }
}

// ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
function formatCurrency(amount) {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND'
  }).format(amount);
}

// T√≠nh to√°n th·ªëng k√™
function calculateStats(data) {
  const stats = {
    total: 0,
    count: data.length,
    shifts: new Set(),
    diem: new Set(),
    daNop: 0,
    chuaNop: 0
  };
  
  data.forEach(item => {
    stats.total += parseInt(item.so_tien) || 0;
    if (item.ca) stats.shifts.add(item.ca);
    if (item.ten_diem) stats.diem.add(item.ten_diem);
    if (item.trang_thai === 'ƒê√£ n·ªôp') {
      stats.daNop++;
    } else {
      stats.chuaNop++;
    }
  });
  
  return stats;
}

// Hi·ªÉn th·ªã th·ªëng k√™
function displayStats(stats) {
  const container = document.getElementById('stats-container');
  
  container.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.count}</div>
      <div class="stat-label">S·ªë giao d·ªãch</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${formatCurrency(stats.total)}</div>
      <div class="stat-label">T·ªïng ti·ªÅn</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.daNop}/${stats.chuaNop}</div>
      <div class="stat-label">ƒê√£ n·ªôp/Ch∆∞a n·ªôp</div>
    </div>
  `;
}

// L·ªçc d·ªØ li·ªáu theo ca
function filterByShift() {
  filterData();
}

// L·ªçc d·ªØ li·ªáu theo ƒëi·ªÉm
function filterByDiem() {
  filterData();
}

// L·ªçc d·ªØ li·ªáu theo tr·∫°ng th√°i
function filterByTrangThai() {
  filterData();
}

// L·ªçc v√† hi·ªÉn th·ªã d·ªØ li·ªáu
function filterData() {
  const shiftFilter = document.getElementById('filter-shift').value;
  const diemFilter = document.getElementById('filter-diem').value;
  const trangThaiFilter = document.getElementById('filter-trangthai').value;
  
  let filteredData = allData;
  
  if (shiftFilter !== 'all') {
    filteredData = filteredData.filter(item => item.ca === shiftFilter);
  }
  
  if (diemFilter !== 'all') {
    filteredData = filteredData.filter(item => item.ten_diem === diemFilter);
  }
  
  if (trangThaiFilter !== 'all') {
    filteredData = filteredData.filter(item => item.trang_thai === trangThaiFilter);
  }

  // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c currentFilteredData
  currentFilteredData = filteredData;

  // N·∫øu ƒëang ch·ªçn ca hi·ªán t·∫°i v√† kh√¥ng c√≥ d·ªØ li·ªáu, hi·ªÉn th·ªã th√¥ng b√°o ƒë·∫∑c bi·ªát
  const shiftInfo = getCurrentShift();
  if (shiftFilter === shiftInfo.shiftKey && shiftInfo.start && filteredData.length === 0) {
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('empty-state').innerHTML = '<h3>üì≠ Ch∆∞a c√≥ ƒëi·ªÉm n√†o trong ca hi·ªán t·∫°i</h3><p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>';
  } else {
    document.getElementById('empty-state').innerHTML = '<h3>üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu</h3><p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>';
  }

  displayData(filteredData);
  displayStats(calculateStats(filteredData));
}

// Hi·ªÉn th·ªã d·ªØ li·ªáu trong b·∫£ng
function displayData(data) {
  const tbody = document.querySelector('#bang tbody');
  tbody.innerHTML = '';
  
  // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
  const emptyState = document.getElementById('empty-state');
  if (data.length === 0) {
    emptyState.style.display = 'block';
  } else {
    emptyState.style.display = 'none';
  }
  
  data.forEach(row => {
    const tr = document.createElement('tr');
    tr.className = 'fade-in';
    
    // X√°c ƒë·ªãnh badge class d·ª±a tr√™n tr·∫°ng th√°i
    let badgeClass = 'badge-warning';
    if (row.trang_thai === 'ƒê√£ n·ªôp') {
      badgeClass = 'badge-secondary';
    }
    
    tr.innerHTML = `
      <td data-label="T√™n ƒëi·ªÉm">${row.ten_diem}</td>
      <td data-label="S·ªë ti·ªÅn">${formatCurrency(row.so_tien)}</td>
      <td data-label="ƒê·ªãa ch·ªâ">${row.dia_chi}</td>
      <td data-label="Tr·∫°ng th√°i">
        <div class="status-toggle-wrapper">
          <span class="badge ${badgeClass} status-toggle" onclick="toggleTrangThai('${row.id}')">${row.trang_thai || 'Ch∆∞a n·ªôp'}</span>
        </div>
      </td>
      <td data-label="Ca"><span class="badge badge-primary">${row.ca || 'Kh√¥ng x√°c ƒë·ªãnh'}</span></td>
      <td data-label="Th·ªùi gian">${row.timestamp ? new Date(row.timestamp).toLocaleString('vi-VN') : 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
      <td data-label="Thao t√°c">
        <div class="action-buttons">
          <button class="btn-secondary btn-sm" onclick="editItem('${row.id}')">‚úèÔ∏è S·ª≠a</button>
          <button class="btn-danger btn-sm" onclick="deleteItem('${row.id}')">üóëÔ∏è X√≥a</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// H√†m thay ƒë·ªïi tr·∫°ng th√°i nhanh
function toggleTrangThai(id) {
  const item = allData.find(item => item.id === id);
  if (!item) return;

  const newTrangThai = item.trang_thai === 'ƒê√£ n·ªôp' ? 'Ch∆∞a n·ªôp' : 'ƒê√£ n·ªôp';

  // T√¨m ph·∫ßn t·ª≠ badge ƒë·ªÉ c·∫≠p nh·∫≠t tr·ª±c ti·∫øp (cho UX t·ªët h∆°n)
  const badgeElement = document.querySelector(`[onclick="toggleTrangThai('${id}')"]`);
  if (badgeElement) {
    badgeElement.textContent = newTrangThai;
    badgeElement.className = `badge ${newTrangThai === 'ƒê√£ n·ªôp' ? 'badge-secondary' : 'badge-warning'} status-toggle`;
  }

  // T·∫°o m·ªôt b·∫£n sao c·ªßa item v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi
  const updatedItem = { ...item, trang_thai: newTrangThai };

  // G·ª≠i to√†n b·ªô d·ªØ li·ªáu c·ªßa m·ª•c ƒë√≥ ƒë·ªÉ c·∫≠p nh·∫≠t
  const data = {
    action: 'update',
    ...updatedItem
  };

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'success') {
      // Kh√¥ng c·∫ßn alert n·ªØa v√¨ ƒë√£ c·∫≠p nh·∫≠t tr·ª±c ti·∫øp giao di·ªán
      console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!');
      // C·∫≠p nh·∫≠t d·ªØ li·ªáu trong b·ªô nh·ªõ
      const index = allData.findIndex(item => item.id === id);
      if (index !== -1) {
        allData[index].trang_thai = newTrangThai;
      }
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'error');
      // Kh√¥i ph·ª•c tr·∫°ng th√°i c≈© n·∫øu c√≥ l·ªói
      taiDuLieu();
    }
  })
  .catch(error => {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'error');
    console.error(error);
    // Kh√¥i ph·ª•c tr·∫°ng th√°i c≈© n·∫øu c√≥ l·ªói
    taiDuLieu();
  });
}

// C·∫≠p nh·∫≠t b·ªô l·ªçc
function updateFilters(data) {
  const shifts = new Set();
  const diems = new Set();
  
  data.forEach(item => {
    if (item.ca) shifts.add(item.ca);
    if (item.ten_diem) diems.add(item.ten_diem);
  });
  
  // C·∫≠p nh·∫≠t b·ªô l·ªçc ca
  const shiftFilter = document.getElementById('filter-shift');
  shiftFilter.innerHTML = '<option value="all">T·∫•t c·∫£ c√°c ca</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = `Ca ${shift}`;
    shiftFilter.appendChild(option);
  });
  
  // C·∫≠p nh·∫≠t b·ªô l·ªçc ƒëi·ªÉm
  const diemFilter = document.getElementById('filter-diem');
  diemFilter.innerHTML = '<option value="all">T·∫•t c·∫£ ƒëi·ªÉm gas</option>';
  
  Array.from(diems).sort().forEach(diem => {
    const option = document.createElement('option');
    option.value = diem;
    option.textContent = diem;
    diemFilter.appendChild(option);
  });
}

// Reset form
function resetForm() {
  closeSidebar();
  editingId = null;
  document.getElementById('chon_diem').value = '';
  document.getElementById('ten_diem').value = '';
  document.getElementById('ten_diem').disabled = false;
  document.getElementById('so_tien').value = '';
  document.getElementById('dia_chi').value = '';
  document.getElementById('ghi_chu').value = '';
  document.getElementById('trang_thai').value = 'Ch∆∞a n·ªôp';
  document.getElementById('btn-submit').textContent = 'üíæ L∆∞u th√¥ng tin';
  document.getElementById('btn-cancel').style.display = 'none';
}

// Ch·ªânh s·ª≠a item
function editItem(id) {
  const item = allData.find(item => item.id === id);
  if (!item) return;
  
  editingId = id;
  
  // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
  document.getElementById('chon_diem').value = item.ten_diem;
  document.getElementById('ten_diem').value = item.ten_diem;
  document.getElementById('ten_diem').disabled = true;
  document.getElementById('so_tien').value = item.so_tien;
  document.getElementById('dia_chi').value = item.dia_chi;
  document.getElementById('ghi_chu').value = item.ghi_chu || '';
  document.getElementById('trang_thai').value = item.trang_thai || 'Ch∆∞a n·ªôp';
  
  // Thay ƒë·ªïi n√∫t th√†nh c·∫≠p nh·∫≠t
  document.getElementById('btn-submit').textContent = 'üíæ C·∫≠p nh·∫≠t';
  document.getElementById('btn-cancel').style.display = 'block';
  
  // Cu·ªôn l√™n ƒë·∫ßu form
  document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

// X√≥a item
function deleteItem(id) {
  const item = allData.find(item => item.id === id);
  if (!item) return;
  
  itemToDelete = id;
  document.getElementById('delete-item-info').textContent = 
    `${item.ten_diem} - ${formatCurrency(item.so_tien)} - ${item.dia_chi}`;
  
  openModal('delete-modal');
}

// X√°c nh·∫≠n x√≥a
function confirmDelete() {
  if (!itemToDelete) return;
  
  const data = { 
    action: 'delete',
    id: itemToDelete
  };

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'success') {
      showToast('‚úÖ ƒê√£ x√≥a th√†nh c√¥ng!');
      closeModal('delete-modal');
      taiDuLieu();
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a!', 'error');
    }
  })
  .catch(error => {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a!', 'error');
    console.error(error);
  });
}

// M·ªü modal
function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

// ƒê√≥ng modal
function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

async function guiDuLieu() {
  const ten_diem = document.getElementById('ten_diem').value || document.getElementById('chon_diem').value;
  const so_tien = document.getElementById('so_tien').value;
  const dia_chi = document.getElementById('dia_chi').value;
  const ghi_chu = document.getElementById('ghi_chu').value;
  const trang_thai = document.getElementById('trang_thai').value;

  if (!ten_diem || !so_tien || !dia_chi) {
    showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
    return;
  }

  // Ki·ªÉm tra xem c√≥ ƒëang trong ca l√†m vi·ªác kh√¥ng (ch·ªâ ki·ªÉm tra khi th√™m m·ªõi)
  if (!editingId) {
    const shiftInfo = getCurrentShift();
    if (!shiftInfo.start) {
      showToast('‚ö†Ô∏è Hi·ªán t·∫°i kh√¥ng trong ca l√†m vi·ªác! Ca l√†m vi·ªác t·ª´ 18:30 ƒë·∫øn 6:30 s√°ng h√¥m sau.', 'error');
      return;
    }
  }

  const data = { 
    ten_diem, 
    so_tien, 
    dia_chi,
    ghi_chu,
    trang_thai,
    ca: editingId ? undefined : getCurrentShift().shiftKey, // Gi·ªØ nguy√™n ca c≈© khi ch·ªânh s·ª≠a
    timestamp: editingId ? undefined : new Date().toISOString(), // Gi·ªØ nguy√™n timestamp khi ch·ªânh s·ª≠a
    id: editingId || undefined // G·ª≠i ID n·∫øu ƒëang ch·ªânh s·ª≠a
  };

  // Th√™m action ƒë·ªÉ x√°c ƒë·ªãnh h√†nh ƒë·ªông
  if (editingId) {
    data.action = 'update';
  }

  try {
    const response = await fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify(data)
    });
    const result = await response.json();
    
    if (result.result === 'success') {
      showToast(editingId ? '‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!' : '‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
      resetForm();
      taiDuLieu();
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!', 'error');
    }
  } catch (error) {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!', 'error');
    console.error(error);
  }
}

async function taiDuLieu() {
  try {
    const res = await fetch(scriptURL);
    const data = await res.json();
    allData = data;
    currentFilteredData = data;
    
    const select = document.getElementById('chon_diem');
    select.innerHTML = '<option value="">-- Ch·ªçn ƒëi·ªÉm --</option><option value="new">‚ûï Th√™m ƒëi·ªÉm m·ªõi...</option>';
    cacheDiem = {};

    data.forEach(row => {
      const ten = row.ten_diem;
      const diachi = row.dia_chi;
      cacheDiem[ten] = diachi;

      // Th√™m v√†o danh s√°ch ch·ªçn n·∫øu ch∆∞a c√≥
      if (![...select.options].some(o => o.value === ten)) {
        const opt = document.createElement('option');
        opt.value = ten;
        opt.textContent = ten;
        select.appendChild(opt);
      }
    });

    // Hi·ªÉn th·ªã d·ªØ li·ªáu
    displayData(data);
    displayStats(calculateStats(data));
    updateFilters(data);
    
  } catch (error) {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu!', 'error');
    console.error(error);
  }
}

function chonDiem() {
  const val = document.getElementById('chon_diem').value;
  const tenDiemInput = document.getElementById('ten_diem');
  const diaChiInput = document.getElementById('dia_chi');
  
  if (val === 'new' || val === '') {
    tenDiemInput.value = '';
    diaChiInput.value = '';
    tenDiemInput.disabled = false;
    tenDiemInput.placeholder = "Nh·∫≠p t√™n ƒëi·ªÉm (n·∫øu th√™m m·ªõi)";
  } else {
    tenDiemInput.value = val;
    diaChiInput.value = cacheDiem[val] || '';
    tenDiemInput.disabled = true;
    tenDiemInput.placeholder = "T√™n ƒëi·ªÉm ƒë√£ ch·ªçn";
  }
}

// Kh·ªüi t·∫°o
// Khi load trang, m·∫∑c ƒë·ªãnh ch·ªçn ca hi·ªán t·∫°i n·∫øu c√≥, n·∫øu kh√¥ng th√¨ ch·ªçn "T·∫•t c·∫£ c√°c ca"
document.addEventListener('DOMContentLoaded', function() {
  updateShiftInfo();
  taiDuLieu().then(() => {
    const shiftInfo = getCurrentShift();
    const shiftFilter = document.getElementById('filter-shift');
    if (shiftInfo.start) {
      // N·∫øu ƒëang trong ca, ch·ªçn ca hi·ªán t·∫°i
      shiftFilter.value = shiftInfo.shiftKey;
    } else {
      // N·∫øu kh√¥ng trong ca, ch·ªçn t·∫•t c·∫£ c√°c ca
      shiftFilter.value = 'all';
    }
    filterData();
  });
  
  // Th√™m s·ª± ki·ªán cho n√∫t menu v√† ƒë√≥ng sidebar
  document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
  document.getElementById('close-sidebar').addEventListener('click', closeSidebar);
  document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);
  
  // C·∫≠p nh·∫≠t th√¥ng tin ca m·ªói ph√∫t
  setInterval(updateShiftInfo, 60000);
});
</script>
</body>
</html>