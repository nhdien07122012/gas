<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Qu·∫£n l√Ω giao gas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; max-width: 760px; margin: 18px auto; padding: 18px; background:#f4f6f9; color:#2c3e50; }
    h2 { text-align:center; color:#34495e; }
    .card { background:#fff; border-radius:10px; padding:18px; margin:14px 0; box-shadow:0 3px 8px rgba(0,0,0,0.08); }
    label { display:block; margin-top:8px; color:#444; }
    input, button { padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px; width:100%; box-sizing:border-box; }
    button { background:#3498db; color:#fff; cursor:pointer; font-weight:600; border:none; }
    button:hover { background:#2980b9; }
    .btn-secondary { background:#95a5a6; color:#fff; }
    .record { border-bottom:1px solid #eee; padding:8px 0; }
    strong.total { display:block; margin-top:10px; font-size:16px; color:#e74c3c; }
    .empty { color:#7f8c8d; font-style:italic; }
  </style>
</head>
<body>
  <h2>üìí Qu·∫£n l√Ω giao gas</h2>

  <div class="card">
    <h3>‚ûï Th√™m giao d·ªãch</h3>
    <label>Ng√†y</label>
    <input type="date" id="dateInput">
    <label>ƒê·ªãa ƒëi·ªÉm</label>
    <input type="text" id="locationInput" placeholder="V√≠ d·ª•: Cafe Kim Ph∆∞·ª£ng">
    <label>S·ªë ti·ªÅn (VNƒê)</label>
    <input type="number" id="amountInput" placeholder="V√≠ d·ª•: 327000">
    <button id="saveBtn">üíæ L∆∞u</button>
  </div>

  <div class="card">
    <h3>üìä Xem d·ªØ li·ªáu theo ng√†y</h3>
    <label>Ch·ªçn ng√†y</label>
    <input type="date" id="viewDate">
    <button id="viewBtn">üîç Xem</button>
    <button id="yesterdayBtn" class="btn-secondary">üìÖ H√¥m qua</button>
    <div id="result" style="margin-top:12px"></div>
  </div>

<script>
/* ============ THAY API_URL B·∫∞NG LINK WEB APP =========== */
const API_URL = "https://script.google.com/macros/s/AKfycbx7IqZ5rS0lYzNuBTssmKAhbvBtu0IYomm0dE_uF12hoCaW_yQmxYwiJtBSI-4it7qi/exec";

/* JSONP helper */
function jsonpRequest(url, onSuccess, onError, timeout = 12000) {
  var cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*10000);
  window[cbName] = function(data) {
    clearTimeout(timer);
    cleanup();
    onSuccess && onSuccess(data);
  };
  function cleanup() {
    try { delete window[cbName]; } catch(e) { window[cbName] = undefined; }
    if (script.parentNode) script.parentNode.removeChild(script);
  }
  var script = document.createElement('script');
  script.src = url + (url.indexOf('?') === -1 ? '?' : '&') + 'callback=' + cbName;
  script.onerror = function() {
    clearTimeout(timer);
    cleanup();
    onError && onError(new Error('Network/script error'));
  };
  document.head.appendChild(script);
  var timer = setTimeout(function() {
    cleanup();
    onError && onError(new Error('Timeout'));
  }, timeout);
  return { cancel: cleanup };
}

function showAlert(msg) { alert(msg); }

/* Auto set today */
window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateInput').value = today;
  document.getElementById('viewDate').value = today;
};

/* Add record */
document.getElementById('saveBtn').addEventListener('click', function(){
  const date = document.getElementById('dateInput').value;
  const location = document.getElementById('locationInput').value.trim();
  const amount = document.getElementById('amountInput').value;
  if (!date || !location || !amount) { showAlert('Vui l√≤ng nh·∫≠p ƒë·ªß d·ªØ li·ªáu'); return; }

  const url = API_URL + '?action=add&date=' + encodeURIComponent(date)
            + '&location=' + encodeURIComponent(location)
            + '&amount=' + encodeURIComponent(amount);

  jsonpRequest(url,
    function(data){
      if (data && data.status === 'success') {
        showAlert('L∆∞u th√†nh c√¥ng ‚úÖ');
        document.getElementById('locationInput').value = '';
        document.getElementById('amountInput').value = '';
      } else {
        showAlert('L∆∞u th·∫•t b·∫°i: ' + JSON.stringify(data));
      }
    },
    function(err){
      console.error(err);
      showAlert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi API');
    }
  );
});

/* Get records */
document.getElementById('viewBtn').addEventListener('click', getRecords);
document.getElementById('yesterdayBtn').addEventListener('click', function(){
  const d = new Date();
  d.setDate(d.getDate() - 1);
  document.getElementById('viewDate').value = d.toISOString().split('T')[0];
  getRecords();
});

function getRecords() {
  const date = document.getElementById('viewDate').value;
  if (!date) { showAlert('Ch·ªçn ng√†y tr∆∞·ªõc'); return; }

  const url = API_URL + '?action=get&date=' + encodeURIComponent(date);

  jsonpRequest(url,
    function(data){
      const out = document.getElementById('result');
      let html = '<h4>K·∫øt qu·∫£ ng√†y ' + date + '</h4>';
      if (!data || !data.records || data.records.length === 0) {
        html += '<p class="empty">‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
      } else {
        data.records.forEach(function(r){
          var location = r[1] || '';
          var amount = Number(r[2]) || 0;
          html += '<div class="record">üìç ' + escapeHtml(location) + ' - üí∞ ' + amount.toLocaleString() + ' VNƒê</div>';
        });
        html += '<strong class="total">T·ªïng: ' + (Number(data.total)||0).toLocaleString() + ' VNƒê</strong>';
      }
      out.innerHTML = html;
    },
    function(err){
      console.error(err);
      showAlert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi API');
    }
  );
}

/* Escape HTML */
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
</script>
</body>
</html>
