<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T√≠nh c√¥ng v√† l∆∞∆°ng</title>
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="apple-touch-icon-precomposed" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="T√≠nh c√¥ng l∆∞∆°ng">
<style>
  :root {
    --primary: #2c80ff;
    --primary-dark: #1a6de0;
    --secondary: #34c759;
    --danger: #ff3b30;
    --warning: #ff9500;
    --light: #f8f9fa;
    --dark: #333;
    --gray: #6c757d;
    --border: #dee2e6;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
    --radius: 10px;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
    overflow-x: hidden;
  }
  
  .container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    position: relative;
    z-index: 1;
  }
  
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 25px 30px;
    text-align: center;
    position: relative;
  }
  
  header h1 {
    font-size: 1.8rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  header p {
    opacity: 0.9;
    font-size: 1rem;
  }
  
  .card {
    padding: 25px 30px;
    border-bottom: 1px solid var(--border);
  }
  
  .card:last-child {
    border-bottom: none;
  }
  
  /* PH·∫¶N T·ªîNG L∆Ø∆†NG T·∫†M T√çNH ·ªû ƒê·∫¶U */
  .salary-preview {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 25px;
    text-align: center;
    border-left: 5px solid var(--secondary);
    display: none;
  }
  
  .salary-preview.show {
    display: block;
    animation: fadeIn 0.5s ease-out;
  }
  
  .salary-preview h3 {
    font-size: 1rem;
    color: var(--gray);
    margin-bottom: 10px;
    font-weight: 600;
  }
  
  .preview-amount {
    font-size: 2.2rem;
    font-weight: 800;
    color: var(--secondary);
    margin: 10px 0;
  }
  
  .preview-time {
    font-size: 0.9rem;
    color: var(--gray);
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
  }
  
  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 128, 255, 0.1);
  }
  
  .button-group {
    display: flex;
    gap: 15px;
    margin-top: 25px;
  }
  
  button {
    flex: 1;
    padding: 16px;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn-primary {
    background-color: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(44, 128, 255, 0.3);
  }
  
  .btn-secondary {
    background-color: #f1f3f5;
    color: var(--dark);
  }
  
  .btn-secondary:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }
  
  .btn-warning {
    background-color: var(--warning);
    color: white;
  }
  
  .btn-warning:hover {
    background-color: #e68a00;
    transform: translateY(-2px);
  }
  
  .btn-success {
    background-color: var(--secondary);
    color: white;
  }
  
  .btn-success:hover {
    background-color: #30b352;
    transform: translateY(-2px);
  }
  
  .btn-info {
    background-color: #5ac8fa;
    color: white;
  }
  
  .btn-info:hover {
    background-color: #4ab8ea;
    transform: translateY(-2px);
  }
  
  .stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    flex: 1;
    min-width: 150px;
    background: #f8f9fa;
    border-radius: var(--radius);
    padding: 15px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }
  
  .stat-label {
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 5px;
  }
  
  .table-container {
    overflow-x: auto;
    margin-top: 10px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 5px;
  }
  
  th {
    background-color: #f8f9fa;
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    border-bottom: 2px solid var(--border);
  }
  
  td {
    padding: 14px 12px;
    border-bottom: 1px solid var(--border);
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
  }
  
  .empty-state p {
    margin-top: 10px;
  }
  
  .salary-summary {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: var(--radius);
    padding: 25px;
    margin: 20px 0;
    text-align: center;
    border-left: 5px solid var(--secondary);
  }
  
  .salary-amount {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--secondary);
    margin: 15px 0;
  }
  
  .salary-breakdown {
    margin-top: 20px;
    padding: 15px;
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    text-align: left;
  }
  
  /* HI·ªÜU ·ª®NG TI·ªÄN/V√ÄNG R∆†I */
  .money-rain {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
    overflow: hidden;
  }
  
  .money-particle {
    position: absolute;
    font-size: 24px;
    user-select: none;
    pointer-events: none;
    opacity: 0;
    animation: moneyFall linear forwards;
  }
  
  @keyframes moneyFall {
    0% {
      transform: translateY(-100px) rotate(0deg);
      opacity: 0;
    }
    10% {
      opacity: 1;
    }
    90% {
      opacity: 1;
    }
    100% {
      transform: translateY(100vh) rotate(360deg);
      opacity: 0;
    }
  }
  
  .toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) translateY(100px);
    background: var(--primary);
    color: white;
    padding: 16px 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    z-index: 1002;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transition: all 0.3s ease;
    min-width: 280px;
    text-align: center;
    justify-content: center;
  }

  .toast.show {
    transform: translate(-50%, -50%) translateY(0);
    opacity: 1;
  }
  
  .toast.success {
    background: var(--secondary);
  }
  
  .toast.error {
    background: var(--danger);
  }
  
  .toast.warning {
    background: var(--warning);
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .fade-in {
    animation: fadeIn 0.4s ease-out;
  }
  
  @media (max-width: 768px) {
    body { padding: 15px; }
    header { padding: 20px; }
    header h1 { font-size: 1.5rem; }
    .card { padding: 20px; }
    .button-group { flex-direction: column; }
    .stats-container { flex-direction: column; }
    .salary-amount { font-size: 2rem; }
    .preview-amount { font-size: 1.8rem; }
    th, td { padding: 12px 8px; font-size: 0.9rem; }
    .money-particle { font-size: 20px; }
  }
</style>
</head>
<body>
  <!-- Container cho hi·ªáu ·ª©ng ti·ªÅn r∆°i -->
  <div class="money-rain" id="money-rain"></div>
  
  <div class="toast" id="toast">
    <span id="toast-message">ƒê√£ sao ch√©p v√†o clipboard!</span>
  </div>

  <div class="container">
    <header>
      <a href="index.html" style="position: absolute; left: 30px; top: 30px; color: white; text-decoration: none; font-size: 1.2rem;">‚Üê</a>
      <h1>üí∞ T√≠nh c√¥ng v√† l∆∞∆°ng</h1>
      <p>T√≠nh l∆∞∆°ng d·ª±a tr√™n s·ªë ca l√†m vi·ªác th·ª±c t·∫ø</p>
    </header>
    
    <div class="card">
      <!-- PH·∫¶N T·ªîNG L∆Ø∆†NG T·∫†M T√çNH - ƒê√É DI CHUY·ªÇN L√äN ƒê·∫¶U -->
      <div class="salary-preview" id="salary-preview">
        <h3>T·ªïng l∆∞∆°ng t·∫°m t√≠nh</h3>
        <div class="preview-amount" id="preview-amount">0 ƒë</div>
        <p class="preview-time" id="preview-time">Th·ªùi gian t√≠nh: </p>
      </div>
      
      <div class="form-group">
        <label for="luong-thang">L∆∞∆°ng th√°ng (VND):</label>
        <input type="number" id="luong-thang" value="5500000" placeholder="Nh·∫≠p l∆∞∆°ng th√°ng">
      </div>
      
      <div class="form-group">
        <label for="ngay-bat-dau">Chu k·ª≥ l∆∞∆°ng (t·ª´ ng√†y):</label>
        <div style="display: flex; gap: 10px;">
          <select id="ngay-bat-dau" style="flex: 1;">
            <option value="5" selected>Ng√†y 05</option>
            <option value="1">Ng√†y 01</option>
            <option value="10">Ng√†y 10</option>
            <option value="15">Ng√†y 15</option>
            <option value="20">Ng√†y 20</option>
            <option value="25">Ng√†y 25</option>
            <option value="28">Ng√†y 28</option>
          </select>
          <select id="thang-bat-dau" style="flex: 1;">
            <!-- Th√°ng s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
          <select id="nam-bat-dau" style="flex: 1;">
            <!-- NƒÉm s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
          <i>L∆∞∆°ng ƒë∆∞·ª£c t√≠nh t·ª´ ng√†y X th√°ng n√†y ƒë·∫øn ng√†y X th√°ng sau (30 ng√†y)</i>
        </p>
      </div>
      
      <div class="button-group">
        <button class="btn-primary" onclick="tinhLuong()" id="btn-tinh-luong">
          üßÆ T√≠nh l∆∞∆°ng
        </button>
        <button class="btn-info" onclick="autoFillLastCycle()">
          ‚ö° T·ª± ƒë·ªông ƒëi·ªÅn
        </button>
        <button class="btn-secondary" onclick="resetForm()">
          üîÑ L√†m m·ªõi
        </button>
        <button class="btn-warning" onclick="testLoadData()">
          üîç Test d·ªØ li·ªáu
        </button>
      </div>
    </div>
    
    <div class="card">
      <h2 style="margin-bottom: 15px;">üìä K·∫øt qu·∫£ t√≠nh l∆∞∆°ng</h2>
      
      <div class="stats-container" id="stats-container">
        <!-- Th·ªëng k√™ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
      
      <div id="salary-result" style="display: none;">
        <div class="salary-summary">
          <h3>T·ªïng l∆∞∆°ng t·∫°m t√≠nh</h3>
          <div class="salary-amount" id="tong-luong">0 VND</div>
          <p id="thoi-gian-tinh">Th·ªùi gian t√≠nh: </p>
        </div>
        
        <div class="salary-breakdown">
          <h4>üìù Chi ti·∫øt t√≠nh l∆∞∆°ng:</h4>
          <ul id="chi-tiet-luong">
            <!-- Chi ti·∫øt s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </ul>
        </div>
        
        <div class="button-group">
          <button class="btn-success" onclick="copySalaryToClipboard()">
            üìã Sao ch√©p k·∫øt qu·∫£
          </button>
        </div>
      </div>
      
      <div id="empty-state" class="empty-state">
        <h3>üì≠ Ch∆∞a c√≥ k·∫øt qu·∫£ t√≠nh l∆∞∆°ng</h3>
        <p>H√£y nh·∫•n "T√≠nh l∆∞∆°ng" ƒë·ªÉ xem k·∫øt qu·∫£</p>
      </div>
    </div>
    
    <div class="card">
      <h2 style="margin-bottom: 15px;">üìÖ Chi ti·∫øt c√°c ca l√†m vi·ªác</h2>
      <div class="table-container">
        <table id="bang-cong">
          <thead>
            <tr>
              <th>STT</th>
              <th>Ng√†y l√†m vi·ªác</th>
              <th>S·ªë ƒëi·ªÉm gas</th>
              <th>T·ªïng ti·ªÅn thu</th>
              <th>Tr·∫°ng th√°i n·ªôp</th>
            </tr>
          </thead>
          <tbody id="bang-cong-body">
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </tbody>
        </table>
        <div id="empty-cong" class="empty-state" style="display: none;">
          <h3>üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu ca l√†m vi·ªác</h3>
          <p id="empty-message">H·ªá th·ªëng ch∆∞a t√¨m th·∫•y ca l√†m vi·ªác n√†o</p>
        </div>
      </div>
    </div>
  </div>

  <a href="index.html" style="position:fixed;right:30px;bottom:30px;z-index:999;background:#2c80ff;color:white;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:2rem;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:opacity 0.3s; text-decoration: none;">
    ‚Üê
  </a>

<script>
// S·ª¨A L·∫†I: D√πng C√ôNG URL v·ªõi file index.html
const scriptURL = 'https://script.google.com/macros/s/AKfycbyRnnoEd2BnD7u1pXHER17Cv95BN9Z77yUeO6oR7CFRtbUqd-SiVJqBv5ENYyARwX77fw/exec';
let allData = [];
let caLamViecList = [];

// H√†m hi·ªÉn th·ªã th√¥ng b√°o toast
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  
  toastMessage.textContent = message;
  toast.className = `toast ${type} show`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// H√†m t·∫°o hi·ªáu ·ª©ng ti·ªÅn/v√†ng r∆°i
function createMoneyRain() {
  const moneyRain = document.getElementById('money-rain');
  const moneySymbols = ['üí∞', 'üíµ', 'üí∏', 'ü™ô', 'üíé', 'üí∂', 'üí∑', 'üí¥', 'ü§ë', 'üí≥'];
  
  // X√≥a hi·ªáu ·ª©ng c≈© n·∫øu c√≥
  moneyRain.innerHTML = '';
  
  // T·∫°o 30-50 ph·∫ßn t·ª≠ ti·ªÅn r∆°i
  const particleCount = Math.min(Math.max(window.innerWidth / 20, 30), 50);
  
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.className = 'money-particle';
    
    // Ch·ªçn ng·∫´u nhi√™n bi·ªÉu t∆∞·ª£ng ti·ªÅn
    const symbol = moneySymbols[Math.floor(Math.random() * moneySymbols.length)];
    particle.textContent = symbol;
    
    // V·ªã tr√≠ ng·∫´u nhi√™n
    const left = Math.random() * 100;
    particle.style.left = `${left}%`;
    
    // K√≠ch th∆∞·ªõc ng·∫´u nhi√™n
    const size = 20 + Math.random() * 30;
    particle.style.fontSize = `${size}px`;
    
    // Th·ªùi gian r∆°i ng·∫´u nhi√™n
    const duration = 2 + Math.random() * 3;
    const delay = Math.random() * 2;
    
    particle.style.animation = `moneyFall ${duration}s ease-in ${delay}s forwards`;
    
    // Th√™m v√†o container
    moneyRain.appendChild(particle);
    
    // X√≥a ph·∫ßn t·ª≠ sau khi animation k·∫øt th√∫c
    setTimeout(() => {
      if (particle.parentNode === moneyRain) {
        moneyRain.removeChild(particle);
      }
    }, (duration + delay) * 1000);
  }
}

// H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
function formatCurrency(amount) {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND',
    minimumFractionDigits: 0
  }).format(amount);
}

// H√†m ƒë·ªãnh d·∫°ng ng√†y th√°ng
function formatDate(date) {
  const d = new Date(date);
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

// H√†m l·∫•y th√°ng v√† nƒÉm t·ª´ d·ªØ li·ªáu
function populateMonthYearSelectors() {
  const monthSelect = document.getElementById('thang-bat-dau');
  const yearSelect = document.getElementById('nam-bat-dau');
  
  const now = new Date();
  const currentMonth = now.getMonth() + 1;
  const currentYear = now.getFullYear();
  
  monthSelect.innerHTML = '';
  yearSelect.innerHTML = '';
  
  // Th√™m c√°c th√°ng
  const months = [
    {value: 1, text: 'Th√°ng 1'}, {value: 2, text: 'Th√°ng 2'}, {value: 3, text: 'Th√°ng 3'},
    {value: 4, text: 'Th√°ng 4'}, {value: 5, text: 'Th√°ng 5'}, {value: 6, text: 'Th√°ng 6'},
    {value: 7, text: 'Th√°ng 7'}, {value: 8, text: 'Th√°ng 8'}, {value: 9, text: 'Th√°ng 9'},
    {value: 10, text: 'Th√°ng 10'}, {value: 11, text: 'Th√°ng 11'}, {value: 12, text: 'Th√°ng 12'}
  ];
  
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month.value;
    option.textContent = month.text;
    if (month.value === currentMonth) {
      option.selected = true;
    }
    monthSelect.appendChild(option);
  });
  
  // Th√™m c√°c nƒÉm (t·ª´ nƒÉm tr∆∞·ªõc ƒë·∫øn nƒÉm sau)
  for (let year = currentYear - 1; year <= currentYear + 1; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = `NƒÉm ${year}`;
    if (year === currentYear) {
      option.selected = true;
    }
    yearSelect.appendChild(option);
  }
}

// H√†m t·ª± ƒë·ªông ƒëi·ªÅn chu k·ª≥ t·ª´ ng√†y 05 th√°ng tr∆∞·ªõc ƒë·∫øn 05 th√°ng n√†y - FIXED LOGIC
function autoFillLastCycle() {
  const now = new Date();
  const currentDay = now.getDate();
  const currentMonth = now.getMonth() + 1;
  const currentYear = now.getFullYear();
  
  const selectedDay = parseInt(document.getElementById('ngay-bat-dau').value) || 5;
  
  let startMonth, startYear;
  let endMonth, endYear;
  
  // Logic FIXED: 
  // 1. N·∫øu ng√†y hi·ªán t·∫°i >= ng√†y ƒë√£ ch·ªçn (v√≠ d·ª• 5): t√≠nh t·ª´ [ng√†y] th√°ng N√ÄY ƒë·∫øn [ng√†y] th√°ng SAU
  // 2. N·∫øu ng√†y hi·ªán t·∫°i < ng√†y ƒë√£ ch·ªçn: t√≠nh t·ª´ [ng√†y] th√°ng TR∆Ø·ªöC ƒë·∫øn [ng√†y] th√°ng N√ÄY
  
  if (currentDay >= selectedDay) {
    // V√≠ d·ª•: H√¥m nay 10/01/2026, ng√†y ch·ªçn 5 -> t√≠nh t·ª´ 05/01/2026 ƒë·∫øn 05/02/2026
    startMonth = currentMonth;
    startYear = currentYear;
    
    // T√≠nh th√°ng k·∫øt th√∫c
    if (currentMonth === 12) {
      endMonth = 1;
      endYear = currentYear + 1;
    } else {
      endMonth = currentMonth + 1;
      endYear = currentYear;
    }
  } else {
    // V√≠ d·ª•: H√¥m nay 03/01/2026, ng√†y ch·ªçn 5 -> t√≠nh t·ª´ 05/12/2025 ƒë·∫øn 05/01/2026
    if (currentMonth === 1) {
      startMonth = 12;
      startYear = currentYear - 1;
    } else {
      startMonth = currentMonth - 1;
      startYear = currentYear;
    }
    
    endMonth = currentMonth;
    endYear = currentYear;
  }
  
  // C·∫≠p nh·∫≠t form v·ªõi ng√†y b·∫Øt ƒë·∫ßu (th√°ng v√† nƒÉm)
  document.getElementById('thang-bat-dau').value = startMonth;
  document.getElementById('nam-bat-dau').value = startYear;
  
  // Hi·ªÉn th·ªã th√¥ng b√°o v·ªõi c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c
  showToast(`‚úÖ ƒê√£ ƒëi·ªÅn chu k·ª≥: ${selectedDay}/${startMonth}/${startYear} - ${selectedDay}/${endMonth}/${endYear}`);
  
  // Log ƒë·ªÉ debug
  console.log('T·ª± ƒë·ªông ƒëi·ªÅn chu k·ª≥:', {
    selectedDay,
    currentDate: `${currentDay}/${currentMonth}/${currentYear}`,
    startDate: `${selectedDay}/${startMonth}/${startYear}`,
    endDate: `${selectedDay}/${endMonth}/${endYear}`,
    condition: currentDay >= selectedDay ? 'currentDay >= selectedDay' : 'currentDay < selectedDay'
  });
}

// H√†m TEST t·∫£i d·ªØ li·ªáu
async function testLoadData() {
  console.log('=== B·∫ÆT ƒê·∫¶U TEST D·ªÆ LI·ªÜU ===');
  console.log('URL API:', scriptURL);
  
  try {
    const response = await fetch(scriptURL + '?t=' + Date.now());
    console.log('Response status:', response.status);
    console.log('Response ok:', response.ok);
    
    const text = await response.text();
    console.log('Response text (first 500 chars):', text.substring(0, 500));
    
    try {
      const data = JSON.parse(text);
      console.log('Parsed data type:', typeof data);
      console.log('Parsed data length:', Array.isArray(data) ? data.length : 'Not an array');
      console.log('Sample data (first item):', Array.isArray(data) && data.length > 0 ? data[0] : 'No data');
      
      if (Array.isArray(data) && data.length > 0) {
        // Ki·ªÉm tra c·∫•u tr√∫c d·ªØ li·ªáu
        const sample = data[0];
        console.log('Data structure:', Object.keys(sample));
        console.log('Ca field value:', sample.ca);
        console.log('Ca field type:', typeof sample.ca);
        
        // ƒê·∫øm s·ªë b·∫£n ghi c√≥ tr∆∞·ªùng "ca"
        const hasCaCount = data.filter(item => item.ca && item.ca.trim() !== '').length;
        console.log('S·ªë b·∫£n ghi c√≥ tr∆∞·ªùng ca:', hasCaCount);
        
        // L·∫•y danh s√°ch ca duy nh·∫•t
        const caSet = new Set();
        data.forEach(item => {
          if (item.ca && item.ca.trim() !== '') {
            caSet.add(item.ca);
          }
        });
        console.log('S·ªë ca duy nh·∫•t:', caSet.size);
        console.log('Danh s√°ch ca:', Array.from(caSet));
        
        alert(`TEST D·ªÆ LI·ªÜU:\n- T·ªïng b·∫£n ghi: ${data.length}\n- C√≥ tr∆∞·ªùng "ca": ${hasCaCount}\n- S·ªë ca duy nh·∫•t: ${caSet.size}\n- Xem Console ƒë·ªÉ bi·∫øt chi ti·∫øt`);
      } else {
        alert('D·ªØ li·ªáu tr·ªëng ho·∫∑c kh√¥ng ph·∫£i m·∫£ng!');
      }
    } catch (parseError) {
      console.error('L·ªói parse JSON:', parseError);
      alert('L·ªói parse JSON! Xem Console ƒë·ªÉ bi·∫øt chi ti·∫øt.');
    }
  } catch (fetchError) {
    console.error('L·ªói fetch:', fetchError);
    alert('L·ªói khi t·∫£i d·ªØ li·ªáu! Xem Console ƒë·ªÉ bi·∫øt chi ti·∫øt.');
  }
}

// H√†m T·∫¢I D·ªÆ LI·ªÜU T·ª™ GOOGLE SHEETS
async function taiDuLieu() {
  console.log('ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...');
  
  try {
    // Th√™m timestamp ƒë·ªÉ tr√°nh cache
    const url = scriptURL + '?t=' + Date.now();
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const text = await response.text();
    
    // Th·ª≠ parse JSON
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error('L·ªói parse JSON:', e);
      // Th·ª≠ fix n·∫øu c√≥ v·∫•n ƒë·ªÅ v·ªõi JSON
      const fixedText = text.trim();
      if (fixedText.startsWith('[') && fixedText.endsWith(']')) {
        data = JSON.parse(fixedText);
      } else {
        throw new Error('D·ªØ li·ªáu kh√¥ng ph·∫£i JSON h·ª£p l·ªá');
      }
    }
    
    if (!Array.isArray(data)) {
      console.error('D·ªØ li·ªáu kh√¥ng ph·∫£i l√† m·∫£ng:', data);
      allData = [];
      showToast('‚ö†Ô∏è D·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!', 'error');
      return;
    }
    
    allData = data;
    console.log('ƒê√£ t·∫£i ƒë∆∞·ª£c', allData.length, 'b·∫£n ghi t·ª´ Google Sheets');
    
    // Ph√¢n t√≠ch d·ªØ li·ªáu ca
    analyzeCaData();
    
    if (allData.length === 0) {
      showToast('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu trong Google Sheets!', 'warning');
    } else {
      showToast(`‚úÖ ƒê√£ t·∫£i ${allData.length} b·∫£n ghi t·ª´ Google Sheets`);
    }
    
  } catch (error) {
    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
    showToast('‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets!', 'error');
    allData = [];
  }
}

// H√†m ph√¢n t√≠ch d·ªØ li·ªáu ca
function analyzeCaData() {
  console.log('=== PH√ÇN T√çCH D·ªÆ LI·ªÜU CA ===');
  
  // Reset danh s√°ch ca
  caLamViecList = [];
  
  if (allData.length === 0) {
    console.log('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch');
    return;
  }
  
  // Nh√≥m d·ªØ li·ªáu theo ca
  const caMap = new Map();
  
  allData.forEach((item, index) => {
    // Ki·ªÉm tra xem c√≥ tr∆∞·ªùng "ca" kh√¥ng
    if (!item.ca) {
      console.log(`B·∫£n ghi ${index} kh√¥ng c√≥ tr∆∞·ªùng "ca"`);
      return;
    }
    
    const caValue = item.ca.toString().trim();
    
    if (!caValue || caValue === '') {
      console.log(`B·∫£n ghi ${index} c√≥ tr∆∞·ªùng "ca" r·ªóng`);
      return;
    }
    
    // Parse ng√†y t·ª´ tr∆∞·ªùng ca
    let caDate;
    try {
      // Th·ª≠ parse theo ƒë·ªãnh d·∫°ng YYYY-MM-DD
      if (caValue.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
        caDate = new Date(caValue);
      } else {
        // Th·ª≠ parse c√°c ƒë·ªãnh d·∫°ng kh√°c
        caDate = new Date(caValue);
      }
      
      if (isNaN(caDate.getTime())) {
        console.log(`Ng√†y kh√¥ng h·ª£p l·ªá: ${caValue}`);
        return;
      }
      
      // Chu·∫©n h√≥a ng√†y v·ªÅ YYYY-MM-DD
      const year = caDate.getFullYear();
      const month = String(caDate.getMonth() + 1).padStart(2, '0');
      const day = String(caDate.getDate()).padStart(2, '0');
      const caKey = `${year}-${month}-${day}`;
      
      if (!caMap.has(caKey)) {
        caMap.set(caKey, {
          ngay: caKey,
          diemGas: [],
          tongTien: 0,
          daNopCount: 0,
          chuaNopCount: 0,
          dateObj: caDate
        });
      }
      
      const caData = caMap.get(caKey);
      caData.diemGas.push(item);
      
      // T√≠nh t·ªïng ti·ªÅn
      const soTien = parseInt(item.so_tien) || 0;
      caData.tongTien += soTien;
      
      // ƒê·∫øm tr·∫°ng th√°i n·ªôp
      if (item.trang_thai === 'ƒê√£ n·ªôp') {
        caData.daNopCount++;
      } else {
        caData.chuaNopCount++;
      }
      
    } catch (e) {
      console.log(`L·ªói parse ng√†y ${caValue}:`, e);
    }
  });
  
  // Chuy·ªÉn Map th√†nh m·∫£ng v√† s·∫Øp x·∫øp theo ng√†y (m·ªõi nh·∫•t tr∆∞·ªõc)
  caLamViecList = Array.from(caMap.values());
  caLamViecList.sort((a, b) => b.dateObj - a.dateObj);
  
  console.log(`T√¨m th·∫•y ${caLamViecList.length} ca l√†m vi·ªác`);
  console.log('Danh s√°ch ca:', caLamViecList.map(ca => ca.ngay));
  
  // Hi·ªÉn th·ªã danh s√°ch ca
  displayWorkingDays(caLamViecList);
}

// H√†m hi·ªÉn th·ªã danh s√°ch ng√†y c√¥ng
function displayWorkingDays(caLamViec) {
  const bangCongBody = document.getElementById('bang-cong-body');
  const emptyCong = document.getElementById('empty-cong');
  const emptyMessage = document.getElementById('empty-message');
  
  if (!caLamViec || caLamViec.length === 0) {
    bangCongBody.innerHTML = '';
    emptyCong.style.display = 'block';
    emptyMessage.textContent = allData.length === 0 
      ? 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.' 
      : 'Kh√¥ng t√¨m th·∫•y ca l√†m vi·ªác n√†o trong d·ªØ li·ªáu';
    return;
  }
  
  emptyCong.style.display = 'none';
  bangCongBody.innerHTML = '';
  
  caLamViec.forEach((ca, index) => {
    const tr = document.createElement('tr');
    tr.className = 'fade-in';
    
    const caDate = new Date(ca.ngay);
    const day = String(caDate.getDate()).padStart(2, '0');
    const month = String(caDate.getMonth() + 1).padStart(2, '0');
    const year = caDate.getFullYear();
    
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>
        <div style="font-weight: 600;">${day}-${month}-${year}</div>
        <div style="font-size: 0.8rem; color: var(--gray);">Ca ${day}-${month}</div>
      </td>
      <td>${ca.diemGas.length}</td>
      <td>${formatCurrency(ca.tongTien)}</td>
      <td>
        <div style="display: flex; flex-direction: column; gap: 2px;">
          <span style="color: var(--secondary); font-size: 0.85rem;">‚úÖ ƒê√£ n·ªôp: ${ca.daNopCount}</span>
          <span style="color: var(--warning); font-size: 0.85rem;">‚è≥ Ch∆∞a n·ªôp: ${ca.chuaNopCount}</span>
        </div>
      </td>
    `;
    bangCongBody.appendChild(tr);
  });
}

// H√†m t√≠nh l∆∞∆°ng - FIXED: X·ª≠ l√Ω ƒë√∫ng vi·ªác chuy·ªÉn th√°ng/nƒÉm
async function tinhLuong() {
  const btn = document.getElementById('btn-tinh-luong');
  const originalText = btn.textContent;
  
  try {
    btn.textContent = '‚è≥ ƒêang t√≠nh...';
    btn.disabled = true;
    
    // 1. L·∫•y th√¥ng tin ƒë·∫ßu v√†o
    const luongThang = parseInt(document.getElementById('luong-thang').value);
    const ngayBatDau = parseInt(document.getElementById('ngay-bat-dau').value);
    const thangBatDau = parseInt(document.getElementById('thang-bat-dau').value);
    const namBatDau = parseInt(document.getElementById('nam-bat-dau').value);
    
    if (!luongThang || luongThang <= 0) {
      showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p l∆∞∆°ng th√°ng h·ª£p l·ªá!', 'error');
      return;
    }
    
    // 2. T·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t n·∫øu ch∆∞a c√≥
    if (allData.length === 0) {
      await taiDuLieu();
    }
    
    // 3. T√≠nh ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c chu k·ª≥ - FIXED: X·ª≠ l√Ω chuy·ªÉn nƒÉm
    const ngayBatDauChuKy = new Date(namBatDau, thangBatDau - 1, ngayBatDau);
    
    // T√≠nh ng√†y k·∫øt th√∫c (th√°ng sau, c√πng ng√†y)
    let ngayKetThucChuKy;
    if (thangBatDau === 12) {
      // N·∫øu l√† th√°ng 12, chuy·ªÉn sang th√°ng 1 nƒÉm sau
      ngayKetThucChuKy = new Date(namBatDau + 1, 0, ngayBatDau);
    } else {
      // C√°c th√°ng kh√°c
      ngayKetThucChuKy = new Date(namBatDau, thangBatDau, ngayBatDau);
    }
    
    // Tr·ª´ ƒëi 1 mili gi√¢y ƒë·ªÉ kh√¥ng t√≠nh c·∫£ ng√†y b·∫Øt ƒë·∫ßu c·ªßa chu k·ª≥ ti·∫øp theo
    ngayKetThucChuKy = new Date(ngayKetThucChuKy.getTime() - 1);
    
    console.log('Chu k·ª≥ l∆∞∆°ng:', {
      batDau: ngayBatDauChuKy.toLocaleDateString('vi-VN'),
      ketThuc: ngayKetThucChuKy.toLocaleDateString('vi-VN')
    });
    
    // 4. L·ªçc c√°c ca l√†m vi·ªác trong chu k·ª≥
    const caLamViecTrongChuKy = caLamViecList.filter(ca => {
      const caDate = new Date(ca.ngay);
      return caDate >= ngayBatDauChuKy && caDate <= ngayKetThucChuKy;
    });
    
    console.log('Ca l√†m vi·ªác trong chu k·ª≥:', caLamViecTrongChuKy.length);
    console.log('Chi ti·∫øt:', caLamViecTrongChuKy.map(ca => ca.ngay));
    
    // 5. T√≠nh s·ªë ng√†y c√¥ng = s·ªë ca l√†m vi·ªác th·ª±c t·∫ø
    const soNgayCong = caLamViecTrongChuKy.length;
    
    // 6. T√≠nh l∆∞∆°ng: l∆∞∆°ng th√°ng / 30 ng√†y * s·ªë ng√†y c√¥ng th·ª±c t·∫ø
    const luongTheoNgay = luongThang / 30;
    const tongLuong = Math.round(luongTheoNgay * soNgayCong);
    
    // 7. Hi·ªÉn th·ªã k·∫øt qu·∫£
    displaySalaryResult(luongThang, tongLuong, soNgayCong, caLamViecTrongChuKy, ngayBatDauChuKy, ngayKetThucChuKy);
    
    // 8. K√≠ch ho·∫°t hi·ªáu ·ª©ng ti·ªÅn r∆°i n·∫øu c√≥ l∆∞∆°ng > 0
    if (tongLuong > 0) {
      createMoneyRain();
      showToast('üí∞ T√≠nh l∆∞∆°ng th√†nh c√¥ng! Ti·ªÅn ƒëang r∆°i!');
    } else {
      showToast('‚ö†Ô∏è Kh√¥ng c√≥ ca l√†m vi·ªác trong chu k·ª≥ n√†y!', 'warning');
    }
    
  } catch (error) {
    console.error('L·ªói khi t√≠nh l∆∞∆°ng:', error);
    showToast('‚ùå C√≥ l·ªói khi t√≠nh l∆∞∆°ng!', 'error');
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ t√≠nh l∆∞∆°ng - FIXED: Hi·ªÉn th·ªã ƒë√∫ng th√¥ng tin
function displaySalaryResult(luongThang, tongLuong, soNgayCong, caLamViec, startDate, endDate) {
  const statsContainer = document.getElementById('stats-container');
  
  // T√≠nh t·ªïng ti·ªÅn thu ƒë∆∞·ª£c t·ª´ c√°c ca l√†m vi·ªác
  const tongTienThu = caLamViec.reduce((sum, ca) => sum + ca.tongTien, 0);
  
  // C·∫≠p nh·∫≠t th·ªëng k√™
  statsContainer.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${soNgayCong}</div>
      <div class="stat-label">S·ªë ca l√†m vi·ªác</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${formatCurrency(luongThang)}</div>
      <div class="stat-label">L∆∞∆°ng th√°ng</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${formatCurrency(tongLuong)}</div>
      <div class="stat-label">L∆∞∆°ng t·∫°m t√≠nh</div>
    </div>
  `;
  
  // C·∫≠p nh·∫≠t ph·∫ßn t·ªïng l∆∞∆°ng t·∫°m t√≠nh ·ªü ƒë·∫ßu trang
  const salaryPreview = document.getElementById('salary-preview');
  const previewAmount = document.getElementById('preview-amount');
  const previewTime = document.getElementById('preview-time');
  
  previewAmount.textContent = formatCurrency(tongLuong);
  
  // FIXED: ƒê·ªãnh d·∫°ng ng√†y th√°ng ƒë√∫ng c√°ch
  const startStr = startDate.toLocaleDateString('vi-VN');
  const endStr = endDate.toLocaleDateString('vi-VN');
  previewTime.textContent = `Th·ªùi gian t√≠nh: T·ª´ ${startStr} ƒë·∫øn ${endStr}`;
  salaryPreview.classList.add('show');
  
  // C·∫≠p nh·∫≠t ph·∫ßn k·∫øt qu·∫£ chi ti·∫øt b√™n d∆∞·ªõi
  document.getElementById('tong-luong').textContent = formatCurrency(tongLuong);
  document.getElementById('thoi-gian-tinh').textContent = `Th·ªùi gian t√≠nh: T·ª´ ${startStr} ƒë·∫øn ${endStr}`;
  
  const chiTietLuong = document.getElementById('chi-tiet-luong');
  const luongTheoNgay = luongThang / 30;
  
  chiTietLuong.innerHTML = `
    <li>L∆∞∆°ng th√°ng: ${formatCurrency(luongThang)}</li>
    <li>Quy ∆∞·ªõc: 30 ng√†y c√¥ng/th√°ng</li>
    <li>L∆∞∆°ng m·ªói ng√†y: ${formatCurrency(luongTheoNgay)}</li>
    <li>S·ªë ca l√†m vi·ªác th·ª±c t·∫ø: ${soNgayCong} ca</li>
    <li>T·ªïng ti·ªÅn thu ƒë∆∞·ª£c: ${formatCurrency(tongTienThu)}</li>
    <li><strong>T·ªïng l∆∞∆°ng t·∫°m t√≠nh: ${formatCurrency(tongLuong)}</strong></li>
  `;
  
  document.getElementById('salary-result').style.display = 'block';
  document.getElementById('empty-state').style.display = 'none';
  
  // Hi·ªÉn th·ªã danh s√°ch ca l√†m vi·ªác trong chu k·ª≥
  displayWorkingDays(caLamViec);
}

// H√†m sao ch√©p k·∫øt qu·∫£
async function copySalaryToClipboard() {
  const luongThang = document.getElementById('luong-thang').value;
  const tongLuong = document.getElementById('tong-luong').textContent;
  const thoiGianTinh = document.getElementById('thoi-gian-tinh').textContent;
  
  // T√≠nh s·ªë ca trong chu k·ª≥ hi·ªán t·∫°i
  const ngayBatDau = parseInt(document.getElementById('ngay-bat-dau').value);
  const thangBatDau = parseInt(document.getElementById('thang-bat-dau').value);
  const namBatDau = parseInt(document.getElementById('nam-bat-dau').value);
  
  const ngayBatDauChuKy = new Date(namBatDau, thangBatDau - 1, ngayBatDau);
  let ngayKetThucChuKy;
  if (thangBatDau === 12) {
    ngayKetThucChuKy = new Date(namBatDau + 1, 0, ngayBatDau);
  } else {
    ngayKetThucChuKy = new Date(namBatDau, thangBatDau, ngayBatDau);
  }
  ngayKetThucChuKy = new Date(ngayKetThucChuKy.getTime() - 1);
  
  const soCa = caLamViecList.filter(ca => {
    const caDate = new Date(ca.ngay);
    return caDate >= ngayBatDauChuKy && caDate <= ngayKetThucChuKy;
  }).length;
  
  const content = `
T√çNH L∆Ø∆†NG THEO S·ªê CA L√ÄM VI·ªÜC
${thoiGianTinh}
L∆∞∆°ng th√°ng: ${formatCurrency(parseInt(luongThang))}
S·ªë ca l√†m vi·ªác th·ª±c t·∫ø: ${soCa} ca
T·ªïng l∆∞∆°ng t·∫°m t√≠nh: ${tongLuong}
---
K·∫øt qu·∫£ t√≠nh t·ª´ ·ª©ng d·ª•ng Qu·∫£n l√Ω ƒëi·ªÉm gas
  `.trim();
  
  try {
    await navigator.clipboard.writeText(content);
    showToast('‚úÖ ƒê√£ sao ch√©p k·∫øt qu·∫£ v√†o clipboard!');
  } catch (err) {
    showToast('‚ùå Kh√¥ng th·ªÉ sao ch√©p v√†o clipboard!', 'error');
  }
}

// H√†m reset form
function resetForm() {
  document.getElementById('luong-thang').value = '5500000';
  document.getElementById('ngay-bat-dau').value = '5';
  populateMonthYearSelectors();
  
  // ·∫®n ph·∫ßn t·ªïng l∆∞∆°ng t·∫°m t√≠nh ·ªü ƒë·∫ßu
  document.getElementById('salary-preview').classList.remove('show');
  
  // ·∫®n ph·∫ßn k·∫øt qu·∫£ chi ti·∫øt
  document.getElementById('salary-result').style.display = 'none';
  document.getElementById('empty-state').style.display = 'block';
  
  // Reset b·∫£ng c√¥ng
  const bangCongBody = document.getElementById('bang-cong-body');
  bangCongBody.innerHTML = '';
  document.getElementById('empty-cong').style.display = 'block';
  document.getElementById('empty-message').textContent = 'H·ªá th·ªëng ch∆∞a t√¨m th·∫•y ca l√†m vi·ªác n√†o';
}

// Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== TRANG T√çNH L∆Ø∆†NG ƒêANG KH·ªûI ƒê·ªòNG ===');
  
  // 1. ƒêi·ªÅn th√°ng/nƒÉm
  populateMonthYearSelectors();
  
  // 2. T·ª± ƒë·ªông ƒëi·ªÅn chu k·ª≥ g·∫ßn nh·∫•t (t·ª´ 05 th√°ng tr∆∞·ªõc ƒë·∫øn 05 th√°ng n√†y)
  autoFillLastCycle();
  
  // 3. T·∫£i d·ªØ li·ªáu ngay khi trang load
  taiDuLieu().then(() => {
    // 4. T·ª± ƒë·ªông t√≠nh l∆∞∆°ng sau khi c√≥ d·ªØ li·ªáu (n·∫øu c√≥)
    if (caLamViecList.length > 0) {
      setTimeout(() => {
        tinhLuong();
      }, 500);
    }
  });
  
  // 5. Th√™m s·ª± ki·ªán cho √¥ nh·∫≠p l∆∞∆°ng
  document.getElementById('luong-thang').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      tinhLuong();
    }
  });
});
</script>
</body>
</html>