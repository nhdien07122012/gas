<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n l√Ω Thu n·ª£</title>
<!-- Th√™m c√°c th·∫ª icon -->
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="apple-touch-icon-precomposed" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Thu n·ª£">
<style>
  :root {
    --primary: #2c80ff;
    --primary-dark: #1a6de0;
    --secondary: #34c759;
    --danger: #ff3b30;
    --warning: #ff9500;
    --light: #f8f9fa;
    --dark: #333;
    --gray: #6c757d;
    --border: #dee2e6;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
    --radius: 10px;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 25px 30px;
    text-align: center;
    position: relative;
  }
  
  header h1 {
    font-size: 1.8rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  header p {
    opacity: 0.9;
    font-size: 1rem;
  }
  
  .back-button {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
  }
  
  .back-button:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  
  .card {
    padding: 25px 30px;
    border-bottom: 1px solid var(--border);
  }
  
  .card:last-child {
    border-bottom: none;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
  }
  
  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 128, 255, 0.1);
  }
  
  .button-group {
    display: flex;
    gap: 15px;
    margin-top: 25px;
  }
  
  button {
    flex: 1;
    padding: 16px;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn-primary {
    background-color: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(44, 128, 255, 0.3);
  }
  
  .btn-secondary {
    background-color: #f1f3f5;
    color: var(--dark);
  }
  
  .btn-secondary:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }
  
  .btn-success {
    background-color: var(--secondary);
    color: white;
  }
  
  .btn-success:hover {
    background-color: #30b352;
    transform: translateY(-2px);
  }
  
  .btn-warning {
    background-color: var(--warning);
    color: white;
  }
  
  .btn-warning:hover {
    background-color: #e08900;
    transform: translateY(-2px);
  }
  
  .btn-danger {
    background-color: var(--danger);
    color: white;
  }
  
  .btn-danger:hover {
    background-color: #e0352b;
    transform: translateY(-2px);
  }
  
  .btn-sm {
    padding: 8px 12px;
    font-size: 0.85rem;
  }
  
  .table-container {
    overflow-x: auto;
    margin-top: 10px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 5px;
  }
  
  th {
    background-color: #f8f9fa;
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    border-bottom: 2px solid var(--border);
  }
  
  td {
    padding: 14px 12px;
    border-bottom: 1px solid var(--border);
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  tr:hover {
    background-color: #f8fafc;
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
  }
  
  .empty-state p {
    margin-top: 10px;
  }
  
  .stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    flex: 1;
    min-width: 150px;
    background: #f8f9fa;
    border-radius: var(--radius);
    padding: 15px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }
  
  .stat-label {
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 5px;
  }
  
  .filter-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-group select {
    flex: 1;
    min-width: 200px;
  }
  
  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .modal-content {
    background: white;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    animation: modalFadeIn 0.3s ease-out;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .modal-header h2 {
    font-size: 1.4rem;
  }
  
  .modal-body {
    padding: 25px;
    flex: 1;
    overflow-y: auto;
  }
  
  .modal-footer {
    padding: 20px 25px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  .close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
  }
  
  .close-modal:hover {
    color: var(--dark);
  }
  
  /* Responsive styles */
  @media (max-width: 768px) {
    body {
      padding: 15px;
    }
    
    header {
      padding: 20px;
    }
    
    header h1 {
      font-size: 1.5rem;
    }
    
    .card {
      padding: 20px;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .stats-container {
      flex-direction: column;
    }
    
    .filter-group {
      flex-direction: column;
    }
    
    .filter-group select {
      min-width: 100%;
    }
    
    th, td {
      padding: 12px 8px;
      font-size: 0.9rem;
    }
    
    table {
      min-width: 600px;
    }
    
    .modal {
      padding: 10px;
    }
    
    .modal-content {
      width: 95%;
    }
    
    .modal-header, .modal-body, .modal-footer {
      padding: 15px;
    }
  }
  
  @media (max-width: 480px) {
    body {
      padding: 10px;
    }
    
    header {
      padding: 18px 15px;
    }
    
    header h1 {
      font-size: 1.3rem;
    }
    
    .card {
      padding: 18px 15px;
    }
    
    input, select {
      padding: 12px 14px;
      font-size: 16px;
    }
    
    button {
      padding: 14px;
    }
  }
  
  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  .fade-in {
    animation: fadeIn 0.4s ease-out;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
  }
  
  .badge-primary {
    background-color: var(--primary);
    color: white;
  }
  
  .badge-secondary {
    background-color: var(--secondary);
    color: white;
  }
  
  .badge-warning {
    background-color: var(--warning);
    color: white;
  }
  
  .badge-danger {
    background-color: var(--danger);
    color: white;
  }
  
  .action-buttons {
    display: flex;
    gap: 5px;
  }
  
  .form-row {
    display: flex;
    gap: 15px;
  }
  
  .form-row .form-group {
    flex: 1;
  }
  
  /* Toast notification */
  .toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) translateY(100px);
    background: var(--primary);
    color: white;
    padding: 16px 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    z-index: 1002;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transition: all 0.3s ease;
    min-width: 280px;
    text-align: center;
    justify-content: center;
  }

  .toast.show {
    transform: translate(-50%, -50%) translateY(0);
    opacity: 1;
  }
  
  .toast.success {
    background: var(--secondary);
  }
  
  .toast.error {
    background: var(--danger);
  }
  
  /* Style cho danh s√°ch thu n·ª£ */
  .debt-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 8px;
    background-color: #f8f9fa;
    border-radius: var(--radius);
    border-left: 4px solid var(--warning);
  }
  
  .debt-item.success {
    border-left-color: var(--secondary);
  }
  
  .debt-item.pending {
    border-left-color: var(--warning);
  }
  
  .debt-item.failed {
    border-left-color: var(--danger);
  }
  
  .debt-item-info {
    flex: 1;
  }
  
  .debt-item-name {
    font-weight: 600;
    color: var(--dark);
  }
  
  .debt-item-amount {
    font-weight: 700;
    color: var(--primary);
    margin-top: 3px;
  }
  
  .debt-item-note {
    font-size: 0.85rem;
    color: var(--gray);
    margin-top: 2px;
  }
  
  .debt-item-actions {
    display: flex;
    gap: 5px;
  }
  
  .debt-status-select {
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid var(--border);
    font-size: 0.9rem;
  }
  
  .debt-summary {
    margin-top: 20px;
    padding: 15px;
    background-color: #f1f3f5;
    border-radius: var(--radius);
  }
  
  .debt-summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
  }
  
  .debt-total {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--primary);
    border-top: 2px solid var(--border);
    padding-top: 10px;
    margin-top: 10px;
  }
  
  /* Style cho n√∫t th√™m nhanh */
  .quick-add-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }
  
  .quick-add-btn {
    padding: 8px 12px;
    background-color: #e9ecef;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  
  .quick-add-btn:hover {
    background-color: #dee2e6;
  }
  
  /* Style cho ph·∫ßn import/export */
  .import-export-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  
  .import-export-buttons button {
    flex: 1;
  }
  
  /* Style cho modal ch·ªçn ca */
  .shift-option {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .shift-option:hover {
    background-color: #f8f9fa;
  }
  
  .shift-option.selected {
    background-color: rgba(44, 128, 255, 0.1);
    border-color: var(--primary);
  }
  
  .shift-option input {
    width: auto;
    margin-right: 10px;
  }
  
  .shift-option label {
    flex: 1;
    cursor: pointer;
    margin-bottom: 0;
  }
</style>
</head>
<body>
  <!-- Toast notification -->
  <div class="toast" id="toast">
    <span id="toast-message">ƒê√£ sao ch√©p v√†o clipboard!</span>
  </div>

  <div class="container">
    <header>
      <button class="back-button" onclick="window.location.href='index.html'">
        ‚Üê Trang ch√≠nh
      </button>
      <h1>üí≥ Qu·∫£n l√Ω Thu n·ª£</h1>
      <p>Theo d√µi v√† qu·∫£n l√Ω thu n·ª£ t·∫°i c√°c ƒëi·ªÉm gas theo ca</p>
    </header>
    
    <div class="card">
      <h2 style="margin-bottom: 15px;">üìã T·∫°o danh s√°ch thu n·ª£</h2>
      
      <div class="form-group">
        <label for="debt-shift">Ch·ªçn ca thu n·ª£:</label>
        <select id="debt-shift" onchange="updateDebtListDisplay()">
          <option value="">-- Ch·ªçn ca --</option>
          <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </select>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="debt-diem">Ch·ªçn ƒëi·ªÉm:</label>
          <input id="debt-diem" list="debt-diem-list" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn ƒëi·ªÉm..." autocomplete="off">
          <datalist id="debt-diem-list">
            <!-- Danh s√°ch ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </datalist>
          
          <div class="quick-add-buttons" id="quick-add-buttons">
            <!-- N√∫t th√™m nhanh s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </div>
        </div>
        
        <div class="form-group">
          <label for="debt-so-tien">S·ªë ti·ªÅn (VNƒê):</label>
          <input id="debt-so-tien" type="number" placeholder="Nh·∫≠p s·ªë ti·ªÅn" autocomplete="off">
        </div>
      </div>
      
      <div class="form-group">
        <label for="debt-ghi-chu">Ghi ch√∫:</label>
        <input id="debt-ghi-chu" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)" autocomplete="off">
      </div>
      
      <div class="button-group">
        <button class="btn-primary" onclick="addToDebtList()" id="btn-add-debt">
          ‚ûï Th√™m v√†o danh s√°ch thu n·ª£
        </button>
        <button class="btn-secondary" onclick="clearDebtForm()">
          ‚ùå X√≥a form
        </button>
      </div>
      
      <div class="import-export-buttons">
        <button class="btn-warning" onclick="importFromMainData()">
          üì• Import t·ª´ d·ªØ li·ªáu ch√≠nh
        </button>
        <button class="btn-success" onclick="exportDebtList()">
          üì§ Xu·∫•t danh s√°ch thu n·ª£
        </button>
      </div>
    </div>
    
    <div class="card">
      <div class="stats-container" id="stats-container">
        <!-- Th·ªëng k√™ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
      
      <div class="filter-group">
        <select id="filter-debt-status" onchange="filterDebtList()">
          <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="pending">Ch∆∞a thu</option>
          <option value="success">ƒê√£ thu</option>
          <option value="failed">H·∫πn l·∫°i</option>
        </select>
        
        <select id="filter-debt-shift" onchange="filterDebtList()">
          <option value="all">T·∫•t c·∫£ c√°c ca</option>
          <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </select>
      </div>
      
      <h2 style="margin-bottom: 15px;">üìä Danh s√°ch thu n·ª£</h2>
      
      <div id="debt-list-container">
        <div id="debt-list">
          <!-- Danh s√°ch thu n·ª£ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
        
        <div id="empty-debt-state" class="empty-state">
          <h3>üì≠ Ch∆∞a c√≥ kho·∫£n n·ª£ n√†o</h3>
          <p>H√£y th√™m kho·∫£n n·ª£ ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>
        </div>
      </div>
      
      <div class="button-group" style="margin-top: 20px;">
        <button class="btn-success" onclick="showShiftSelectionModal()" id="btn-process-debt">
          ‚úÖ Ho√†n t·∫•t & Chuy·ªÉn th√†nh ƒëi·ªÉm
        </button>
        <button class="btn-danger" onclick="clearAllDebts()">
          üóëÔ∏è X√≥a t·∫•t c·∫£
        </button>
      </div>
    </div>
  </div>

  <!-- Modal x√°c nh·∫≠n -->
  <div class="modal" id="confirm-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>X√°c nh·∫≠n</h2>
        <button class="close-modal" onclick="closeModal('confirm-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirm-message"></p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('confirm-modal')">H·ªßy</button>
        <button class="btn-primary" id="confirm-action-btn">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Modal import d·ªØ li·ªáu -->
  <div class="modal" id="import-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì• Import t·ª´ d·ªØ li·ªáu ch√≠nh</h2>
        <button class="close-modal" onclick="closeModal('import-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="import-shift">Ch·ªçn ca ƒë·ªÉ import:</label>
          <select id="import-shift">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="import-status">Ch·ªçn tr·∫°ng th√°i:</label>
          <select id="import-status">
            <option value="all">T·∫•t c·∫£</option>
            <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
            <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
          </select>
        </div>
        
        <div id="import-preview" style="margin-top: 15px; max-height: 200px; overflow-y: auto; display: none;">
          <h4>Danh s√°ch s·∫Ω import:</h4>
          <div id="import-preview-list"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('import-modal')">H·ªßy</button>
        <button class="btn-primary" onclick="confirmImport()">Import</button>
      </div>
    </div>
  </div>

  <!-- Modal ch·ªçn ca ƒë·ªÉ chuy·ªÉn ƒë·ªïi -->
  <div class="modal" id="shift-selection-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìä Ch·ªçn ca ƒë·ªÉ chuy·ªÉn ƒë·ªïi</h2>
        <button class="close-modal" onclick="closeModal('shift-selection-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="shift-selection-list">
          <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
        <div id="no-successful-debts" style="display: none;">
          <p class="empty-state">Kh√¥ng c√≥ kho·∫£n n·ª£ n√†o ƒë√£ thu th√†nh c√¥ng!</p>
          <p>Vui l√≤ng ƒë√°nh d·∫•u tr·∫°ng th√°i "ƒê√£ thu" cho c√°c kho·∫£n n·ª£ tr∆∞·ªõc khi chuy·ªÉn ƒë·ªïi.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('shift-selection-modal')">H·ªßy</button>
        <button class="btn-primary" onclick="processSelectedShiftDebts()" id="btn-process-selected-shift">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbyRnnoEd2BnD7u1pXHER17Cv95BN9Z77yUeO6oR7CFRtbUqd-SiVJqBv5ENYyARwX77fw/exec';
let debtList = [];
let allMainData = [];
let cacheDiem = {};
let selectedShiftForProcessing = null;

// H√†m hi·ªÉn th·ªã th√¥ng b√°o toast
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  
  toastMessage.textContent = message;
  toast.className = `toast ${type} show`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
function formatCurrency(amount) {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND'
  }).format(amount);
}

// ƒê·ªãnh d·∫°ng s·ªë kh√¥ng c√≥ k√Ω hi·ªáu ti·ªÅn t·ªá
function formatNumber(amount) {
  return new Intl.NumberFormat('vi-VN').format(amount);
}

// L·∫•y d·ªØ li·ªáu t·ª´ trang ch√≠nh
async function loadMainData() {
  try {
    const res = await fetch(scriptURL);
    const data = await res.json();
    allMainData = data;
    
    // C·∫≠p nh·∫≠t cacheDiem
    cacheDiem = {};
    data.forEach(item => {
      if (item.ten_diem && item.dia_chi) {
        cacheDiem[item.ten_diem] = item.dia_chi;
      }
    });
    
    updateShiftOptions();
    updateDiemOptions();
    updateQuickAddButtons();
    
    // Load danh s√°ch n·ª£ t·ª´ localStorage
    loadDebtListFromStorage();
    
    return data;
  } catch (error) {
    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu ch√≠nh:', error);
    showToast('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ server!', 'error');
    return [];
  }
}

// C·∫≠p nh·∫≠t c√°c t√πy ch·ªçn ca
function updateShiftOptions() {
  const shifts = new Set();
  allMainData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  // C·∫≠p nh·∫≠t cho select ca thu n·ª£
  const debtShiftSelect = document.getElementById('debt-shift');
  const currentValue = debtShiftSelect.value;
  debtShiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  // Th√™m ca hi·ªán t·∫°i (n·∫øu c√≥)
  const currentShift = getCurrentShift();
  if (currentShift.shiftKey) {
    const option = document.createElement('option');
    option.value = currentShift.shiftKey;
    option.textContent = `Ca hi·ªán t·∫°i (${formatShiftName(currentShift.shiftKey)})`;
    debtShiftSelect.appendChild(option);
  }
  
  // Th√™m c√°c ca kh√°c
  Array.from(shifts).sort().reverse().forEach(shift => {
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = formatShiftName(shift);
    debtShiftSelect.appendChild(option);
  });
  
  // Kh√¥i ph·ª•c gi√° tr·ªã ƒë√£ ch·ªçn
  if (currentValue) {
    debtShiftSelect.value = currentValue;
  }
  
  // C·∫≠p nh·∫≠t cho b·ªô l·ªçc ca
  const filterShiftSelect = document.getElementById('filter-debt-shift');
  filterShiftSelect.innerHTML = '<option value="all">T·∫•t c·∫£ c√°c ca</option>';
  
  if (currentShift.shiftKey) {
    const option = document.createElement('option');
    option.value = currentShift.shiftKey;
    option.textContent = `Ca hi·ªán t·∫°i (${formatShiftName(currentShift.shiftKey)})`;
    filterShiftSelect.appendChild(option);
  }
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = formatShiftName(shift);
    filterShiftSelect.appendChild(option);
  });
  
  // C·∫≠p nh·∫≠t cho modal import
  const importShiftSelect = document.getElementById('import-shift');
  importShiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = formatShiftName(shift);
    importShiftSelect.appendChild(option);
  });
}

// ƒê·ªãnh d·∫°ng t√™n ca
function formatShiftName(shiftKey) {
  if (/^\d{4}-\d{2}-\d{2}/.test(shiftKey)) {
    const d = new Date(shiftKey);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}-${month}-${year}`;
  }
  return shiftKey;
}

// X√°c ƒë·ªãnh ca hi·ªán t·∫°i (18h30 h√¥m nay ƒë·∫øn 6h30 s√°ng h√¥m sau)
function getCurrentShift() {
  const now = new Date();
  const currentHour = now.getHours();
  const currentMinutes = now.getMinutes();

  let shiftStart = new Date(now);
  let shiftEnd = new Date(now);

  if (currentHour < 6 || (currentHour === 6 && currentMinutes < 30)) {
    shiftStart.setDate(shiftStart.getDate() - 1);
    shiftStart.setHours(18, 30, 0, 0);
    shiftEnd.setHours(6, 30, 0, 0);
  } 
  else if (currentHour > 18 || (currentHour === 18 && currentMinutes >= 30)) {
    shiftStart.setHours(18, 30, 0, 0);
    shiftEnd.setDate(shiftEnd.getDate() + 1);
    shiftEnd.setHours(6, 30, 0, 0);
  }
  else {
    return {
      shift: 'Ngo√†i ca l√†m vi·ªác',
      shiftKey: null,
      start: null,
      end: null
    };
  }

  const shiftKey = `${shiftStart.getFullYear()}-${String(shiftStart.getMonth() + 1).padStart(2, '0')}-${String(shiftStart.getDate()).padStart(2, '0')}`;
  
  return {
    shift: `Ca ${formatShiftName(shiftKey)}`,
    shiftKey: shiftKey,
    start: shiftStart,
    end: shiftEnd
  };
}

// C·∫≠p nh·∫≠t danh s√°ch ƒëi·ªÉm
function updateDiemOptions() {
  const diemList = document.getElementById('debt-diem-list');
  diemList.innerHTML = '';
  
  const uniqueDiems = new Set();
  allMainData.forEach(item => {
    if (item.ten_diem && !uniqueDiems.has(item.ten_diem)) {
      const opt = document.createElement('option');
      opt.value = item.ten_diem;
      diemList.appendChild(opt);
      uniqueDiems.add(item.ten_diem);
    }
  });
}

// C·∫≠p nh·∫≠t n√∫t th√™m nhanh (5 ƒëi·ªÉm gas th∆∞·ªùng xuy√™n nh·∫•t)
function updateQuickAddButtons() {
  const quickAddContainer = document.getElementById('quick-add-buttons');
  quickAddContainer.innerHTML = '';
  
  // ƒê·∫øm t·∫ßn su·∫•t xu·∫•t hi·ªán c·ªßa c√°c ƒëi·ªÉm gas
  const diemCount = {};
  allMainData.forEach(item => {
    if (item.ten_diem) {
      diemCount[item.ten_diem] = (diemCount[item.ten_diem] || 0) + 1;
    }
  });
  
  // S·∫Øp x·∫øp theo t·∫ßn su·∫•t gi·∫£m d·∫ßn v√† l·∫•y 5 ƒëi·ªÉm ƒë·∫ßu
  const topDiems = Object.entries(diemCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(item => item[0]);
  
  // T·∫°o n√∫t th√™m nhanh
  topDiems.forEach(diem => {
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'quick-add-btn';
    button.textContent = diem;
    button.onclick = () => {
      document.getElementById('debt-diem').value = diem;
      // T·ª± ƒë·ªông ƒëi·ªÅn s·ªë ti·ªÅn c·ªßa l·∫ßn g·∫ßn nh·∫•t
      const latestEntry = findLatestEntryForDiem(diem);
      if (latestEntry) {
        document.getElementById('debt-so-tien').value = latestEntry.so_tien;
        document.getElementById('debt-so-tien').focus();
      }
    };
    quickAddContainer.appendChild(button);
  });
}

// T√¨m b·∫£n ghi g·∫ßn nh·∫•t cho m·ªôt ƒëi·ªÉm gas
function findLatestEntryForDiem(diemName) {
  const diemEntries = allMainData.filter(item => item.ten_diem === diemName);
  
  if (diemEntries.length === 0) {
    return null;
  }
  
  diemEntries.sort((a, b) => {
    const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
    const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
    return timeB - timeA;
  });
  
  return diemEntries[0];
}

// Th√™m v√†o danh s√°ch thu n·ª£
function addToDebtList() {
  const diem = document.getElementById('debt-diem').value.trim();
  const soTien = document.getElementById('debt-so-tien').value.trim();
  const ghiChu = document.getElementById('debt-ghi-chu').value.trim();
  const shift = document.getElementById('debt-shift').value;
  
  if (!diem || !soTien || !shift) {
    showToast('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ch·ªçn ca!', 'error');
    return;
  }
  
  const amount = parseInt(soTien);
  if (isNaN(amount) || amount <= 0) {
    showToast('‚ö†Ô∏è S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!', 'error');
    return;
  }
  
  // L·∫•y ƒë·ªãa ch·ªâ t·ª´ cache
  const diaChi = cacheDiem[diem] || '';
  
  // Th√™m v√†o danh s√°ch
  debtList.push({
    id: Date.now() + Math.random(),
    ten_diem: diem,
    so_tien: amount,
    dia_chi: diaChi,
    ghi_chu: ghiChu,
    trang_thai_thu: 'pending', // pending, success, failed
    trang_thai_hien_thi: 'Ch∆∞a thu',
    ca: shift,
    timestamp: new Date().toISOString()
  });
  
  // L∆∞u v√†o localStorage
  saveDebtListToStorage();
  
  // Reset form
  clearDebtForm();
  
  // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
  updateDebtListDisplay();
  
  showToast('‚úÖ ƒê√£ th√™m v√†o danh s√°ch thu n·ª£!');
}

// X√≥a form
function clearDebtForm() {
  document.getElementById('debt-diem').value = '';
  document.getElementById('debt-so-tien').value = '';
  document.getElementById('debt-ghi-chu').value = '';
  document.getElementById('debt-diem').focus();
}

// C·∫≠p nh·∫≠t hi·ªÉn th·ªã danh s√°ch thu n·ª£
function updateDebtListDisplay() {
  const container = document.getElementById('debt-list');
  const emptyState = document.getElementById('empty-debt-state');
  const statsContainer = document.getElementById('stats-container');
  
  // L·ªçc theo ca ƒë√£ ch·ªçn (n·∫øu c√≥)
  const selectedShift = document.getElementById('debt-shift').value;
  let filteredDebtList = debtList;
  
  if (selectedShift) {
    filteredDebtList = debtList.filter(item => item.ca === selectedShift);
  }
  
  // L·ªçc theo tr·∫°ng th√°i (n·∫øu c√≥)
  const filterStatus = document.getElementById('filter-debt-status').value;
  const filterShift = document.getElementById('filter-debt-shift').value;
  
  if (filterStatus !== 'all') {
    filteredDebtList = filteredDebtList.filter(item => item.trang_thai_thu === filterStatus);
  }
  
  if (filterShift !== 'all') {
    filteredDebtList = filteredDebtList.filter(item => item.ca === filterShift);
  }
  
  if (filteredDebtList.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = 'block';
    updateStats([]);
    return;
  }
  
  emptyState.style.display = 'none';
  
  let html = '';
  let totalAmount = 0;
  let successCount = 0;
  let pendingCount = 0;
  let failedCount = 0;
  
  // S·∫Øp x·∫øp theo th·ªùi gian (m·ªõi nh·∫•t ƒë·∫ßu ti√™n)
  filteredDebtList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  filteredDebtList.forEach((item, index) => {
    totalAmount += item.so_tien;
    
    switch(item.trang_thai_thu) {
      case 'success': successCount++; break;
      case 'pending': pendingCount++; break;
      case 'failed': failedCount++; break;
    }
    
    const statusClass = item.trang_thai_thu === 'success' ? 'success' : 
                       item.trang_thai_thu === 'failed' ? 'failed' : 'pending';
    
    html += `
      <div class="debt-item ${statusClass} fade-in">
        <div class="debt-item-info">
          <div class="debt-item-name">${item.ten_diem}</div>
          <div class="debt-item-amount">${formatCurrency(item.so_tien)}</div>
          ${item.dia_chi ? `<div class="debt-item-note">${item.dia_chi}</div>` : ''}
          ${item.ghi_chu ? `<div class="debt-item-note">${item.ghi_chu}</div>` : ''}
          <div class="debt-item-note">Ca: ${formatShiftName(item.ca)}</div>
        </div>
        <div class="debt-item-actions">
          <select class="debt-status-select" onchange="updateDebtStatus('${item.id}', this.value)">
            <option value="pending" ${item.trang_thai_thu === 'pending' ? 'selected' : ''}>Ch∆∞a thu</option>
            <option value="success" ${item.trang_thai_thu === 'success' ? 'selected' : ''}>ƒê√£ thu</option>
            <option value="failed" ${item.trang_thai_thu === 'failed' ? 'selected' : ''}>H·∫πn l·∫°i</option>
          </select>
          <button class="btn-danger btn-sm" onclick="removeFromDebtList('${item.id}')">√ó</button>
        </div>
      </div>
    `;
  });
  
  // Th√™m t·ªïng k·∫øt
  html += `
    <div class="debt-summary">
      <div class="debt-summary-item">
        <span>T·ªïng s·ªë ƒëi·ªÉm:</span>
        <span>${filteredDebtList.length}</span>
      </div>
      <div class="debt-summary-item">
        <span>ƒê√£ thu:</span>
        <span>${successCount}</span>
      </div>
      <div class="debt-summary-item">
        <span>Ch∆∞a thu:</span>
        <span>${pendingCount}</span>
      </div>
      <div class="debt-summary-item">
        <span>H·∫πn l·∫°i:</span>
        <span>${failedCount}</span>
      </div>
      <div class="debt-total">
        <span>T·ªïng ti·ªÅn:</span>
        <span>${formatCurrency(totalAmount)}</span>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  updateStats(filteredDebtList);
}

// C·∫≠p nh·∫≠t th·ªëng k√™
function updateStats(data) {
  const statsContainer = document.getElementById('stats-container');
  
  if (data.length === 0) {
    statsContainer.innerHTML = `
      <div class="stat-card">
        <div class="stat-value">0</div>
        <div class="stat-label">S·ªë kho·∫£n n·ª£</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">0‚Ç´</div>
        <div class="stat-label">T·ªïng ti·ªÅn</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">0/0/0</div>
        <div class="stat-label">ƒê√£ thu/Ch∆∞a/H·∫πn</div>
      </div>
    `;
    return;
  }
  
  const totalAmount = data.reduce((sum, item) => sum + item.so_tien, 0);
  const successCount = data.filter(item => item.trang_thai_thu === 'success').length;
  const pendingCount = data.filter(item => item.trang_thai_thu === 'pending').length;
  const failedCount = data.filter(item => item.trang_thai_thu === 'failed').length;
  
  statsContainer.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${data.length}</div>
      <div class="stat-label">S·ªë kho·∫£n n·ª£</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${formatCurrency(totalAmount)}</div>
      <div class="stat-label">T·ªïng ti·ªÅn</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${successCount}/${pendingCount}/${failedCount}</div>
      <div class="stat-label">ƒê√£ thu/Ch∆∞a/H·∫πn</div>
    </div>
  `;
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i thu n·ª£
function updateDebtStatus(id, status) {
  const itemIndex = debtList.findIndex(item => item.id === id);
  
  if (itemIndex !== -1) {
    debtList[itemIndex].trang_thai_thu = status;
    debtList[itemIndex].trang_thai_hien_thi = 
      status === 'success' ? 'ƒê√£ thu' : 
      status === 'failed' ? 'H·∫πn l·∫°i' : 'Ch∆∞a thu';
    
    // L∆∞u v√†o localStorage
    saveDebtListToStorage();
    
    updateDebtListDisplay();
  }
}

// X√≥a kh·ªèi danh s√°ch thu n·ª£
function removeFromDebtList(id) {
  debtList = debtList.filter(item => item.id !== id);
  saveDebtListToStorage();
  updateDebtListDisplay();
  showToast('‚úÖ ƒê√£ x√≥a kh·ªèi danh s√°ch thu n·ª£');
}

// L·ªçc danh s√°ch thu n·ª£
function filterDebtList() {
  updateDebtListDisplay();
}

// Hi·ªÉn th·ªã modal ch·ªçn ca ƒë·ªÉ chuy·ªÉn ƒë·ªïi
function showShiftSelectionModal() {
  // L·∫•y t·∫•t c·∫£ kho·∫£n n·ª£ ƒë√£ thu th√†nh c√¥ng
  const successfulDebts = debtList.filter(item => item.trang_thai_thu === 'success');
  
  if (successfulDebts.length === 0) {
    // Hi·ªÉn th·ªã modal th√¥ng b√°o kh√¥ng c√≥ kho·∫£n n·ª£ ƒë√£ thu
    openModal('shift-selection-modal');
    document.getElementById('no-successful-debts').style.display = 'block';
    document.getElementById('shift-selection-list').style.display = 'none';
    document.getElementById('btn-process-selected-shift').style.display = 'none';
    return;
  }
  
  // Nh√≥m kho·∫£n n·ª£ theo ca
  const debtsByShift = {};
  successfulDebts.forEach(debt => {
    if (!debtsByShift[debt.ca]) {
      debtsByShift[debt.ca] = [];
    }
    debtsByShift[debt.ca].push(debt);
  });
  
  // Hi·ªÉn th·ªã c√°c t√πy ch·ªçn ca
  const shiftSelectionList = document.getElementById('shift-selection-list');
  shiftSelectionList.innerHTML = '';
  
  for (const shift in debtsByShift) {
    const shiftDebts = debtsByShift[shift];
    const totalAmount = shiftDebts.reduce((sum, debt) => sum + debt.so_tien, 0);
    
    const shiftOption = document.createElement('div');
    shiftOption.className = 'shift-option';
    shiftOption.innerHTML = `
      <input type="radio" name="selectedShift" id="shift-${shift}" value="${shift}">
      <label for="shift-${shift}">
        <strong>Ca ${formatShiftName(shift)}</strong><br>
        <small>S·ªë kho·∫£n: ${shiftDebts.length} | T·ªïng ti·ªÅn: ${formatCurrency(totalAmount)}</small>
      </label>
    `;
    
    shiftOption.addEventListener('click', function() {
      // B·ªè ch·ªçn t·∫•t c·∫£
      document.querySelectorAll('.shift-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Ch·ªçn option n√†y
      this.classList.add('selected');
      const radio = this.querySelector('input[type="radio"]');
      radio.checked = true;
      selectedShiftForProcessing = shift;
      
      // K√≠ch ho·∫°t n√∫t x√°c nh·∫≠n
      document.getElementById('btn-process-selected-shift').disabled = false;
    });
    
    shiftSelectionList.appendChild(shiftOption);
  }
  
  // ƒê·∫∑t option ƒë·∫ßu ti√™n l√† m·∫∑c ƒë·ªãnh
  const firstOption = shiftSelectionList.querySelector('.shift-option');
  if (firstOption) {
    firstOption.click();
  }
  
  // Reset modal state
  document.getElementById('no-successful-debts').style.display = 'none';
  document.getElementById('shift-selection-list').style.display = 'block';
  document.getElementById('btn-process-selected-shift').style.display = 'block';
  document.getElementById('btn-process-selected-shift').disabled = true;
  
  openModal('shift-selection-modal');
}

// X·ª≠ l√Ω c√°c kho·∫£n n·ª£ ƒë√£ thu trong ca ƒë√£ ch·ªçn
async function processSelectedShiftDebts() {
  if (!selectedShiftForProcessing) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt ca!', 'error');
    return;
  }
  
  // L·∫•y c√°c kho·∫£n n·ª£ ƒë√£ thu trong ca ƒë√£ ch·ªçn
  const successfulDebtsInShift = debtList.filter(item => 
    item.trang_thai_thu === 'success' && item.ca === selectedShiftForProcessing
  );
  
  if (successfulDebtsInShift.length === 0) {
    showToast('‚ö†Ô∏è Kh√¥ng c√≥ kho·∫£n n·ª£ n√†o ƒë√£ thu trong ca n√†y!', 'error');
    return;
  }
  
  const totalAmount = successfulDebtsInShift.reduce((sum, debt) => sum + debt.so_tien, 0);
  
  showConfirmModal(
    `X√°c nh·∫≠n chuy·ªÉn ${successfulDebtsInShift.length} kho·∫£n n·ª£ ƒë√£ thu trong ca ${formatShiftName(selectedShiftForProcessing)} th√†nh ƒëi·ªÉm gas?<br><br>
    T·ªïng ti·ªÅn: ${formatCurrency(totalAmount)}`,
    async () => {
      await processDebtCollectionForShift(successfulDebtsInShift, selectedShiftForProcessing);
    }
  );
}

// X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi kho·∫£n n·ª£ cho m·ªôt ca c·ª• th·ªÉ
async function processDebtCollectionForShift(successfulDebts, shift) {
  const btnProcess = document.getElementById('btn-process-selected-shift');
  const originalText = btnProcess.textContent;
  btnProcess.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
  btnProcess.disabled = true;
  
  let successCount = 0;
  let errorCount = 0;
  
  // X·ª≠ l√Ω t·ª´ng kho·∫£n n·ª£
  for (const debt of successfulDebts) {
    try {
      const data = {
        ten_diem: debt.ten_diem,
        so_tien: debt.so_tien,
        dia_chi: debt.dia_chi,
        ghi_chu: (debt.ghi_chu || '') + ' [Thu n·ª£]',
        trang_thai: 'ƒê√£ n·ªôp',
        ca: debt.ca,
        timestamp: new Date().toISOString()
      };
      
      const response = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.result === 'success') {
        successCount++;
        // X√≥a kh·ªèi danh s√°ch thu n·ª£
        debtList = debtList.filter(item => item.id !== debt.id);
      } else {
        errorCount++;
      }
    } catch (error) {
      errorCount++;
      console.error('L·ªói khi th√™m ƒëi·ªÉm thu n·ª£:', error);
    }
  }
  
  // L∆∞u danh s√°ch ƒë√£ c·∫≠p nh·∫≠t
  saveDebtListToStorage();
  
  // Hi·ªÉn th·ªã k·∫øt qu·∫£
  if (errorCount === 0) {
    showToast(`‚úÖ ƒê√£ chuy·ªÉn ${successCount} kho·∫£n n·ª£ th√†nh ƒëi·ªÉm gas trong ca ${formatShiftName(shift)}!`);
  } else {
    showToast(`‚ö†Ô∏è ƒê√£ chuy·ªÉn ${successCount} kho·∫£n, ${errorCount} kho·∫£n l·ªói!`, 'error');
  }
  
  // ƒê√≥ng modal v√† c·∫≠p nh·∫≠t giao di·ªán
  closeModal('shift-selection-modal');
  updateDebtListDisplay();
  
  // T·∫£i l·∫°i d·ªØ li·ªáu ch√≠nh ƒë·ªÉ c·∫≠p nh·∫≠t cache
  await loadMainData();
  
  // Reset n√∫t
  btnProcess.textContent = originalText;
  btnProcess.disabled = false;
  selectedShiftForProcessing = null;
}

// X√≥a t·∫•t c·∫£ kho·∫£n n·ª£
function clearAllDebts() {
  if (debtList.length === 0) {
    showToast('üì≠ Danh s√°ch thu n·ª£ ƒë√£ tr·ªëng!');
    return;
  }
  
  showConfirmModal(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ ${debtList.length} kho·∫£n n·ª£?`, () => {
    debtList = [];
    saveDebtListToStorage();
    updateDebtListDisplay();
    showToast('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ kho·∫£n n·ª£!');
  });
}

// L∆∞u danh s√°ch thu n·ª£ v√†o localStorage
function saveDebtListToStorage() {
  localStorage.setItem('debtList', JSON.stringify(debtList));
}

// T·∫£i danh s√°ch thu n·ª£ t·ª´ localStorage
function loadDebtListFromStorage() {
  const savedDebtList = localStorage.getItem('debtList');
  if (savedDebtList) {
    try {
      debtList = JSON.parse(savedDebtList);
      updateDebtListDisplay();
    } catch (error) {
      console.error('L·ªói khi t·∫£i danh s√°ch thu n·ª£:', error);
      debtList = [];
    }
  }
}

// Import t·ª´ d·ªØ li·ªáu ch√≠nh
function importFromMainData() {
  openModal('import-modal');
  updateImportPreview();
}

// C·∫≠p nh·∫≠t preview import
function updateImportPreview() {
  const importShift = document.getElementById('import-shift').value;
  const importStatus = document.getElementById('import-status').value;
  const previewContainer = document.getElementById('import-preview');
  const previewList = document.getElementById('import-preview-list');
  
  if (!importShift) {
    previewContainer.style.display = 'none';
    return;
  }
  
  // L·ªçc d·ªØ li·ªáu theo ca v√† tr·∫°ng th√°i
  let filteredData = allMainData.filter(item => item.ca === importShift);
  
  if (importStatus !== 'all') {
    filteredData = filteredData.filter(item => item.trang_thai === importStatus);
  }
  
  if (filteredData.length === 0) {
    previewList.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ import</p>';
    previewContainer.style.display = 'block';
    return;
  }
  
  let html = '';
  filteredData.slice(0, 10).forEach((item, index) => {
    html += `<div>${index + 1}. ${item.ten_diem} - ${formatCurrency(item.so_tien)}</div>`;
  });
  
  if (filteredData.length > 10) {
    html += `<div>... v√† ${filteredData.length - 10} ƒëi·ªÉm kh√°c</div>`;
  }
  
  previewList.innerHTML = html;
  previewContainer.style.display = 'block';
}

// X√°c nh·∫≠n import
function confirmImport() {
  const importShift = document.getElementById('import-shift').value;
  const importStatus = document.getElementById('import-status').value;
  
  if (!importShift) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn ca!', 'error');
    return;
  }
  
  // L·ªçc d·ªØ li·ªáu theo ca v√† tr·∫°ng th√°i
  let filteredData = allMainData.filter(item => item.ca === importShift);
  
  if (importStatus !== 'all') {
    filteredData = filteredData.filter(item => item.trang_thai === importStatus);
  }
  
  if (filteredData.length === 0) {
    showToast('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ import!', 'error');
    return;
  }
  
  // Th√™m v√†o danh s√°ch thu n·ª£
  let addedCount = 0;
  filteredData.forEach(item => {
    // Ki·ªÉm tra xem ƒë√£ c√≥ trong danh s√°ch thu n·ª£ ch∆∞a
    const existingDebt = debtList.find(debt => 
      debt.ten_diem === item.ten_diem && 
      debt.ca === item.ca &&
      debt.so_tien === item.so_tien
    );
    
    if (!existingDebt) {
      debtList.push({
        id: Date.now() + Math.random(),
        ten_diem: item.ten_diem,
        so_tien: item.so_tien,
        dia_chi: item.dia_chi,
        ghi_chu: item.ghi_chu || '',
        trang_thai_thu: 'pending',
        trang_thai_hien_thi: 'Ch∆∞a thu',
        ca: item.ca,
        timestamp: new Date().toISOString()
      });
      addedCount++;
    }
  });
  
  // L∆∞u v√†o localStorage
  saveDebtListToStorage();
  
  // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
  updateDebtListDisplay();
  
  // ƒê√≥ng modal
  closeModal('import-modal');
  
  showToast(`‚úÖ ƒê√£ import ${addedCount} kho·∫£n n·ª£ t·ª´ d·ªØ li·ªáu ch√≠nh!`);
}

// Xu·∫•t danh s√°ch thu n·ª£
async function exportDebtList() {
  if (debtList.length === 0) {
    showToast('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
    return;
  }
  
  let content = 'DANH S√ÅCH THU N·ª¢\n';
  content += '==================\n\n';
  
  // Nh√≥m theo ca
  const debtByShift = {};
  debtList.forEach(debt => {
    if (!debtByShift[debt.ca]) {
      debtByShift[debt.ca] = [];
    }
    debtByShift[debt.ca].push(debt);
  });
  
  for (const shift in debtByShift) {
    content += `CA: ${formatShiftName(shift)}\n`;
    content += '------------------------\n';
    
    let shiftTotal = 0;
    debtByShift[shift].forEach((debt, index) => {
      shiftTotal += debt.so_tien;
      content += `${index + 1}. ${debt.ten_diem}: ${formatNumber(debt.so_tien)} VND`;
      content += ` - ${debt.trang_thai_hien_thi}`;
      if (debt.ghi_chu) content += ` (${debt.ghi_chu})`;
      content += '\n';
    });
    
    content += `T·ªïng: ${formatNumber(shiftTotal)} VND\n\n`;
  }
  
  // T·ªïng k·∫øt
  content += 'T·ªîNG K·∫æT:\n';
  content += '==========\n';
  
  const totalAll = debtList.reduce((sum, debt) => sum + debt.so_tien, 0);
  const successCount = debtList.filter(item => item.trang_thai_thu === 'success').length;
  const pendingCount = debtList.filter(item => item.trang_thai_thu === 'pending').length;
  const failedCount = debtList.filter(item => item.trang_thai_thu === 'failed').length;
  
  content += `T·ªïng s·ªë kho·∫£n n·ª£: ${debtList.length}\n`;
  content += `ƒê√£ thu: ${successCount}\n`;
  content += `Ch∆∞a thu: ${pendingCount}\n`;
  content += `H·∫πn l·∫°i: ${failedCount}\n`;
  content += `T·ªïng ti·ªÅn: ${formatNumber(totalAll)} VND\n`;
  
  // T·∫°o file v√† download
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const link = document.createElement('a');
  const fileName = `thu_no_${new Date().toISOString().slice(0,10)}.txt`;
  
  link.download = fileName;
  link.href = URL.createObjectURL(blob);
  link.click();
  
  URL.revokeObjectURL(link.href);
  
  // Copy v√†o clipboard
  try {
    await navigator.clipboard.writeText(content);
    showToast('‚úÖ ƒê√£ xu·∫•t danh s√°ch thu n·ª£ v√† sao ch√©p v√†o clipboard!');
  } catch (error) {
    showToast('‚úÖ ƒê√£ xu·∫•t danh s√°ch thu n·ª£!');
  }
}

// Modal functions
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

function showConfirmModal(message, confirmCallback) {
  const modal = document.getElementById('confirm-modal');
  const messageElement = document.getElementById('confirm-message');
  const confirmButton = document.getElementById('confirm-action-btn');
  
  messageElement.innerHTML = message;
  
  // ƒê·∫∑t l·∫°i s·ª± ki·ªán onclick
  confirmButton.onclick = function() {
    closeModal('confirm-modal');
    if (confirmCallback) confirmCallback();
  };
  
  openModal('confirm-modal');
}

// X·ª≠ l√Ω nh·∫≠p nhanh s·ªë ti·ªÅn h√†ng ng√†n
document.getElementById('debt-so-tien').addEventListener('blur', function() {
  let value = this.value.trim();
  
  if (/^\d+$/.test(value) && value.length > 0 && value.length <= 3) {
    this.value = value + '000';
  }
});

// Kh·ªüi t·∫°o
document.addEventListener('DOMContentLoaded', async function() {
  // T·∫£i d·ªØ li·ªáu ch√≠nh
  await loadMainData();
  
  // Th√™m s·ª± ki·ªán cho c√°c select trong modal import
  document.getElementById('import-shift').addEventListener('change', updateImportPreview);
  document.getElementById('import-status').addEventListener('change', updateImportPreview);
  
  // Th√™m s·ª± ki·ªán cho √¥ nh·∫≠p ƒëi·ªÉm ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn s·ªë ti·ªÅn
  document.getElementById('debt-diem').addEventListener('change', function() {
    const diem = this.value.trim();
    if (diem) {
      const latestEntry = findLatestEntryForDiem(diem);
      if (latestEntry) {
        document.getElementById('debt-so-tien').value = latestEntry.so_tien;
        document.getElementById('debt-so-tien').focus();
        document.getElementById('debt-so-tien').select();
      }
    }
  });
  
  // Th√™m s·ª± ki·ªán cho ph√≠m Enter ƒë·ªÉ th√™m nhanh
  document.getElementById('debt-so-tien').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      addToDebtList();
    }
  });
  
  // Th√™m s·ª± ki·ªán cho ph√≠m Enter trong √¥ ƒëi·ªÉm
  document.getElementById('debt-diem').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('debt-so-tien').focus();
    }
  });
  
  // Th√™m s·ª± ki·ªán cho ph√≠m Enter trong √¥ ghi ch√∫
  document.getElementById('debt-ghi-chu').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      addToDebtList();
    }
    
  });
});
</script>
</body>
</html>