<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n l√Ω ti·ªÅn thu ƒëi·ªÉm gas theo ca</title>
<!-- Th√™m c√°c th·∫ª icon cho web v√† m√†n h√¨nh ch√≠nh iPhone -->
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="apple-touch-icon-precomposed" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Qu·∫£n l√Ω ƒëi·ªÉm gas">
<style>
  :root {
    /* M√†u s·∫Øc theo phong c√°ch Apple Liquid Glass */
    --primary: rgba(10, 132, 255, 0.9);      /* M√†u xanh d∆∞∆°ng Apple */
    --primary-dark: rgba(5, 100, 200, 0.9);
    --secondary: rgba(48, 209, 88, 0.9);     /* M√†u xanh l√° Apple */
    --danger: rgba(255, 69, 58, 0.9);        /* M√†u ƒë·ªè Apple */
    --warning: rgba(255, 159, 10, 0.9);      /* M√†u cam Apple */
    --info: rgba(100, 210, 255, 0.9);        /* M√†u xanh nh·∫°t Apple */
    --light: rgba(242, 242, 247, 0.7);       /* M√†u n·ªÅn s√°ng Apple */
    --dark: rgba(28, 28, 30, 0.9);           /* M√†u ch·ªØ t·ªëi Apple */
    --gray: rgba(142, 142, 147, 0.8);        /* M√†u x√°m Apple */
    --border: rgba(229, 229, 234, 0.6);      /* M√†u vi·ªÅn Apple */
    --glass-bg: rgba(255, 255, 255, 0.7);    /* M√†u n·ªÅn k√≠nh */
    --glass-border: rgba(255, 255, 255, 0.3); /* Vi·ªÅn k√≠nh */
    --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); /* B√≥ng ƒë·ªï m·ªÅm */
    --radius: 16px;                          /* Bo g√≥c l·ªõn h∆°n */
    --night-shift: rgba(28, 28, 30, 0.8);    /* Ch·∫ø ƒë·ªô t·ªëi */
    --day-shift: rgba(242, 242, 247, 0.8);   /* Ch·∫ø ƒë·ªô s√°ng */
    --sidebar-width: 280px;
    
    /* Hi·ªáu ·ª©ng gradient liquid */
    --gradient-primary: linear-gradient(135deg, 
      rgba(10, 132, 255, 0.8) 0%, 
      rgba(0, 122, 255, 0.6) 100%);
    --gradient-danger: linear-gradient(135deg, 
      rgba(255, 69, 58, 0.8) 0%, 
      rgba(255, 45, 85, 0.6) 100%);
    --gradient-success: linear-gradient(135deg, 
      rgba(48, 209, 88, 0.8) 0%, 
      rgba(52, 199, 89, 0.6) 100%);
    --gradient-warning: linear-gradient(135deg, 
      rgba(255, 159, 10, 0.8) 0%, 
      rgba(255, 149, 0, 0.6) 100%);
    --gradient-glass: linear-gradient(135deg, 
      rgba(255, 255, 255, 0.2) 0%, 
      rgba(255, 255, 255, 0.1) 100%);
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 
                 'Segoe UI', 'Helvetica Neue', sans-serif;
    background: linear-gradient(135deg, 
      rgba(242, 242, 247, 0.95) 0%, 
      rgba(229, 229, 234, 0.9) 100%);
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
    transition: margin-left 0.3s ease;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: var(--glass-bg);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    box-shadow: var(--glass-shadow);
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  /* Sidebar styles - Liquid Glass */
  .sidebar {
    position: fixed;
    top: 0;
    left: -280px;
    width: var(--sidebar-width);
    height: 100%;
    background: var(--glass-bg);
    backdrop-filter: blur(30px) saturate(200%);
    -webkit-backdrop-filter: blur(30px) saturate(200%);
    border-right: 1px solid var(--glass-border);
    box-shadow: 2px 0 30px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    transition: left 0.3s ease;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  
  .sidebar.open {
    left: 0;
  }
  
  .sidebar-header {
    padding: 25px 20px;
    background: var(--gradient-primary);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .sidebar-header h2 {
    font-size: 1.3rem;
    font-weight: 600;
    letter-spacing: -0.5px;
  }
  
  .close-sidebar {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 12px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .close-sidebar:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }
  
  .sidebar-content {
    padding: 20px;
    flex: 1;
  }
  
  .sidebar-item {
    display: flex;
    align-items: center;
    justify-content: left;
    gap: 15px;
    padding: 16px 18px;
    margin-bottom: 12px;
    background: var(--gradient-glass);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    width: 100%;
    text-align: left;
    font-size: 1rem;
    font-weight: 500;
    color: var(--dark);
  }

  .sidebar-item:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }
  
  .sidebar-item.active {
    background: var(--gradient-primary);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .sidebar-footer {
    padding: 20px;
    border-top: 1px solid var(--border);
    font-size: 0.85rem;
    color: var(--gray);
    text-align: center;
    background: var(--gradient-glass);
  }
  
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 1000;
    display: none;
    animation: fadeIn 0.3s ease;
  }
  
  .overlay.active {
    display: block;
  }
  
  .menu-toggle {
    background: var(--gradient-primary);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 10px 14px;
    border-radius: 14px;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .menu-toggle:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 20px rgba(10, 132, 255, 0.3);
  }
  
  /* Header styles - Liquid Glass */
  header {
    background: var(--gradient-primary);
    color: white;
    padding: 30px 35px;
    text-align: center;
    position: relative;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  header h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  
  header p {
    opacity: 0.9;
    font-size: 1.1rem;
    font-weight: 400;
  }
  
  .shift-info {
    background: var(--night-shift);
    color: white;
    padding: 20px 35px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  
  .shift-info .current-shift {
    font-weight: 600;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .shift-info .shift-time {
    font-size: 1rem;
    opacity: 0.9;
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 15px;
    border-radius: 12px;
  }
  
  .card {
    padding: 30px 35px;
    border-bottom: 1px solid var(--border);
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  
  .card:last-child {
    border-bottom: none;
  }
  
  .form-group {
    margin-bottom: 25px;
  }
  
  label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--dark);
    font-size: 1rem;
  }
  
  input, select {
    width: 100%;
    padding: 16px 18px;
    background: rgba(255, 255, 255, 0.7);
    border: 2px solid var(--border);
    border-radius: 14px;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
    color: var(--dark);
  }
  
  input:focus, select:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.9);
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15);
    transform: translateY(-1px);
  }
  
  .button-group {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }
  
  button {
    flex: 1;
    padding: 18px;
    border: none;
    border-radius: 14px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    letter-spacing: 0.3px;
    position: relative;
    overflow: hidden;
  }
  
  button::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(rgba(255, 255, 255, 0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  button:hover::after {
    opacity: 1;
  }
  
  .btn-primary {
    background: var(--gradient-primary);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(10, 132, 255, 0.3);
  }
  
  .btn-secondary {
    background: var(--gradient-glass);
    color: var(--dark);
    border: 1px solid var(--glass-border);
  }
  
  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }
  
  .btn-success {
    background: var(--gradient-success);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .btn-success:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(48, 209, 88, 0.3);
  }
  
  .btn-warning {
    background: var(--gradient-warning);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .btn-warning:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(255, 159, 10, 0.3);
  }
  
  .btn-danger {
    background: var(--gradient-danger);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .btn-danger:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(255, 69, 58, 0.3);
  }
  
  .btn-sm {
    padding: 10px 16px;
    font-size: 0.9rem;
    border-radius: 12px;
  }
  
  .table-container {
    overflow-x: auto;
    margin-top: 20px;
    border-radius: 14px;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 5px;
  }
  
  th {
    background: var(--gradient-glass);
    padding: 18px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    border-bottom: 2px solid var(--border);
    font-size: 0.95rem;
    letter-spacing: 0.3px;
  }
  
  td {
    padding: 16px 16px;
    border-bottom: 1px solid var(--border);
    transition: background-color 0.2s ease;
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  tr:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray);
  }
  
  .empty-state p {
    margin-top: 15px;
    font-size: 1.1rem;
  }
  
  .stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 25px;
  }
  
  .stat-card {
    flex: 1;
    min-width: 180px;
    background: var(--gradient-glass);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }
  
  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 5px;
  }
  
  .stat-label {
    font-size: 0.95rem;
    color: var(--gray);
  }
  
  .filter-group {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
    flex-wrap: wrap;
  }
  
  .filter-group select {
    flex: 1;
    min-width: 220px;
    background: rgba(255, 255, 255, 0.7);
  }
  
  /* Modal styles - Liquid Glass */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: modalFadeIn 0.3s ease;
  }
  
  .modal-content {
    background: var(--glass-bg);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  .modal-header {
    padding: 25px 30px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    background: var(--gradient-glass);
  }
  
  .modal-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
  }
  
  .modal-body {
    padding: 30px;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    max-height: calc(85vh - 130px);
  }
  
  .modal-footer {
    padding: 25px 30px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    flex-shrink: 0;
    margin-top: auto;
    background: var(--gradient-glass);
  }
  
  .modal-footer button {
    min-height: 48px;
    padding: 14px 24px;
  }
  
  .close-modal {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
    color: var(--gray);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 12px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .close-modal:hover {
    background: rgba(0, 0, 0, 0.1);
    color: var(--dark);
    transform: rotate(90deg);
  }
  
  /* Responsive styles */
  @media (max-width: 768px) {
    body {
      padding: 15px;
    }
    
    header {
      padding: 25px 20px;
    }
    
    header h1 {
      font-size: 1.6rem;
    }
    
    .shift-info {
      padding: 18px 20px;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    
    .card {
      padding: 25px 20px;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .stats-container {
      flex-direction: column;
    }
    
    .filter-group {
      flex-direction: column;
    }
    
    .filter-group select {
      min-width: 100%;
    }
    
    th, td {
      padding: 14px 12px;
      font-size: 0.9rem;
    }
    
    table {
      min-width: 600px;
    }
    
    .modal {
      padding: 10px;
    }
    
    .modal-content {
      width: 95%;
      margin: 10px;
      max-height: 90vh;
    }
    
    .modal-header, .modal-body, .modal-footer {
      padding: 20px;
    }
    
    .modal-body {
      max-height: calc(90vh - 120px);
    }
    
    .modal-footer {
      flex-direction: column;
      gap: 12px;
      padding: 20px 15px;
    }
    
    .modal-footer button {
      width: 100%;
    }
    
    .close-modal {
      font-size: 1.6rem;
      width: 40px;
      height: 40px;
    }
    
    .table-container {
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    
    table {
      min-width: 700px;
    }
    
    .action-buttons {
      flex-direction: column;
      gap: 6px;
    }
    
    .action-buttons button {
      padding: 10px;
      font-size: 0.9rem;
      min-height: 40px;
    }
    
    .badge {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
  }
  
  @media (max-width: 480px) {
    body {
      padding: 12px;
    }
    
    header {
      padding: 22px 18px;
    }
    
    header h1 {
      font-size: 1.4rem;
    }
    
    .card {
      padding: 22px 18px;
    }
    
    input, select {
      padding: 14px 16px;
      font-size: 16px;
    }
    
    button {
      padding: 16px;
      min-height: 50px;
    }
    
    .btn-sm {
      min-height: 38px;
    }
    
    .modal-content {
      width: 98%;
      margin: 5px;
      max-height: 95vh;
    }
    
    .modal-header h2 {
      font-size: 1.3rem;
    }
    
    .modal-body {
      padding: 20px 15px;
      max-height: calc(95vh - 120px);
    }
    
    .modal-footer {
      flex-direction: column;
      gap: 12px;
      padding: 20px 12px;
    }
    
    .modal-footer button {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      min-height: 50px;
      border-radius: 12px;
    }
    
    .modal-body p {
      font-size: 1rem;
      line-height: 1.5;
    }
  }
  
  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; backdrop-filter: blur(0); }
    to { opacity: 1; backdrop-filter: blur(10px); }
  }
  
  @keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  
  .fade-in {
    animation: fadeIn 0.4s ease-out;
  }
  
  .float-animation {
    animation: float 3s ease-in-out infinite;
  }
  
  .badge {
    display: inline-block;
    padding: 8px 14px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    letter-spacing: 0.3px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .badge-primary {
    background: var(--gradient-primary);
    color: white;
  }
  
  .badge-secondary {
    background: var(--gradient-success);
    color: white;
  }
  
  .badge-warning {
    background: var(--gradient-warning);
    color: white;
  }
  
  .badge-danger {
    background: var(--gradient-danger);
    color: white;
  }
  
  .badge-info {
    background: var(--gradient-glass);
    color: var(--dark);
  }
  
  .action-buttons {
    display: flex;
    gap: 8px;
  }
  
  .form-row {
    display: flex;
    gap: 20px;
  }
  
  .form-row .form-group {
    flex: 1;
  }
  
  .status-toggle {
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .status-toggle:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  }
  
  .status-toggle-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) translateY(100px);
    background: var(--gradient-primary);
    color: white;
    padding: 18px 28px;
    border-radius: 14px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    z-index: 1002;
    display: flex;
    align-items: center;
    gap: 12px;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 300px;
    text-align: center;
    justify-content: center;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    font-weight: 500;
  }

  .toast.show {
    transform: translate(-50%, -50%) translateY(0);
    opacity: 1;
  }
  
  .toast.success {
    background: var(--gradient-success);
  }
  
  .toast.error {
    background: var(--gradient-danger);
  }

  .toast.warning {
    background: var(--gradient-warning);
  }

  .diachi-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .diachi-row input {
    flex: 8 1 0%;
    min-width: 0;
  }
  
  .diachi-row button {
    flex: 2 1 0%;
    min-width: 0;
    max-width: 100px;
    white-space: nowrap;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }
  
  /* Quick view modal styles */
  .quick-view-list {
    max-height: none;
    overflow-y: visible;
    margin-top: 20px;
    border: 1px solid var(--border);
    border-radius: 14px;
    background: var(--gradient-glass);
  }
  
  .quick-view-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    transition: background-color 0.2s ease;
  }
  
  .quick-view-item:last-child {
    border-bottom: none;
  }
  
  .quick-view-item:hover {
    background-color: rgba(255, 255, 255, 0.3);
  }
  
  .quick-view-item-info {
    display: flex;
    flex-direction: column;
  }
  
  .quick-view-item-name {
    font-weight: 600;
    color: var(--dark);
    font-size: 1.05rem;
  }
  
  .quick-view-item-address {
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 4px;
  }
  
  .quick-view-item-amount {
    font-weight: 700;
    color: var(--primary);
    font-size: 1.2rem;
  }
  
  .quick-view-total {
    padding: 20px;
    background: var(--gradient-glass);
    border-top: 1px solid var(--border);
    font-weight: 700;
    text-align: center;
    color: var(--dark);
    font-size: 1.1rem;
    border-radius: 0 0 14px 14px;
  }
  
  /* Style cho √¥ s·ªë ti·ªÅn khi ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn */
  #so_tien {
    transition: all 0.3s ease;
  }
  
  #so_tien:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 4px rgba(48, 209, 88, 0.15);
    background-color: rgba(255, 255, 255, 0.9);
  }
  
  /* Style cho n√∫t l∆∞u v·ªã tr√≠ khi ƒë√£ c√≥ GPS */
  .btn-location-disabled {
    background: rgba(142, 142, 147, 0.5) !important;
    cursor: not-allowed !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
  }
  
  .btn-location-disabled:hover {
    transform: none !important;
    box-shadow: none !important;
  }
  
  /* Style cho modal b√°o c√°o */
  #report-summary {
    border-left: 4px solid var(--primary);
    margin-top: 25px;
    padding: 20px;
    background: var(--gradient-glass);
    border-radius: 14px;
  }
  
  #report-details {
    line-height: 1.6;
    font-size: 1.05rem;
  }
  
  .recipient-row {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  .recipient-row input {
    flex: 1;
  }
  
  .recipient-row button {
    min-width: 90px;
  }
  
  /* Style cho ph·∫ßn chi ti√™u */
  .expense-input-group {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  .expense-input-group input {
    flex: 1;
  }
  
  .expense-input-group button {
    min-width: 90px;
  }
  
  .expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 18px;
    margin-bottom: 10px;
    background: var(--gradient-glass);
    border-radius: 14px;
    border: 1px solid var(--glass-border);
  }
  
  .expense-item:last-child {
    margin-bottom: 0;
  }
  
  .expense-item-info {
    display: flex;
    flex-direction: column;
  }
  
  .expense-item-name {
    font-weight: 600;
    color: var(--dark);
  }
  
  .expense-item-amount {
    font-weight: 700;
    color: var(--danger);
    font-size: 1.1rem;
  }
  
  .expense-item-delete {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    font-size: 1.3rem;
    padding: 6px;
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .expense-item-delete:hover {
    background: rgba(255, 69, 58, 0.1);
    transform: scale(1.1);
  }
  
  .expense-total {
    margin-top: 20px;
    padding: 18px;
    background: var(--gradient-glass);
    border-radius: 14px;
    font-weight: 700;
    text-align: center;
    color: var(--danger);
    font-size: 1.2rem;
    border: 1px solid var(--glass-border);
  }
  
  @media (max-width: 768px) {
    .diachi-row input {
      flex: 8 1 0%;
    }
    
    .diachi-row button {
      flex: 2 1 0%;
      max-width: 95px;
      font-size: 0.95rem;
      padding-left: 0.3em;
      padding-right: 0.3em;
    }
    
    .quick-view-item {
      padding: 14px 16px;
    }
    
    .recipient-row {
      flex-direction: column;
    }
    
    .recipient-row button {
      width: 100%;
    }
    
    .expense-input-group {
      flex-direction: column;
    }
    
    .expense-input-group button {
      width: 100%;
    }
  }
  
  @media (max-width: 480px) {
    .diachi-row input {
      flex: 8 1 0%;
    }
    
    .diachi-row button {
      flex: 2 1 0%;
      max-width: 75px;
      font-size: 0.9rem;
      padding-left: 0.2em;
      padding-right: 0.2em;
    }
    
    .quick-view-item {
      padding: 12px 14px;
    }
    
    .quick-view-item-name {
      font-size: 1rem;
    }
    
    .quick-view-item-amount {
      font-size: 1.1rem;
    }
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 10px;
  }
  
  ::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: rgba(142, 142, 147, 0.4);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(142, 142, 147, 0.6);
  }
  
  /* N√∫t cu·ªôn v·ªÅ ƒë·∫ßu trang */
  #scrollTopBtn {
    position: fixed;
    right: 30px;
    bottom: 30px;
    z-index: 999;
    background: var(--gradient-primary);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    box-shadow: 0 6px 20px rgba(10, 132, 255, 0.3);
    font-size: 2.2rem;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  
  #scrollTopBtn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 10px 30px rgba(10, 132, 255, 0.4);
  }

  /* Hi·ªáu ·ª©ng liquid cho c√°c container */
  .liquid-effect {
    position: relative;
    overflow: hidden;
  }
  
  .liquid-effect::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.2),
      transparent
    );
    transition: left 0.7s ease;
  }
  
  .liquid-effect:hover::before {
    left: 100%;
  }

  /* Hi·ªáu ·ª©ng cho c√°c icon */
  .icon-glow {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }
</style>
</head>
<body>
  <!-- Overlay cho sidebar -->
  <div class="overlay" id="sidebar-overlay"></div>
  
  <!-- Toast notification -->
  <div class="toast" id="toast">
    <span id="toast-message">ƒê√£ sao ch√©p v√†o clipboard!</span>
  </div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>üì± MenuBar</h2>
      <button class="close-sidebar" id="close-sidebar">&times;</button>
    </div>
    <div class="sidebar-content">
      <button class="sidebar-item liquid-effect" onclick="exportToText()">
        <span class="icon-glow">üìÑ</span> Xu·∫•t d·ªØ li·ªáu
      </button>
      <button class="sidebar-item liquid-effect" onclick="closeSidebar(); window.location.href='diemtien.html'">
        <span class="icon-glow">üíµ</span> ƒê·∫øm ti·ªÅn
      </button>
      <button class="sidebar-item liquid-effect" onclick="openOutOfHoursModal()">
        <span class="icon-glow">‚è∞</span> Th√™m ƒëi·ªÉm ngo√†i ca
      </button>
      <button class="sidebar-item liquid-effect" onclick="openBatchStatusModal()">
        <span class="icon-glow">üîÑ</span> Chuy·ªÉn tr·∫°ng th√°i
      </button>
      <button class="sidebar-item liquid-effect" onclick="openReportModal()">
        <span class="icon-glow">üìä</span> B√°o c√°o cu·ªëi ca
      </button>
      <button class="sidebar-item liquid-effect" onclick="closeSidebar(); window.location.href='vitri.html'">
        <span class="icon-glow">üìç</span> Qu·∫£n l√Ω v·ªã tr√≠
      </button>
      <button class="sidebar-item liquid-effect" onclick="closeSidebar(); window.location.href='tinhluong.html'">
        <span class="icon-glow">üí∞</span> T√≠nh c√¥ng & l∆∞∆°ng
      </button>
      <button class="sidebar-item liquid-effect" onclick="openQuickViewModal()">
        <span class="icon-glow">üëÅÔ∏è</span> Xem nhanh ƒëi·ªÉm (ca)
      </button>
      <button class="sidebar-item liquid-effect" onclick="openModal('help-modal')">
        <span class="icon-glow">‚ùì</span> Tr·ª£ gi√∫p
      </button>
      <button class="sidebar-item liquid-effect" onclick="resetForm()">
        <span class="icon-glow">‚ùå</span> ƒê√≥ng
      </button>
    </div>
    <div class="sidebar-footer">
      <p>Qu·∫£n l√Ω ƒëi·ªÉm gas &copy; 2025</p>
      <p style="margin-top: 5px; font-size: 0.8rem; opacity: 0.7;">Apple Liquid Glass Design</p>
    </div>
  </div>

  <div class="container">
    <header>
      <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
      <h1>üì± Qu·∫£n l√Ω ti·ªÅn ƒëi·ªÉm gas</h1>
      <p>Theo d√µi v√† qu·∫£n l√Ω thu chi t·∫°i c√°c ƒëi·ªÉm gas theo ca l√†m vi·ªác</p>
    </header>
    
    <div class="shift-info">
      <div class="current-shift" id="current-shift">
        <span>‚è∞</span> ƒêang t·∫£i th√¥ng tin ca...
      </div>
      <div class="shift-time" id="shift-time"></div>
    </div>
    
    <div class="card">
      <div class="stats-container" id="stats-container">
        <!-- Th·ªëng k√™ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
      
      <div class="filter-group">
        <select id="filter-shift" onchange="filterByShift()">
          <option value="all">T·∫•t c·∫£ c√°c ca</option>
          <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </select>
        <select id="filter-diem" onchange="filterByDiem()">
          <option value="all">T·∫•t c·∫£ ƒëi·ªÉm gas</option>
          <!-- C√°c t√πy ch·ªçn ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </select>
        <select id="filter-trangthai" onchange="filterByTrangThai()">
          <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
          <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
        </select>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="chon_diem">Ch·ªçn ƒëi·ªÉm:</label>
          <input id="chon_diem" list="diem-list" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn ƒëi·ªÉm..." oninput="chonDiem()">
          <datalist id="diem-list"></datalist>
        </div>
        
        <div class="form-group">
          <label for="trang_thai">Tr·∫°ng th√°i:</label>
          <select id="trang_thai">
            <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
            <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="ten_diem">T√™n ƒëi·ªÉm:</label>
        <input id="ten_diem" placeholder="Nh·∫≠p t√™n ƒëi·ªÉm (n·∫øu th√™m m·ªõi)">
      </div>
      
      <div class="form-group">
        <label for="so_tien">S·ªë ti·ªÅn:</label>
        <input id="so_tien" type="number" placeholder="Nh·∫≠p s·ªë ti·ªÅn">
      </div>
      
      <div class="form-group">
        <label for="dia_chi">ƒê·ªãa ch·ªâ:</label>
        <div class="diachi-row">
          <input id="dia_chi" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
          <button class="btn-success btn-sm liquid-effect" type="button" id="btn-save-location" title="L∆∞u v·ªã tr√≠ GPS">üìç L∆∞u</button>
        </div>
      </div>
      
      <div class="form-group">
        <label for="ghi_chu">Ghi ch√∫:</label>
        <input id="ghi_chu" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)">
      </div>
      
      <div class="button-group">
        <button class="btn-primary liquid-effect" onclick="guiDuLieu()" id="btn-submit">
          <span class="icon-glow">üíæ</span> L∆∞u th√¥ng tin
        </button>
        <button class="btn-secondary liquid-effect" onclick="taiDuLieu()">
          <span class="icon-glow">üîÑ</span> T·∫£i l·∫°i
        </button>
        <button class="btn-warning liquid-effect" onclick="resetForm()" id="btn-cancel" style="display: none;">
          <span class="icon-glow">‚ùå</span> H·ªßy
        </button>
      </div>
    </div>
    
    <div class="card">
      <h2 style="margin-bottom: 20px; font-size: 1.5rem; color: var(--dark);">üìä Danh s√°ch ƒëi·ªÉm gas theo ca</h2>
      <div class="table-container">
        <table id="bang">
          <thead>
            <tr>
              <th>T√™n ƒëi·ªÉm</th>
              <th>S·ªë ti·ªÅn</th>
              <th>ƒê·ªãa ch·ªâ</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ca</th>
              <th>Th·ªùi gian</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </tbody>
        </table>
        <div id="empty-state" class="empty-state" style="display: none;">
          <div style="font-size: 4rem; margin-bottom: 20px;">üì≠</div>
          <h3 style="margin-bottom: 10px; color: var(--gray);">Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
          <p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>
        </div>
      </div>
    </div>
  </div>

  <!-- N√∫t cu·ªôn v·ªÅ ƒë·∫ßu trang -->
  <button id="scrollTopBtn" class="liquid-effect">‚Üë</button>

  <!-- Modal x√°c nh·∫≠n x√≥a -->
  <div class="modal" id="delete-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ö†Ô∏è X√°c nh·∫≠n x√≥a</h2>
        <button class="close-modal" onclick="closeModal('delete-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒëi·ªÉm gas n√†y?</p>
        <p id="delete-item-info" style="font-weight: bold; margin-top: 15px; padding: 15px; background: var(--gradient-glass); border-radius: 12px;"></p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary liquid-effect" onclick="closeModal('delete-modal')">H·ªßy</button>
        <button class="btn-danger liquid-effect" onclick="confirmDelete()">X√≥a</button>
      </div>
    </div>
  </div>

  <!-- Modal tr·ª£ gi√∫p -->
  <div class="modal" id="help-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ùì Tr·ª£ gi√∫p</h2>
        <button class="close-modal" onclick="closeModal('help-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <h3 style="margin-bottom: 15px;">C√°ch s·ª≠ d·ª•ng:</h3>
        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
          <li>Ch·ªçn ƒëi·ªÉm gas t·ª´ danh s√°ch ho·∫∑c th√™m m·ªõi</li>
          <li>Nh·∫≠p s·ªë ti·ªÅn thu ƒë∆∞·ª£c (c√≥ th·ªÉ nh·∫≠p s·ªë v√† th√™m '000' t·ª± ƒë·ªông)</li>
          <li>Ch·ªçn tr·∫°ng th√°i ƒë√£ n·ªôp ho·∫∑c ch∆∞a n·ªôp</li>
          <li>Nh·∫•n "L∆∞u th√¥ng tin" ƒë·ªÉ l∆∞u d·ªØ li·ªáu</li>
          <li>Xu·∫•t d·ªØ li·ªáu vƒÉn b·∫£n t·ª´ menu ƒë·ªÉ chia s·∫ª ho·∫∑c in ·∫•n</li>
        </ul>
        <div style="margin-top: 20px; padding: 15px; background: var(--gradient-glass); border-radius: 12px;">
          <strong>üí° M·∫πo:</strong> S·ª≠ d·ª•ng ch·ª©c nƒÉng "L∆∞u v·ªã tr√≠" ƒë·ªÉ ghi l·∫°i GPS th·ª±c t·∫ø c·ªßa ƒëi·ªÉm gas.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary liquid-effect" onclick="closeModal('help-modal')">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- Modal xem nhanh ƒëi·ªÉm trong ca -->
  <div class="modal" id="quick-view-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üëÅÔ∏è Xem nhanh KQ</h2>
        <button class="close-modal" onclick="closeModal('quick-view-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="quick-view-shift">Ch·ªçn ca:</label>
          <select id="quick-view-shift" onchange="updateQuickViewList()">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div id="quick-view-empty" class="empty-state" style="display: none;">
          <p>üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu cho ca n√†y</p>
        </div>
        
        <div class="quick-view-list" id="quick-view-list" style="display: none;">
          <!-- Danh s√°ch ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
        
        <div class="quick-view-total" id="quick-view-total" style="display: none;">
          <!-- T·ªïng ti·ªÅn s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary liquid-effect" onclick="closeModal('quick-view-modal')">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- Modal th√™m ƒëi·ªÉm ngo√†i ca -->
  <div class="modal" id="out-of-hours-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚è∞ Th√™m ƒëi·ªÉm ngo√†i ca</h2>
        <button class="close-modal" onclick="closeModal('out-of-hours-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Hi·ªán t·∫°i b·∫°n ƒëang ngo√†i gi·ªù l√†m vi·ªác (6:30 - 18:30). Vui l√≤ng ch·ªçn ca ƒë·ªÉ th√™m ƒëi·ªÉm:</p>
        
        <div class="form-group">
          <label for="out-of-hours-shift">Ch·ªçn ca:</label>
          <select id="out-of-hours-shift">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="custom-shift-date">Ho·∫∑c ch·ªçn ng√†y kh√°c:</label>
          <input type="date" id="custom-shift-date">
        </div>
        
        <div class="form-group">
          <button class="btn-primary liquid-effect" onclick="useCustomShift()" style="width: 100%;">
            <span class="icon-glow">üìÖ</span> S·ª≠ d·ª•ng ng√†y ƒë√£ ch·ªçn
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary liquid-effect" onclick="closeModal('out-of-hours-modal')">H·ªßy</button>
        <button class="btn-primary liquid-effect" onclick="confirmOutOfHoursShift()">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Modal chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t -->
  <div class="modal" id="batch-status-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîÑ Chuy·ªÉn tr·∫°ng th√°i</h2>
        <button class="close-modal" onclick="closeModal('batch-status-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Ch·ªçn ca v√† tr·∫°ng th√°i m·ªõi ƒë·ªÉ chuy·ªÉn ƒë·ªïi ƒë·ªìng lo·∫°t t·∫•t c·∫£ ƒëi·ªÉm gas trong ca ƒë√≥:</p>
        
        <div class="form-group">
          <label for="batch-status-shift">Ch·ªçn ca:</label>
          <select id="batch-status-shift">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="batch-status-new-status">Tr·∫°ng th√°i m·ªõi:</label>
          <select id="batch-status-new-status">
            <option value="ƒê√£ n·ªôp">ƒê√£ n·ªôp</option>
            <option value="Ch∆∞a n·ªôp">Ch∆∞a n·ªôp</option>
          </select>
        </div>
        
        <div id="batch-status-info" style="margin-top: 20px; padding: 20px; background: var(--gradient-glass); border-radius: 14px; display: none;">
          <p id="batch-status-summary" style="font-weight: 600;"></p>
          <p id="batch-status-details" style="font-size: 0.95rem; margin-top: 10px; color: var(--gray);"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary liquid-effect" onclick="closeModal('batch-status-modal')">H·ªßy</button>
        <button class="btn-primary liquid-effect" id="batch-status-confirm" onclick="confirmBatchStatusUpdate()" disabled>X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- TH√äM MODAL M·ªöI: B√ÅO C√ÅO CU·ªêI CA -->
  <div class="modal" id="report-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìä B√°o c√°o cu·ªëi ca</h2>
        <button class="close-modal" onclick="closeModal('report-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="report-shift">Ch·ªçn ca c·∫ßn b√°o c√°o:</label>
          <select id="report-shift">
            <option value="">-- Ch·ªçn ca --</option>
            <!-- C√°c t√πy ch·ªçn ca s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div class="form-group">
          <label for="report-recipient">Ng∆∞·ªùi nh·∫≠n b√°o c√°o:</label>
          <div class="recipient-row">
            <input id="report-recipient" list="recipient-list" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n">
            <button class="btn-success btn-sm liquid-effect" onclick="saveRecipient()">L∆∞u</button>
          </div>
          <datalist id="recipient-list">
            <!-- Danh s√°ch ng∆∞·ªùi nh·∫≠n s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </datalist>
        </div>
        
        <!-- TH√äM PH·∫¶N NH·∫¨P CHI TI√äU -->
        <div class="form-group">
          <label for="expense-name">Chi ti√™u trong ca:</label>
          <div class="expense-input-group">
            <input id="expense-name" list="expense-templates-list" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p t√™n chi ti√™u">
            <input id="expense-amount" type="number" placeholder="S·ªë ti·ªÅn">
            <button class="btn-warning btn-sm liquid-effect" onclick="addExpense()">Th√™m</button>
          </div>
          <datalist id="expense-templates-list">
            <!-- Danh s√°ch chi ti√™u m·∫´u s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </datalist>
        </div>
        
        <div id="expenses-list">
          <!-- Danh s√°ch chi ti√™u s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
        
        <div id="report-summary" style="display: none;">
          <h4 style="margin-bottom: 15px;">üìà T·ªïng k·∫øt ca:</h4>
          <p id="report-details" style="margin: 10px 0;"></p>
          <p style="font-weight: bold; color: var(--primary); font-size: 1.1rem;" id="report-total"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary liquid-effect" onclick="closeModal('report-modal')">H·ªßy</button>
        <button class="btn-primary liquid-effect" id="btn-generate-report" onclick="generateReport()" disabled>T·∫°o b√°o c√°o</button>
      </div>
    </div>
  </div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbyRnnoEd2BnD7u1pXHER17Cv95BN9Z77yUeO6oR7CFRtbUqd-SiVJqBv5ENYyARwX77fw/exec';
let cacheDiem = {};
let allData = [];
let currentShift = '';
let editingId = null;
let itemToDelete = null;
let currentFilteredData = [];
let selectedOutOfHoursShift = null;

// Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u danh s√°ch ng∆∞·ªùi nh·∫≠n
let recipientList = [];

// Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u danh s√°ch chi ti√™u m·∫´u (t∆∞∆°ng t·ª± ng∆∞·ªùi nh·∫≠n)
let expenseTemplateList = [];

// Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u danh s√°ch chi ti√™u c·ªßa ca hi·ªán t·∫°i
let currentExpenses = [];

// Bi·∫øn ƒë·ªÉ l∆∞u AudioContext cho √¢m thanh click
let audioContext = null;
let clickSoundBuffer = null;

// ========== H√ÄM T·∫†O √ÇM THANH CLICK CHO IPHONE ==========
function initAudio() {
  try {
    // T·∫°o AudioContext
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // T·∫°o √¢m thanh click ƒë∆°n gi·∫£n
    const duration = 0.1;
    const sampleRate = audioContext.sampleRate;
    const frameCount = duration * sampleRate;
    const buffer = audioContext.createBuffer(1, frameCount, sampleRate);
    const channelData = buffer.getChannelData(0);
    
    // T·∫°o s√≥ng sine ng·∫Øn cho √¢m thanh click
    for (let i = 0; i < frameCount; i++) {
      channelData[i] = Math.sin(2 * Math.PI * 800 * i / sampleRate) * 
                      Math.exp(-i / (sampleRate * 0.01));
    }
    
    clickSoundBuffer = buffer;
  } catch (error) {
    console.log("Kh√¥ng th·ªÉ kh·ªüi t·∫°o √¢m thanh:", error);
  }
}

// H√†m ph√°t √¢m thanh click
function playClickSound() {
  try {
    if (!audioContext) {
      initAudio();
    }
    
    if (audioContext && clickSoundBuffer) {
      const source = audioContext.createBufferSource();
      source.buffer = clickSoundBuffer;
      
      const gainNode = audioContext.createGain();
      gainNode.gain.value = 0.3;
      
      source.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      source.start();
      
      // T·ª± ƒë·ªông ng·∫Øt k·∫øt n·ªëi sau khi ph√°t xong
      source.onended = () => {
        source.disconnect();
        gainNode.disconnect();
      };
      
      return true;
    }
  } catch (error) {
    console.log("Kh√¥ng th·ªÉ ph√°t √¢m thanh:", error);
  }
  return false;
}

// ========== H√ÄM PH·∫¢N H·ªíI X√öC GI√ÅC (RUNG/√ÇM THANH) ==========
function provideHapticFeedback(type = 'short') {
  // Th·ª≠ rung tr∆∞·ªõc (cho Android v√† c√°c thi·∫øt b·ªã h·ªó tr·ª£)
  let vibrated = false;
  
  if ("vibrate" in navigator) {
    try {
      switch(type) {
        case 'short':
          navigator.vibrate(50);
          break;
        case 'long':
          navigator.vibrate(100);
          break;
        case 'success':
          navigator.vibrate([50, 30, 50]);
          break;
        case 'error':
          navigator.vibrate([100, 50, 100]);
          break;
        default:
          navigator.vibrate(50);
      }
      vibrated = true;
    } catch (error) {
      console.log("L·ªói khi rung:", error);
    }
  }
  
  // N·∫øu kh√¥ng rung ƒë∆∞·ª£c (iPhone) th√¨ ph√°t √¢m thanh click
  if (!vibrated) {
    playClickSound();
  }
}

// H√†m rung/√¢m thanh ng·∫Øn cho thao t√°c nh·∫π
function vibrateShort() {
  provideHapticFeedback('short');
}

// H√†m rung/√¢m thanh d√†i cho thao t√°c quan tr·ªçng
function vibrateLong() {
  provideHapticFeedback('long');
}

// H√†m rung/√¢m thanh cho th√†nh c√¥ng
function vibrateSuccess() {
  provideHapticFeedback('success');
}

// H√†m rung/√¢m thanh cho l·ªói
function vibrateError() {
  provideHapticFeedback('error');
}

// H√ÄM M·ªöI: M·ªü modal b√°o c√°o cu·ªëi ca
function openReportModal() {
  closeSidebar();
  vibrateShort();
  
  // Load danh s√°ch ng∆∞·ªùi nh·∫≠n t·ª´ localStorage
  loadRecipients();
  
  // Load danh s√°ch chi ti√™u m·∫´u t·ª´ localStorage
  loadExpenseTemplates();
  
  // Reset danh s√°ch chi ti√™u c·ªßa ca hi·ªán t·∫°i
  currentExpenses = [];
  updateExpensesList();
  
  // ƒêi·ªÅn danh s√°ch ca
  const shifts = new Set();
  allData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  const shiftSelect = document.getElementById('report-shift');
  shiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    }
    
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftSelect.appendChild(option);
  });
  
  // Reset th√¥ng tin
  document.getElementById('report-summary').style.display = 'none';
  document.getElementById('btn-generate-report').disabled = true;
  
  openModal('report-modal');
}

// H√ÄM M·ªöI: T·∫£i danh s√°ch ng∆∞·ªùi nh·∫≠n t·ª´ localStorage
function loadRecipients() {
  const savedRecipients = localStorage.getItem('gas_point_recipients');
  if (savedRecipients) {
    recipientList = JSON.parse(savedRecipients);
  } else {
    // Danh s√°ch m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
    recipientList = ['anh √∫t', 'ph∆∞·ªõc'];
  }
  
  // C·∫≠p nh·∫≠t datalist
  const recipientDatalist = document.getElementById('recipient-list');
  recipientDatalist.innerHTML = '';
  recipientList.forEach(recipient => {
    const option = document.createElement('option');
    option.value = recipient;
    recipientDatalist.appendChild(option);
  });
}

// H√ÄM M·ªöI: T·∫£i danh s√°ch chi ti√™u m·∫´u t·ª´ localStorage
function loadExpenseTemplates() {
  const savedExpenses = localStorage.getItem('gas_point_expense_templates');
  if (savedExpenses) {
    expenseTemplateList = JSON.parse(savedExpenses);
  } else {
    // Danh s√°ch m·∫´u m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
    expenseTemplateList = [
      { name: 'xƒÉng', amount: 0 }   
    ];
    localStorage.setItem('gas_point_expense_templates', JSON.stringify(expenseTemplateList));
  }
  
  // C·∫≠p nh·∫≠t datalist cho chi ti√™u
  updateExpenseTemplatesDatalist();
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t datalist cho chi ti√™u m·∫´u
function updateExpenseTemplatesDatalist() {
  const expenseDatalist = document.getElementById('expense-templates-list');
  expenseDatalist.innerHTML = '';
  
  expenseTemplateList.forEach(expense => {
    const option = document.createElement('option');
    option.value = expense.name;
    expenseDatalist.appendChild(option);
  });
}

// H√ÄM M·ªöI: L∆∞u ng∆∞·ªùi nh·∫≠n m·ªõi
function saveRecipient() {
  vibrateShort();
  
  const recipientInput = document.getElementById('report-recipient');
  const recipient = recipientInput.value.trim();
  
  if (!recipient) {
    showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!', 'error');
    vibrateError();
    return;
  }
  
  // Ki·ªÉm tra n·∫øu ch∆∞a c√≥ trong danh s√°ch th√¨ th√™m v√†o
  if (!recipientList.includes(recipient)) {
    recipientList.push(recipient);
    localStorage.setItem('gas_point_recipients', JSON.stringify(recipientList));
    
    // C·∫≠p nh·∫≠t l·∫°i datalist
    loadRecipients();
    
    showToast('‚úÖ ƒê√£ l∆∞u ng∆∞·ªùi nh·∫≠n m·ªõi!');
    vibrateSuccess();
  } else {
    showToast('‚ÑπÔ∏è Ng∆∞·ªùi nh·∫≠n ƒë√£ c√≥ trong danh s√°ch!');
    vibrateShort();
  }
  
  // C·∫≠p nh·∫≠t th√¥ng tin b√°o c√°o
  updateReportSummary();
}

// H√ÄM M·ªöI: Th√™m chi ti√™u v√†o danh s√°ch - ƒê√É C·∫¨P NH·∫¨T LOGIC
function addExpense() {
  vibrateShort();
  
  const expenseName = document.getElementById('expense-name').value.trim();
  const expenseAmount = document.getElementById('expense-amount').value.trim();
  
  if (!expenseName || !expenseAmount) {
    showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√¥ t·∫£ v√† s·ªë ti·ªÅn chi ti√™u!', 'error');
    vibrateError();
    return;
  }
  
  const amount = parseInt(expenseAmount);
  if (isNaN(amount) || amount <= 0) {
    showToast('‚ö†Ô∏è S·ªë ti·ªÅn chi ti√™u kh√¥ng h·ª£p l·ªá!', 'error');
    vibrateError();
    return;
  }
  
  // Th√™m chi ti√™u v√†o danh s√°ch hi·ªán t·∫°i
  currentExpenses.push({
    name: expenseName,
    amount: amount
  });
  
  // Ki·ªÉm tra n·∫øu t√™n chi ti√™u ch∆∞a c√≥ trong danh s√°ch m·∫´u th√¨ h·ªèi ng∆∞·ªùi d√πng
  const existingTemplate = expenseTemplateList.find(template => template.name.toLowerCase() === expenseName.toLowerCase());
  if (!existingTemplate) {
    // H·ªèi ng∆∞·ªùi d√πng c√≥ mu·ªën l∆∞u l√†m m·∫´u kh√¥ng
    if (confirm(`B·∫°n c√≥ mu·ªën l∆∞u "${expenseName}" v√†o danh s√°ch chi ti√™u m·∫´u kh√¥ng?`)) {
      expenseTemplateList.push({
        name: expenseName,
        amount: amount // L∆∞u c·∫£ s·ªë ti·ªÅn m·∫´u
      });
      localStorage.setItem('gas_point_expense_templates', JSON.stringify(expenseTemplateList));
      updateExpenseTemplatesDatalist();
      showToast('‚úÖ ƒê√£ l∆∞u v√†o danh s√°ch chi ti√™u m·∫´u!');
      vibrateSuccess();
    }
  }
  
  // C·∫≠p nh·∫≠t danh s√°ch hi·ªÉn th·ªã
  updateExpensesList();
  
  // Reset input
  document.getElementById('expense-name').value = '';
  document.getElementById('expense-amount').value = '';
  
  // C·∫≠p nh·∫≠t th√¥ng tin b√°o c√°o
  updateReportSummary();
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t danh s√°ch chi ti√™u hi·ªÉn th·ªã
function updateExpensesList() {
  const expensesList = document.getElementById('expenses-list');
  
  if (currentExpenses.length === 0) {
    expensesList.innerHTML = '';
    return;
  }
  
  let html = '<h4>üìù Chi ti√™u trong ca:</h4>';
  
  currentExpenses.forEach((expense, index) => {
    html += `
      <div class="expense-item">
        <div class="expense-item-info">
          <div class="expense-item-name">${expense.name}</div>
        </div>
        <div class="expense-item-amount">-${formatCurrency(expense.amount)}</div>
        <button class="expense-item-delete liquid-effect" onclick="removeExpense(${index})" onmousedown="vibrateShort()">√ó</button>
      </div>
    `;
  });
  
  // T√≠nh t·ªïng chi ti√™u
  const totalExpense = currentExpenses.reduce((sum, expense) => sum + expense.amount, 0);
  html += `<div class="expense-total">T·ªïng chi ti√™u: -${formatCurrency(totalExpense)}</div>`;
  
  expensesList.innerHTML = html;
}

// H√ÄM M·ªöI: X√≥a chi ti√™u kh·ªèi danh s√°ch
function removeExpense(index) {
  vibrateShort();
  currentExpenses.splice(index, 1);
  updateExpensesList();
  updateReportSummary();
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t th√¥ng tin b√°o c√°o khi ch·ªçn ca
function updateReportSummary() {
  const selectedShift = document.getElementById('report-shift').value;
  const recipient = document.getElementById('report-recipient').value;
  const summaryDiv = document.getElementById('report-summary');
  const detailsP = document.getElementById('report-details');
  const totalP = document.getElementById('report-total');
  const generateBtn = document.getElementById('btn-generate-report');
  
  if (!selectedShift || !recipient) {
    summaryDiv.style.display = 'none';
    generateBtn.disabled = true;
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift);
  
  if (shiftData.length === 0) {
    detailsP.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu cho ca n√†y';
    totalP.textContent = '';
    summaryDiv.style.display = 'block';
    generateBtn.disabled = true;
    return;
  }
  
  // T√≠nh t·ªïng ti·ªÅn doanh thu
  const totalRevenue = shiftData.reduce((sum, item) => sum + (parseInt(item.so_tien) || 0), 0);
  
  // T√≠nh t·ªïng chi ti√™u
  const totalExpense = currentExpenses.reduce((sum, expense) => sum + expense.amount, 0);
  
  // T√≠nh s·ªë ti·ªÅn th·ª±c t·∫ø (doanh thu - chi ti√™u)
  const actualAmount = totalRevenue - totalExpense;
  
  // Th·ªëng k√™
  const daNopCount = shiftData.filter(item => item.trang_thai === 'ƒê√£ n·ªôp').length;
  const chuaNopCount = shiftData.length - daNopCount;
  
  detailsP.innerHTML = `
    S·ªë ƒëi·ªÉm gas: <strong>${shiftData.length}</strong><br>
    ƒê√£ n·ªôp: <strong>${daNopCount}</strong> | Ch∆∞a n·ªôp: <strong>${chuaNopCount}</strong><br>
    T·ªïng doanh thu: <strong>${formatCurrency(totalRevenue)}</strong><br>
    T·ªïng chi ti√™u: <strong>-${formatCurrency(totalExpense)}</strong>
  `;
  
  totalP.innerHTML = `S·ªë ti·ªÅn th·ª±c t·∫ø: <span style="color: ${actualAmount >= 0 ? 'var(--primary)' : 'var(--danger)'}">${formatCurrency(actualAmount)}</span>`;
  summaryDiv.style.display = 'block';
  generateBtn.disabled = false;
}

// H√ÄM M·ªöI: T·∫°o b√°o c√°o v√† copy v√†o clipboard
async function generateReport() {
  vibrateLong();
  
  const selectedShift = document.getElementById('report-shift').value;
  const recipient = document.getElementById('report-recipient').value;
  
  if (!selectedShift || !recipient) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn ca v√† ng∆∞·ªùi nh·∫≠n!', 'error');
    vibrateError();
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift);
  
  if (shiftData.length === 0) {
    showToast('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu cho ca n√†y!', 'error');
    vibrateError();
    return;
  }
  
  // T√≠nh t·ªïng ti·ªÅn doanh thu
  const totalRevenue = shiftData.reduce((sum, item) => sum + (parseInt(item.so_tien) || 0), 0);
  
  // T√≠nh t·ªïng chi ti√™u
  const totalExpense = currentExpenses.reduce((sum, expense) => sum + expense.amount, 0);
  
  // T·∫°o n·ªôi dung b√°o c√°o theo logic m·ªõi
  let reportContent;
  
  if (currentExpenses.length > 0) {
    // N·∫øu c√≥ chi ti√™u: "Giao [ng∆∞·ªùi nh·∫≠n] [t·ªïng doanh thu] (Tr·ª´ [m√¥ t·∫£ chi ti√™u 1] [s·ªë ti·ªÅn 1], [m√¥ t·∫£ chi ti√™u 2] [s·ªë ti·ªÅn 2], ...)"
    const expenseString = currentExpenses.map(expense => 
      `${expense.name} ${formatNumber(expense.amount)}`
    ).join(', ');
    
    reportContent = `Giao ${recipient} ${formatNumber(totalRevenue)} (Tr·ª´ ${expenseString})`;
  } else {
    // N·∫øu kh√¥ng c√≥ chi ti√™u: "Giao [ng∆∞·ªùi nh·∫≠n] [t·ªïng doanh thu]"
    reportContent = `Giao ${recipient} ${formatNumber(totalRevenue)}`;
  }
  
  // Copy v√†o clipboard
  const copySuccess = await copyToClipboard(reportContent);
  
  if (copySuccess) {
    showToast('‚úÖ ƒê√£ sao ch√©p b√°o c√°o v√†o clipboard!');
    vibrateSuccess();
    closeModal('report-modal');
    
    // Hi·ªÉn th·ªã n·ªôi dung ƒë√£ copy (t√πy ch·ªçn)
    console.log('N·ªôi dung b√°o c√°o:', reportContent);
  } else {
    showToast('‚ùå Kh√¥ng th·ªÉ sao ch√©p v√†o clipboard!', 'error');
    vibrateError();
  }
}

// H√ÄM M·ªöI: ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn kh√¥ng c√≥ k√Ω hi·ªáu ti·ªÅn t·ªá
function formatNumber(amount) {
  return new Intl.NumberFormat('vi-VN').format(amount);
}

// H√ÄM M·ªöI: M·ªü modal chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t
function openBatchStatusModal() {
  closeSidebar();
  vibrateShort();
  
  const shifts = new Set();
  allData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  const shiftSelect = document.getElementById('batch-status-shift');
  shiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    }
    
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftSelect.appendChild(option);
  });
  
  // Reset th√¥ng tin
  document.getElementById('batch-status-info').style.display = 'none';
  document.getElementById('batch-status-confirm').disabled = true;
  
  openModal('batch-status-modal');
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t th√¥ng tin khi ch·ªçn ca trong modal chuy·ªÉn tr·∫°ng th√°i
function updateBatchStatusInfo() {
  vibrateShort();
  
  const selectedShift = document.getElementById('batch-status-shift').value;
  const newStatus = document.getElementById('batch-status-new-status').value;
  const infoDiv = document.getElementById('batch-status-info');
  const summary = document.getElementById('batch-status-summary');
  const details = document.getElementById('batch-status-details');
  const confirmBtn = document.getElementById('batch-status-confirm');
  
  if (!selectedShift) {
    infoDiv.style.display = 'none';
    confirmBtn.disabled = true;
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift);
  
  if (shiftData.length === 0) {
    summary.innerHTML = '‚ùå Kh√¥ng c√≥ ƒëi·ªÉm gas n√†o trong ca n√†y';
    details.innerHTML = '';
    infoDiv.style.display = 'block';
    confirmBtn.disabled = true;
    return;
  }
  
  const currentStatusCount = shiftData.filter(item => item.trang_thai === newStatus).length;
  const needUpdateCount = shiftData.length - currentStatusCount;
  
  if (needUpdateCount === 0) {
    summary.innerHTML = `‚úÖ T·∫•t c·∫£ ${shiftData.length} ƒëi·ªÉm gas ƒë√£ ·ªü tr·∫°ng th√°i "${newStatus}"`;
    details.innerHTML = `Kh√¥ng c√≥ ƒëi·ªÉm gas n√†o c·∫ßn chuy·ªÉn ƒë·ªïi`;
    infoDiv.style.display = 'block';
    confirmBtn.disabled = true;
  } else {
    summary.innerHTML = `üîÑ S·∫Ω chuy·ªÉn ${needUpdateCount}/${shiftData.length} ƒëi·ªÉm gas sang "${newStatus}"`;
    details.innerHTML = `${currentStatusCount} ƒëi·ªÉm ƒë√£ ·ªü tr·∫°ng th√°i n√†y, ${needUpdateCount} ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t`;
    infoDiv.style.display = 'block';
    confirmBtn.disabled = false;
  }
}

// H√ÄM M·ªöI: X√°c nh·∫≠n chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t - ƒê√É S·ª¨A L·ªñI
async function confirmBatchStatusUpdate() {
  vibrateLong();
  
  const selectedShift = document.getElementById('batch-status-shift').value;
  const newStatus = document.getElementById('batch-status-new-status').value;
  
  if (!selectedShift) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt ca!', 'error');
    vibrateError();
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift && item.trang_thai !== newStatus);
  
  if (shiftData.length === 0) {
    showToast('‚úÖ Kh√¥ng c√≥ ƒëi·ªÉm gas n√†o c·∫ßn chuy·ªÉn ƒë·ªïi!');
    vibrateShort();
    return;
  }
  
  const confirmBtn = document.getElementById('batch-status-confirm');
  confirmBtn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
  confirmBtn.disabled = true;
  
  let successCount = 0;
  let errorCount = 0;
  
  // C·∫≠p nh·∫≠t t·ª´ng b·∫£n ghi
  for (const item of shiftData) {
    try {
      // T·∫°o b·∫£n sao c·ªßa item ƒë·ªÉ tr√°nh thay ƒë·ªïi d·ªØ li·ªáu g·ªëc
      const updatedItem = { ...item, trang_thai: newStatus };
      
      const data = {
        action: 'update',
        ...updatedItem
      };
      
      const response = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.result === 'success') {
        successCount++;
        // C·∫≠p nh·∫≠t d·ªØ li·ªáu c·ª•c b·ªô - ƒê√É S·ª¨A: C·∫≠p nh·∫≠t to√†n b·ªô th√¥ng tin item
        const index = allData.findIndex(d => d.id === item.id);
        if (index !== -1) {
          allData[index] = updatedItem;
        }
      } else {
        errorCount++;
      }
    } catch (error) {
      errorCount++;
      console.error('L·ªói khi c·∫≠p nh·∫≠t:', error);
    }
  }
  
  // Hi·ªÉn th·ªã k·∫øt qu·∫£
  if (errorCount === 0) {
    showToast(`‚úÖ ƒê√£ chuy·ªÉn th√†nh c√¥ng ${successCount} ƒëi·ªÉm gas sang "${newStatus}"`);
    vibrateSuccess();
  } else {
    showToast(`‚ö†Ô∏è ƒê√£ chuy·ªÉn ${successCount} ƒëi·ªÉm, ${errorCount} ƒëi·ªÉm l·ªói`, 'error');
    vibrateError();
  }
  
  // ƒê√≥ng modal v√† c·∫≠p nh·∫≠t giao di·ªán - ƒê√É S·ª¨A: G·ªçi filterData() thay v√¨ taiDuLieu()
  closeModal('batch-status-modal');
  
  // C·∫≠p nh·∫≠t cacheDiem ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu nh·∫•t qu√°n
  updateCacheDiem();
  
  // C·∫≠p nh·∫≠t giao di·ªán v·ªõi d·ªØ li·ªáu c·ª•c b·ªô ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
  filterData();
  
  // Reset n√∫t x√°c nh·∫≠n
  confirmBtn.textContent = 'X√°c nh·∫≠n';
  confirmBtn.disabled = false;
}

// H√ÄM M·ªöI: C·∫≠p nh·∫≠t cacheDiem t·ª´ allData
function updateCacheDiem() {
  cacheDiem = {};
  allData.forEach(item => {
    if (item.ten_diem && item.dia_chi) {
      cacheDiem[item.ten_diem] = item.dia_chi;
    }
  });
}

// H√ÄM M·ªöI: Ki·ªÉm tra xem ƒëi·ªÉm gas ƒë√£ c√≥ v·ªã tr√≠ GPS ch∆∞a
function hasExistingGPSLocation(diemName) {
  // T√¨m t·∫•t c·∫£ c√°c b·∫£n ghi c·ªßa ƒëi·ªÉm gas n√†y
  const diemEntries = allData.filter(item => item.ten_diem === diemName);
  
  // Ki·ªÉm tra xem c√≥ b·∫£n ghi n√†o ƒë√£ c√≥ GPS kh√¥ng
  for (let i = 0; i < diemEntries.length; i++) {
    if (diemEntries[i].ghi_chu && diemEntries[i].ghi_chu.includes('[GPS:')) {
      return true;
    }
  }
  return false;
}

// H√†m hi·ªÉn th·ªã th√¥ng b√°o toast
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  
  toastMessage.textContent = message;
  toast.className = `toast ${type} show`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// H√†m sao ch√©p v√†o clipboard
async function copyToClipboard(text) {
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return true;
    } else {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textArea);
      return success;
    }
  } catch (err) {
    console.error('L·ªói khi sao ch√©p v√†o clipboard: ', err);
    return false;
  }
}

// H√†m m·ªü/ƒë√≥ng sidebar
function toggleSidebar() {
  vibrateShort();
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
}

// ƒê√≥ng sidebar
function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
}

// H√†m xu·∫•t d·ªØ li·ªáu d·∫°ng vƒÉn b·∫£n
async function exportToText() {
  closeSidebar();
  vibrateShort();
  
  const dataToExport = currentFilteredData.length > 0 ? currentFilteredData : allData;
  
  if (dataToExport.length === 0) {
    showToast('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
    vibrateError();
    return;
  }
  
  let content = '';
  dataToExport.forEach(item => {
    content += `${item.ten_diem} - ${item.so_tien}\n`;
  });
  
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const link = document.createElement('a');
  
  const shiftInfo = getCurrentShift();
  const fileName = shiftInfo.shiftKey ? `diem_gas_${shiftInfo.shiftKey}.txt` : `diem_gas_${new Date().toISOString().slice(0,10)}.txt`;
  
  link.download = fileName;
  link.href = URL.createObjectURL(blob);
  link.click();
  
  URL.revokeObjectURL(link.href);
  
  const copySuccess = await copyToClipboard(content);
  
  if (copySuccess) {
    showToast('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu v√† sao ch√©p v√†o clipboard!');
    vibrateSuccess();
  } else {
    showToast('‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu, nh∆∞ng kh√¥ng th·ªÉ sao ch√©p v√†o clipboard', 'error');
    vibrateError();
  }
}

// TH√äM H√ÄM M·ªöI: M·ªü modal th√™m ƒëi·ªÉm ngo√†i ca
function openOutOfHoursModal() {
  closeSidebar();
  vibrateShort();
  
  const shiftInfo = getCurrentShift();
  if (shiftInfo.start) {
    showToast('‚ö†Ô∏è B·∫°n ƒëang trong ca l√†m vi·ªác, h√£y s·ª≠ d·ª•ng ch·ª©c nƒÉng th√™m ƒëi·ªÉm b√¨nh th∆∞·ªùng!', 'error');
    vibrateError();
    return;
  }
  
  const shifts = new Set();
  allData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  const shiftSelect = document.getElementById('out-of-hours-shift');
  shiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    }
    
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftSelect.appendChild(option);
  });
  
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('custom-shift-date').value = today;
  
  selectedOutOfHoursShift = null;
  
  openModal('out-of-hours-modal');
}

// TH√äM H√ÄM M·ªöI: S·ª≠ d·ª•ng ng√†y t√πy ch·ªânh
function useCustomShift() {
  vibrateShort();
  
  const customDate = document.getElementById('custom-shift-date').value;
  if (!customDate) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn ng√†y!', 'error');
    vibrateError();
    return;
  }
  
  const dateObj = new Date(customDate);
  const year = dateObj.getFullYear();
  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
  const day = String(dateObj.getDate()).padStart(2, '0');
  selectedOutOfHoursShift = `${year}-${month}-${day}`;
  
  document.getElementById('out-of-hours-shift').value = selectedOutOfHoursShift;
  
  showToast(`‚úÖ ƒê√£ ch·ªçn ca ng√†y ${day}-${month}-${year}`);
  vibrateSuccess();
}

// TH√äM H√ÄM M·ªöI: X√°c nh·∫≠n ca khi th√™m ngo√†i gi·ªù
function confirmOutOfHoursShift() {
  vibrateShort();
  
  const shiftSelect = document.getElementById('out-of-hours-shift');
  const selectedShift = shiftSelect.value;
  
  if (!selectedShift) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt ca!', 'error');
    vibrateError();
    return;
  }
  
  selectedOutOfHoursShift = selectedShift;
  closeModal('out-of-hours-modal');
  
  showToast(`‚úÖ ƒê√£ ch·ªçn ca: ${formatShiftName(selectedShift)}. B·∫°n c√≥ th·ªÉ th√™m ƒëi·ªÉm gas b√¢y gi·ªù.`);
  vibrateSuccess();
  
  document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

// TH√äM H√ÄM M·ªöI: ƒê·ªãnh d·∫°ng t√™n ca
function formatShiftName(shiftKey) {
  if (/^\d{4}-\d{2}-\d{2}/.test(shiftKey)) {
    const d = new Date(shiftKey);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `Ca ${day}-${month}-${year}`;
  }
  return shiftKey;
}

// TH√äM H√ÄM M·ªöI: M·ªü modal xem nhanh
function openQuickViewModal() {
  closeSidebar();
  vibrateShort();
  
  const shifts = new Set();
  allData.forEach(item => {
    if (item.ca) shifts.add(item.ca);
  });
  
  const shiftSelect = document.getElementById('quick-view-shift');
  shiftSelect.innerHTML = '<option value="">-- Ch·ªçn ca --</option>';
  
  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    }
    
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftSelect.appendChild(option);
  });
  
  const currentShift = getCurrentShift();
  if (currentShift.shiftKey && shifts.has(currentShift.shiftKey)) {
    shiftSelect.value = currentShift.shiftKey;
    updateQuickViewList();
  }
  
  openModal('quick-view-modal');
}

// TH√äM H√ÄM M·ªöI: C·∫≠p nh·∫≠t danh s√°ch xem nhanh
function updateQuickViewList() {
  vibrateShort();
  
  const selectedShift = document.getElementById('quick-view-shift').value;
  const listContainer = document.getElementById('quick-view-list');
  const totalContainer = document.getElementById('quick-view-total');
  const emptyState = document.getElementById('quick-view-empty');
  
  listContainer.style.display = 'none';
  totalContainer.style.display = 'none';
  emptyState.style.display = 'none';
  
  if (!selectedShift) {
    emptyState.style.display = 'block';
    emptyState.innerHTML = '<p>üì≠ Vui l√≤ng ch·ªçn m·ªôt ca</p>';
    return;
  }
  
  const shiftData = allData.filter(item => item.ca === selectedShift);
  
  if (shiftData.length === 0) {
    emptyState.style.display = 'block';
    emptyState.innerHTML = '<p>üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu cho ca n√†y</p>';
    return;
  }
  
  listContainer.innerHTML = '';
  let totalAmount = 0;
  
  shiftData.forEach(item => {
    totalAmount += parseInt(item.so_tien) || 0;
    
    const itemElement = document.createElement('div');
    itemElement.className = 'quick-view-item';
    itemElement.innerHTML = `
      <div class="quick-view-item-info">
        <div class="quick-view-item-name">${item.ten_diem}</div>
        <div class="quick-view-item-address">${item.dia_chi}</div>
      </div>
      <div class="quick-view-item-amount">${formatCurrency(item.so_tien)}</div>
    `;
    
    listContainer.appendChild(itemElement);
  });
  
  totalContainer.innerHTML = `T·ªïng ti·ªÅn: <strong>${formatCurrency(totalAmount)}</strong>`;
  totalContainer.style.display = 'block';
  
  listContainer.style.display = 'block';
  
  const modalBody = document.querySelector('#quick-view-modal .modal-body');
  if (modalBody) {
    modalBody.scrollTop = 0;
  }
}

// X·ª≠ l√Ω nh·∫≠p nhanh s·ªë ti·ªÅn h√†ng ng√†n
document.getElementById('so_tien').addEventListener('blur', function() {
  let value = this.value.trim();
  
  if (/^\d+$/.test(value) && value.length > 0 && value.length <= 3) {
    this.value = value + '000';
    vibrateShort();
  }
});

// H√†m x√°c ƒë·ªãnh ca hi·ªán t·∫°i (18h30 h√¥m nay ƒë·∫øn 6h30 s√°ng h√¥m sau)
function getCurrentShift() {
  const now = new Date();
  const currentHour = now.getHours();
  const currentMinutes = now.getMinutes();

  let shiftStart = new Date(now);
  let shiftEnd = new Date(now);

  if (currentHour < 6 || (currentHour === 6 && currentMinutes < 30)) {
    shiftStart.setDate(shiftStart.getDate() - 1);
    shiftStart.setHours(18, 30, 0, 0);
    shiftEnd.setHours(6, 30, 0, 0);
  } 
  else if (currentHour > 18 || (currentHour === 18 && currentMinutes >= 30)) {
    shiftStart.setHours(18, 30, 0, 0);
    shiftEnd.setDate(shiftEnd.getDate() + 1);
    shiftEnd.setHours(6, 30, 0, 0);
  }
  else {
    return {
      shift: 'Ngo√†i ca l√†m vi·ªác',
      start: null,
      end: null
    };
  }

  const formatDate = (date) => {
    const d = date;
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    const hour = String(d.getHours()).padStart(2, '0');
    const minute = String(d.getMinutes()).padStart(2, '0');
    return `${day}-${month}-${year} ${hour}:${minute}`;
  };

  const shiftKey = `${shiftStart.getFullYear()}-${String(shiftStart.getMonth() + 1).padStart(2, '0')}-${String(shiftStart.getDate()).padStart(2, '0')}`;
  const shiftName = `Ca ${formatDate(shiftStart).split(' ')[0]}`;

  return {
    shift: shiftName,
    shiftKey: shiftKey,
    start: formatDate(shiftStart),
    end: formatDate(shiftEnd)
  };
}

// C·∫≠p nh·∫≠t th√¥ng tin ca hi·ªán t·∫°i
function updateShiftInfo() {
  const shiftInfo = getCurrentShift();
  currentShift = shiftInfo.shiftKey;
  
  document.getElementById('current-shift').textContent = shiftInfo.shift;
  
  if (shiftInfo.start && shiftInfo.end) {
    document.getElementById('shift-time').textContent = 
      `‚è∞ ${shiftInfo.start} - ${shiftInfo.end}`;
  } else {
    document.getElementById('shift-time').textContent = 
      '‚è∞ Hi·ªán t·∫°i kh√¥ng trong ca l√†m vi·ªác';
  }
}

// ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
function formatCurrency(amount) {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND'
  }).format(amount);
}

// T√≠nh to√°n th·ªëng k√™
function calculateStats(data) {
  const stats = {
    total: 0,
    count: data.length,
    shifts: new Set(),
    diem: new Set(),
    daNop: 0,
    chuaNop: 0
  };
  
  data.forEach(item => {
    stats.total += parseInt(item.so_tien) || 0;
    if (item.ca) stats.shifts.add(item.ca);
    if (item.ten_diem) stats.diem.add(item.ten_diem);
    if (item.trang_thai === 'ƒê√£ n·ªôp') {
      stats.daNop++;
    } else {
      stats.chuaNop++;
    }
  });
  
  return stats;
}

// Hi·ªÉn th·ªã th·ªëng k√™
function displayStats(stats) {
  const container = document.getElementById('stats-container');
  
  container.innerHTML = `
    <div class="stat-card liquid-effect">
      <div class="stat-value">${stats.count}</div>
      <div class="stat-label">S·ªë giao d·ªãch</div>
    </div>
    <div class="stat-card liquid-effect">
      <div class="stat-value">${formatCurrency(stats.total)}</div>
      <div class="stat-label">T·ªïng ti·ªÅn</div>
    </div>
    <div class="stat-card liquid-effect">
      <div class="stat-value">${stats.daNop}/${stats.chuaNop}</div>
      <div class="stat-label">ƒê√£ n·ªôp/Ch∆∞a n·ªôp</div>
    </div>
  `;
}

// L·ªçc d·ªØ li·ªáu theo ca
function filterByShift() {
  vibrateShort();
  filterData();
}

// L·ªçc d·ªØ li·ªáu theo ƒëi·ªÉm
function filterByDiem() {
  vibrateShort();
  filterData();
}

// L·ªçc d·ªØ li·ªáu theo tr·∫°ng th√°i
function filterByTrangThai() {
  vibrateShort();
  filterData();
}

// L·ªçc v√† hi·ªÉn th·ªã d·ªØ li·ªáu
function filterData() {
  const shiftFilter = document.getElementById('filter-shift').value;
  const diemFilter = document.getElementById('filter-diem').value;
  const trangThaiFilter = document.getElementById('filter-trangthai').value;
  
  let filteredData = allData;
  
  if (shiftFilter !== 'all') {
    filteredData = filteredData.filter(item => item.ca === shiftFilter);
  }
  
  if (diemFilter !== 'all') {
    filteredData = filteredData.filter(item => item.ten_diem === diemFilter);
  }
  
  if (trangThaiFilter !== 'all') {
    filteredData = filteredData.filter(item => item.trang_thai === trangThaiFilter);
  }

  currentFilteredData = filteredData;

  const shiftInfo = getCurrentShift();
  if (shiftFilter === shiftInfo.shiftKey && shiftInfo.start && filteredData.length === 0) {
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('empty-state').innerHTML = '<h3>üì≠ Ch∆∞a c√≥ ƒëi·ªÉm n√†o trong ca hi·ªán t·∫°i</h3><p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>';
  } else {
    document.getElementById('empty-state').innerHTML = '<h3>üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu</h3><p>H√£y th√™m ƒëi·ªÉm gas ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>';
  }

  displayData(filteredData);
  displayStats(calculateStats(filteredData));
}

// Hi·ªÉn th·ªã d·ªØ li·ªáu trong b·∫£ng
function displayData(data) {
  const tbody = document.querySelector('#bang tbody');
  tbody.innerHTML = '';
  
  const emptyState = document.getElementById('empty-state');
  if (data.length === 0) {
    emptyState.style.display = 'block';
  } else {
    emptyState.style.display = 'none';
  }
  
  data.forEach(row => {
    const tr = document.createElement('tr');
    tr.className = 'fade-in';
    
    let badgeClass = 'badge-warning';
    if (row.trang_thai === 'ƒê√£ n·ªôp') {
      badgeClass = 'badge-secondary';
    }

    let caLabel = row.ca || 'Kh√¥ng x√°c ƒë·ªãnh';
    if (/^\d{4}-\d{2}-\d{2}/.test(row.ca)) {
      const d = new Date(row.ca);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      caLabel = `${day}-${month}-${year}`;
    }
    
    tr.innerHTML = `
      <td data-label="T√™n ƒëi·ªÉm">${row.ten_diem}</td>
      <td data-label="S·ªë ti·ªÅn">${formatCurrency(row.so_tien)}</td>
      <td data-label="ƒê·ªãa ch·ªâ">${row.dia_chi}</td>
      <td data-label="Tr·∫°ng th√°i">
        <div class="status-toggle-wrapper">
          <span class="badge ${badgeClass} status-toggle liquid-effect" onclick="toggleTrangThai('${row.id}')" onmousedown="vibrateShort()">${row.trang_thai || 'Ch∆∞a n·ªôp'}</span>
        </div>
      </td>
      <td data-label="Ca"><span class="badge badge-info">${caLabel}</span></td>
      <td data-label="Th·ªùi gian">${row.timestamp ? new Date(row.timestamp).toLocaleString('vi-VN') : 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
      <td data-label="Thao t√°c">
        <div class="action-buttons">
          <button class="btn-secondary btn-sm liquid-effect" onclick="editItem('${row.id}')" onmousedown="vibrateShort()">‚úèÔ∏è S·ª≠a</button>
          <button class="btn-danger btn-sm liquid-effect" onclick="deleteItem('${row.id}')" onmousedown="vibrateShort()">üóëÔ∏è X√≥a</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// H√†m thay ƒë·ªïi tr·∫°ng th√°i nhanh
function toggleTrangThai(id) {
  vibrateShort();
  
  const item = allData.find(item => item.id === id);
  if (!item) return;

  const newTrangThai = item.trang_thai === 'ƒê√£ n·ªôp' ? 'Ch∆∞a n·ªôp' : 'ƒê√£ n·ªôp';

  const badgeElement = document.querySelector(`[onclick="toggleTrangThai('${id}')"]`);
  if (badgeElement) {
    badgeElement.textContent = newTrangThai;
    badgeElement.className = `badge ${newTrangThai === 'ƒê√£ n·ªôp' ? 'badge-secondary' : 'badge-warning'} status-toggle liquid-effect`;
  }

  const updatedItem = { ...item, trang_thai: newTrangThai };

  const data = {
    action: 'update',
    ...updatedItem
  };

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'success') {
      showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!');
      vibrateSuccess();
      const index = allData.findIndex(item => item.id === id);
      if (index !== -1) {
        allData[index] = updatedItem;
      }
      // C·∫≠p nh·∫≠t cacheDiem
      updateCacheDiem();
      filterData();
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'error');
      vibrateError();
      taiDuLieu();
    }
  })
  .catch(error => {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'error');
    vibrateError();
    console.error(error);
    taiDuLieu();
  });
}

// C·∫≠p nh·∫≠t b·ªô l·ªçc
function updateFilters(data) {
  const shifts = new Set();
  const diems = new Set();

  data.forEach(item => {
    if (item.ca) shifts.add(item.ca);
    if (item.ten_diem) diems.add(item.ten_diem);
  });

  const shiftFilter = document.getElementById('filter-shift');
  shiftFilter.innerHTML = '<option value="all">T·∫•t c·∫£ c√°c ca</option>';

  Array.from(shifts).sort().reverse().forEach(shift => {
    let shiftLabel = shift;
    if (/^\d{4}-\d{2}-\d{2}/.test(shift)) {
      const d = new Date(shift);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      shiftLabel = `Ca ${day}-${month}-${year}`;
    } else if (shift.startsWith('Ca ')) {
      shiftLabel = shift;
    }
    const option = document.createElement('option');
    option.value = shift;
    option.textContent = shiftLabel;
    shiftFilter.appendChild(option);
  });

  const diemFilter = document.getElementById('filter-diem');
  diemFilter.innerHTML = '<option value="all">T·∫•t c·∫£ ƒëi·ªÉm gas</option>';

  Array.from(diems).sort().forEach(diem => {
    const option = document.createElement('option');
    option.value = diem;
    option.textContent = diem;
    diemFilter.appendChild(option);
  });
}

// Reset form
function resetForm() {
  closeSidebar();
  vibrateShort();
  
  editingId = null;
  selectedOutOfHoursShift = null;
  document.getElementById('chon_diem').value = '';
  document.getElementById('ten_diem').value = '';
  document.getElementById('ten_diem').disabled = false;
  document.getElementById('so_tien').value = '';
  document.getElementById('dia_chi').value = '';
  document.getElementById('ghi_chu').value = '';
  document.getElementById('trang_thai').value = 'Ch∆∞a n·ªôp';
  document.getElementById('btn-submit').textContent = 'üíæ L∆∞u th√¥ng tin';
  document.getElementById('btn-cancel').style.display = 'none';
  
  // Reset n√∫t l∆∞u v·ªã tr√≠
  resetSaveLocationButton();
}

// H√ÄM M·ªöI: Reset tr·∫°ng th√°i n√∫t l∆∞u v·ªã tr√≠
function resetSaveLocationButton() {
  const btn = document.getElementById('btn-save-location');
  btn.textContent = 'üìç L∆∞u v·ªã tr√≠';
  btn.disabled = false;
  btn.className = 'btn-success btn-sm liquid-effect';
}

// H√ÄM M·ªöI: T√¨m b·∫£n ghi g·∫ßn nh·∫•t cho m·ªôt ƒëi·ªÉm gas c·ª• th·ªÉ
function findLatestEntryForDiem(diemName) {
  // L·ªçc t·∫•t c·∫£ c√°c b·∫£n ghi c·ªßa ƒëi·ªÉm gas n√†y
  const diemEntries = allData.filter(item => item.ten_diem === diemName);
  
  if (diemEntries.length === 0) {
    return null;
  }
  
  // S·∫Øp x·∫øp theo th·ªùi gian gi·∫£m d·∫ßn (m·ªõi nh·∫•t ƒë·∫ßu ti√™n)
  diemEntries.sort((a, b) => {
    const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
    const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
    return timeB - timeA;
  });
  
  // Tr·∫£ v·ªÅ b·∫£n ghi m·ªõi nh·∫•t
  return diemEntries[0];
}

// H√ÄM C·∫¨P NH·∫¨T: Ch·ªçn ƒëi·ªÉm gas (t·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ v√† s·ªë ti·ªÅn c·ªßa l·∫ßn g·∫ßn nh·∫•t)
function chonDiem() {
  vibrateShort();
  
  const val = document.getElementById('chon_diem').value;
  const tenDiemInput = document.getElementById('ten_diem');
  const diaChiInput = document.getElementById('dia_chi');
  const soTienInput = document.getElementById('so_tien');
  
  // Reset n√∫t l∆∞u v·ªã tr√≠ khi thay ƒë·ªïi ƒëi·ªÉm gas
  resetSaveLocationButton();
  
  if (!val) {
    tenDiemInput.value = '';
    diaChiInput.value = '';
    soTienInput.value = '';
    tenDiemInput.disabled = false;
    tenDiemInput.placeholder = "Nh·∫≠p t√™n ƒëi·ªÉm (n·∫øu th√™m m·ªõi)";
  } else {
    tenDiemInput.value = val;
    diaChiInput.value = cacheDiem[val] || '';
    tenDiemInput.disabled = true;
    tenDiemInput.placeholder = "T√™n ƒëi·ªÉm ƒë√£ ch·ªçn";
    
    // T√¨m s·ªë ti·ªÅn c·ªßa l·∫ßn g·∫ßn nh·∫•t cho ƒëi·ªÉm gas n√†y
    const latestEntry = findLatestEntryForDiem(val);
    if (latestEntry) {
      soTienInput.value = latestEntry.so_tien;
      // Th√™m focus ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ d·ªÖ d√†ng s·ª≠a n·∫øu mu·ªën
      setTimeout(() => {
        soTienInput.focus();
        soTienInput.select();
      }, 100);
    }
    
    // Ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t l∆∞u v·ªã tr√≠ n·∫øu ƒëi·ªÉm ƒë√£ c√≥ GPS
    if (hasExistingGPSLocation(val)) {
      const btn = document.getElementById('btn-save-location');
      btn.textContent = 'üìç ƒê√£ c√≥';
      btn.disabled = true;
      btn.className = 'btn-location-disabled btn-sm';
    }
  }
}

// X·ª≠ l√Ω n√∫t l∆∞u v·ªã tr√≠ GPS - ƒê√É C·∫¨P NH·∫¨T
function saveLocation() {
  vibrateShort();
  
  const tenDiem = document.getElementById('ten_diem').value || document.getElementById('chon_diem').value;
  
  // Ki·ªÉm tra xem ƒë√£ ch·ªçn ƒëi·ªÉm gas ch∆∞a
  if (!tenDiem) {
    showToast('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒëi·ªÉm gas tr∆∞·ªõc khi l∆∞u v·ªã tr√≠!', 'error');
    vibrateError();
    return;
  }
  
  // Ki·ªÉm tra xem ƒëi·ªÉm gas n√†y ƒë√£ c√≥ v·ªã tr√≠ GPS ch∆∞a
  if (hasExistingGPSLocation(tenDiem)) {
    showToast('‚ùå ƒêi·ªÉm gas n√†y ƒë√£ ƒë∆∞·ª£c l∆∞u v·ªã tr√≠ GPS tr∆∞·ªõc ƒë√≥!', 'error');
    vibrateError();
    return;
  }
  
  if (!navigator.geolocation) {
    showToast('‚ùå Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ GPS!', 'error');
    vibrateError();
    return;
  }
  
  const btn = document.getElementById('btn-save-location');
  btn.disabled = true;
  btn.textContent = '‚è≥ ƒêang l·∫•y v·ªã tr√≠...';
  
  navigator.geolocation.getCurrentPosition(
    function(pos) {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      let ghiChuInput = document.getElementById('ghi_chu');
      
      // X√≥a GPS c≈© n·∫øu c√≥ v√† th√™m GPS m·ªõi
      let ghiChu = ghiChuInput.value.replace(/\s*\[GPS: [\d.-]+, [\d.-]+\]/, '');
      ghiChuInput.value = ghiChu + ` [GPS: ${lat}, ${lng}]`;
      
      showToast('‚úÖ ƒê√£ l∆∞u v·ªã tr√≠ GPS th·ª±c t·∫ø!');
      vibrateSuccess();
      btn.textContent = 'üìç ƒê√£ l∆∞u v·ªã tr√≠';
      btn.disabled = false;
      
      // ƒê·ªïi m√†u n√∫t ƒë·ªÉ th·ªÉ hi·ªán ƒë√£ l∆∞u th√†nh c√¥ng
      btn.className = 'btn-success btn-sm liquid-effect';
      btn.style.backgroundColor = 'rgba(48, 209, 88, 0.9)';
    }, 
    function(err) {
      showToast('‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: ' + err.message, 'error');
      vibrateError();
      btn.textContent = 'üìç L∆∞u v·ªã tr√≠';
      btn.disabled = false;
      btn.className = 'btn-success btn-sm liquid-effect';
    }, 
    { 
      enableHighAccuracy: true, 
      timeout: 15000, 
      maximumAge: 0 
    }
  );
}

// Ch·ªânh s·ª≠a item
function editItem(id) {
  vibrateShort();
  
  const item = allData.find(item => item.id === id);
  if (!item) return;
  
  editingId = id;
  
  // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
  document.getElementById('chon_diem').value = item.ten_diem;
  document.getElementById('ten_diem').value = item.ten_diem;
  document.getElementById('ten_diem').disabled = true;
  document.getElementById('so_tien').value = item.so_tien;
  document.getElementById('dia_chi').value = item.dia_chi;
  document.getElementById('ghi_chu').value = item.ghi_chu || '';
  document.getElementById('trang_thai').value = item.trang_thai || 'Ch∆∞a n·ªôp';
  
  // Thay ƒë·ªïi n√∫t th√†nh c·∫≠p nh·∫≠t
  document.getElementById('btn-submit').textContent = 'üíæ C·∫≠p nh·∫≠t';
  document.getElementById('btn-cancel').style.display = 'block';
  
  // Ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t l∆∞u v·ªã tr√≠
  if (hasExistingGPSLocation(item.ten_diem)) {
    const btn = document.getElementById('btn-save-location');
    btn.textContent = 'üìç ƒê√£ c√≥ v·ªã tr√≠';
    btn.disabled = true;
    btn.className = 'btn-location-disabled btn-sm';
  } else {
    resetSaveLocationButton();
  }
  
  // Cu·ªôn l√™n ƒë·∫ßu form
  document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

// X√≥a item
function deleteItem(id) {
  vibrateShort();
  
  const item = allData.find(item => item.id === id);
  if (!item) return;
  
  itemToDelete = id;
  document.getElementById('delete-item-info').textContent = 
    `${item.ten_diem} - ${formatCurrency(item.so_tien)} - ${item.dia_chi}`;
  
  openModal('delete-modal');
}

// X√°c nh·∫≠n x√≥a
function confirmDelete() {
  vibrateLong();
  
  if (!itemToDelete) return;
  
  const data = { 
    action: 'delete',
    id: itemToDelete
  };

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'success') {
      showToast('‚úÖ ƒê√£ x√≥a th√†nh c√¥ng!');
      vibrateSuccess();
      closeModal('delete-modal');
      taiDuLieu();
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a!', 'error');
      vibrateError();
    }
  })
  .catch(error => {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a!', 'error');
    vibrateError();
    console.error(error);
  });
}

// M·ªü modal
function openModal(modalId) {
  closeSidebar();
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

// ƒê√≥ng modal
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// C·∫≠p nh·∫≠t s·ª± ki·ªán click cho n√∫t l∆∞u v·ªã tr√≠
document.getElementById('btn-save-location').addEventListener('click', saveLocation);

async function guiDuLieu() {
  vibrateShort();
  
  const btnSubmit = document.getElementById('btn-submit');
  if (btnSubmit.disabled) return;

  const ten_diem = document.getElementById('ten_diem').value || document.getElementById('chon_diem').value;
  const so_tien = document.getElementById('so_tien').value;
  const dia_chi = document.getElementById('dia_chi').value;
  const ghi_chu = document.getElementById('ghi_chu').value;
  const trang_thai = document.getElementById('trang_thai').value;

  if (!ten_diem || !so_tien || !dia_chi) {
    showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
    vibrateError();
    return;
  }

  if (!editingId) {
    const shiftInfo = getCurrentShift();
    
    if (!selectedOutOfHoursShift && !shiftInfo.start) {
      showToast('‚ö†Ô∏è Hi·ªán t·∫°i kh√¥ng trong ca l√†m vi·ªác! Vui l√≤ng s·ª≠ d·ª•ng ch·ª©c nƒÉng "Th√™m ƒëi·ªÉm ngo√†i ca" t·ª´ menu.', 'error');
      vibrateError();
      return;
    }
  }

  btnSubmit.textContent = '‚è≥ ƒêang l∆∞u...';
  btnSubmit.disabled = true;

  let shiftToUse = selectedOutOfHoursShift;
  if (!shiftToUse && !editingId) {
    shiftToUse = getCurrentShift().shiftKey;
  }

  const data = { 
    ten_diem, 
    so_tien, 
    dia_chi,
    ghi_chu,
    trang_thai,
    ca: editingId ? undefined : shiftToUse,
    timestamp: editingId ? undefined : new Date().toISOString(),
    id: editingId || undefined
  };

  if (editingId) {
    data.action = 'update';
  }

  try {
    const response = await fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify(data)
    });
    const result = await response.json();
    
    if (result.result === 'success') {
      showToast(editingId ? '‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!' : '‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
      vibrateSuccess();
      resetForm();
      taiDuLieu();
    } else {
      showToast('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!', 'error');
      vibrateError();
    }
  } catch (error) {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!', 'error');
    vibrateError();
    console.error(error);
  } finally {
    btnSubmit.textContent = editingId ? 'üíæ C·∫≠p nh·∫≠t' : 'üíæ L∆∞u th√¥ng tin';
    btnSubmit.disabled = false;
  }
}

async function taiDuLieu() {
  closeSidebar();
  vibrateShort();
  
  try {
    const res = await fetch(scriptURL);
    const data = await res.json();
    allData = data;
    currentFilteredData = data;
    
    // C·∫≠p nh·∫≠t cacheDiem t·ª´ d·ªØ li·ªáu m·ªõi
    updateCacheDiem();
    
    const diemList = document.getElementById('diem-list');
    diemList.innerHTML = '';
    const uniqueDiems = new Set();
    data.forEach(row => {
      const ten = row.ten_diem;
      if (!uniqueDiems.has(ten)) {
        const opt = document.createElement('option');
        opt.value = ten;
        diemList.appendChild(opt);
        uniqueDiems.add(ten);
      }
    });

    displayData(data);
    displayStats(calculateStats(data));
    updateFilters(data);
    
  } catch (error) {
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu!', 'error');
    vibrateError();
    console.error(error);
  }
}

// Th√™m h√†m ƒë·ªÉ x·ª≠ l√Ω ƒë√≥ng modal khi ch·∫°m ra ngo√†i
function setupModalCloseOnOutsideClick() {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal(modal.id);
      }
    });
  });
}

// Hi·ªÉn th·ªã/·∫©n n√∫t cu·ªôn v·ªÅ ƒë·∫ßu trang khi cu·ªôn
window.addEventListener('scroll', function() {
  const btn = document.getElementById('scrollTopBtn');
  if (window.scrollY > 200) {
    btn.style.display = 'flex';
    btn.style.opacity = '1';
  } else {
    btn.style.opacity = '0';
    setTimeout(() => { btn.style.display = 'none'; }, 300);
  }
});

// X·ª≠ l√Ω s·ª± ki·ªán cu·ªôn v·ªÅ ƒë·∫ßu trang
document.getElementById('scrollTopBtn').onclick = function() {
  vibrateShort();
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

// Kh·ªüi t·∫°o
document.addEventListener('DOMContentLoaded', function() {
  // Kh·ªüi t·∫°o √¢m thanh
  initAudio();
  
  updateShiftInfo();
  taiDuLieu().then(() => {
    const shiftInfo = getCurrentShift();
    const shiftFilter = document.getElementById('filter-shift');
    if (shiftInfo.start) {
      shiftFilter.value = shiftInfo.shiftKey;
    } else {
      shiftFilter.value = 'all';
    }
    filterData();
  });
  
  document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
  document.getElementById('close-sidebar').addEventListener('click', closeSidebar);
  document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);
  
  setupModalCloseOnOutsideClick();
  
  // Th√™m s·ª± ki·ªán cho modal chuy·ªÉn tr·∫°ng th√°i ƒë·ªìng lo·∫°t
  document.getElementById('batch-status-shift').addEventListener('change', updateBatchStatusInfo);
  document.getElementById('batch-status-new-status').addEventListener('change', updateBatchStatusInfo);
  
  // Th√™m s·ª± ki·ªán cho modal b√°o c√°o cu·ªëi ca
  document.getElementById('report-shift').addEventListener('change', updateReportSummary);
  document.getElementById('report-recipient').addEventListener('input', updateReportSummary);
  
  // Th√™m s·ª± ki·ªán cho √¥ nh·∫≠p t√™n chi ti√™u (t·ª± ƒë·ªông ƒëi·ªÅn s·ªë ti·ªÅn t·ª´ m·∫´u)
  document.getElementById('expense-name').addEventListener('change', function() {
    vibrateShort();
    const expenseName = this.value.trim();
    if (!expenseName) return;
    
    // T√¨m trong danh s√°ch m·∫´u
    const template = expenseTemplateList.find(t => t.name === expenseName);
    if (template && template.amount > 0) {
      document.getElementById('expense-amount').value = template.amount;
    }
  });
  
  // Th√™m s·ª± ki·ªán cho √¥ nh·∫≠p s·ªë ti·ªÅn chi ti√™u
  document.getElementById('expense-amount').addEventListener('blur', function() {
    let value = this.value.trim();
    if (/^\d+$/.test(value) && value.length > 0 && value.length <= 3) {
      this.value = value + '000';
      vibrateShort();
    }
  });
  
  // Th√™m rung/√¢m thanh cho c√°c n√∫t trong sidebar
  const sidebarItems = document.querySelectorAll('.sidebar-item');
  sidebarItems.forEach(item => {
    item.addEventListener('mousedown', function() {
      vibrateShort();
    });
  });
  
  // Th√™m rung/√¢m thanh cho c√°c n√∫t ch√≠nh trong form
  const mainButtons = document.querySelectorAll('.button-group button, .btn-sm, .btn-primary, .btn-secondary, .btn-success, .btn-warning, .btn-danger');
  mainButtons.forEach(button => {
    button.addEventListener('mousedown', function() {
      vibrateShort();
    });
  });
  
  // Th√™m rung/√¢m thanh cho c√°c n√∫t trong modal
  const modalButtons = document.querySelectorAll('.modal-footer button, .modal-header .close-modal');
  modalButtons.forEach(button => {
    button.addEventListener('mousedown', function() {
      vibrateShort();
    });
  });
  
  // Th√™m rung/√¢m thanh khi ch·ªçn trong select
  const selectElements = document.querySelectorAll('select');
  selectElements.forEach(select => {
    select.addEventListener('change', function() {
      vibrateShort();
    });
  });
  
  // Th√™m hi·ªáu ·ª©ng cho c√°c badge tr·∫°ng th√°i
  const statusBadges = document.querySelectorAll('.status-toggle');
  statusBadges.forEach(badge => {
    badge.addEventListener('mousedown', function() {
      vibrateShort();
    });
  });
  
  setInterval(updateShiftInfo, 60000);
});
</script>
</body>
</html>